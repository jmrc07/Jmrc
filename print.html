<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Monthly Duty Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body { font-family: system-ui, -apple-system, sans-serif; margin:0; background:#f8fafc; padding:10px; }
  .container { max-width:900px; margin:auto; background:white; padding:15px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.08); }
  .header { text-align:center; margin-bottom:20px; }
  .profile-box { background:#eef2ff; border-left:4px solid #2563eb; padding:12px; border-radius:8px; margin-bottom:18px; font-size:14px; }

  select { padding:8px 12px; font-size:15px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:15px; width:100%; }

  /* Filter Chips */
  .filter-chips { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; }
  .chip { padding:6px 12px; background:#e2e8f0; border:none; border-radius:20px; cursor:pointer; font-size:13px; transition: background 0.2s; }
  .chip:hover { opacity: 0.9; }
  .chip.active { background:#2563eb; color:white; }

  /* Action Buttons (Print) */
  .action-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; border-top: 1px dashed #cbd5e1; padding-top: 15px; }
  .btn-print { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; font-size:13px; color:white; font-weight:600; }
  
  .btn-summary { background:#475569; } /* Slate */
  .btn-nda { background:#16a34a; }     /* Green */
  .btn-hda { background:#ea580c; }     /* Orange */
  .btn-ice { background:#7c3aed; }     /* Purple */

  .table-container { width:100%; overflow-x:auto; border-radius:8px; }
  table { width:100%; min-width:950px; border-collapse:collapse; font-size:13px; }
  th { background:#2563eb; color:white; padding:8px 5px; white-space:nowrap; position:sticky; top:0; }
  td { padding:6px 5px; border-bottom:1px solid #e2e8f0; white-space:nowrap; }
  tr:nth-child(even){ background:#f8fafc; }

  .total-box { margin-top:20px; padding:12px; background:#f1f5f9; border-left:4px solid #2563eb; border-radius:8px; font-size:14px; }

  @media print {
    select, .no-print, .filter-chips, .action-row { display:none; }
    body{ background:white; padding:0; }
    .container{ box-shadow:none; border-radius:0; }
  }
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h2 style="margin:0;">Monthly Duty Report</h2>
  </div>

  <div class="profile-box" id="profileBox">Loading profile...</div>

  <div class="filter-chips no-print">
    <button class="chip active" data-filter="ALL">All</button>
    <button class="chip" data-filter="MORNING">Morning</button>
    <button class="chip" data-filter="EVENING">Evening</button>
    <button class="chip" data-filter="NIGHT">Night</button>
    <button class="chip" data-filter="CR">CR</button>
    <button class="chip" data-filter="CL">CL</button>
    <button class="chip" data-filter="GH">GH</button>
    <button class="chip" data-filter="RH">RH</button>
    <button class="chip" data-filter="STN">Station</button>
    <button class="chip" data-filter="TRAIN">Train</button>
  </div>

  <select id="monthSelect"></select>

  <div class="action-row no-print">
    <button class="btn-print btn-summary" id="printSummaryBtn">Print Summary (All)</button>
    <button class="btn-print btn-nda" id="printNDAButton">Print NDA</button>
    <button class="btn-print btn-hda" id="printHDAButton">Print HDA</button>
    <button class="btn-print btn-ice" id="printICEButton">Print ICE</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Duty</th>
          <th>Shift</th>
          <th>Sign On</th>
          <th>Sign Off</th>
          <th>On Place</th>
          <th>Off Place</th>
          <th>Hours</th>
          <th>Night</th>
          <th>Trains</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
  </div>

  <div class="total-box" id="totalBox">Totals will appear here...</div>

</div>

<script>
// Load Data
const raw = localStorage.getItem("dutyTrackerData");
const data = raw ? JSON.parse(raw) : { printData:{ records:{}, profile:{}, pay:{} } };
const printData = data.printData || { records:{}, profile:{}, pay:{} };

// Profile
function renderProfile(){
  const p = printData.profile || {};
  document.getElementById("profileBox").innerHTML = `
    <strong>Name:</strong> ${p.name || "—"}<br>
    <strong>Employee ID:</strong> ${p.empId || "—"}<br>
    <strong>Confirmation Date:</strong> ${p.confirmDate || "—"}
  `;
}

// Month Dropdown
function renderMonthDropdown(){
  const select = document.getElementById("monthSelect");
  select.innerHTML = "";

  const dates = Object.keys(printData.records);
  if(!dates.length) return;

  const months = [...new Set(dates.map(d => d.substring(0,7)))];

  months.sort().forEach(m => {
    const opt=document.createElement("option");
    opt.value=m;
    opt.textContent = new Date(m+"-01").toLocaleDateString("en-IN", { month:"long", year:"numeric" });
    select.appendChild(opt);
  });

  select.value = months[months.length-1];
  loadMonth(select.value);
  select.onchange = () => loadMonth(select.value);
}

// Load Month
function loadMonth(month){
  const body = document.getElementById("reportBody");
  body.innerHTML="";

  const recs = Object.values(printData.records)
    .filter(r => r.date.startsWith(month))
    .sort((a,b)=> a.date.localeCompare(b.date));

  let totalNight = 0;
  let totalHours = 0;

  recs.forEach(r => {
    totalNight += Number(r.nightDutyHours || 0);
    const hrs = (r.dutyHours && r.dutyHours.length >= 2) ? parseInt(r.dutyHours.substring(0,2)) : 0;
    totalHours += hrs;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.date}</td>
      <td>${r.duty}</td>
      <td>${r.shift || "—"}</td>
      <td>${r.signOnTime}</td>
      <td>${r.signOffTime}</td>
      <td>${r.signOnPlace}</td>
      <td>${r.signOffPlace}</td>
      <td>${r.dutyHours}</td>
      <td>${r.nightDutyHours}</td>
      <td>${(r.trains || []).join(", ")}</td>
    `;
    body.appendChild(row);
  });

  document.getElementById("totalBox").innerHTML = `
    <strong>Total Duties:</strong> ${recs.length}<br>
    <strong>Total Duty Hours:</strong> ${totalHours} hrs<br>
    <strong>Total Night Hours:</strong> ${totalNight} hrs
  `;
  
  // Re-apply active filter if any
  const activeBtn = document.querySelector('.chip.active');
  if(activeBtn) applyFilter(activeBtn.dataset.filter);
}

// Filters
const chips = document.querySelectorAll('.chip');
chips.forEach(btn => {
  btn.addEventListener('click', ()=>{
    chips.forEach(c=> c.classList.remove('active'));
    btn.classList.add('active');
    applyFilter(btn.dataset.filter);
  })
});

function applyFilter(type){
  const rows = document.querySelectorAll('#reportBody tr');
  rows.forEach(r => {
    const duty = r.children[1].textContent;      // Col 1: Duty Code
    const shift = r.children[2].textContent;     // Col 2: Shift (M, E, N, —)
    const signOn = r.children[3].textContent;    // Col 3: Sign On (HH:MM)
    const nightHrs = parseFloat(r.children[8].textContent) || 0; // Col 8: Night Hours
    const trains = r.children[9].textContent;    // Col 9: Trains

    let show = true;
    const startHour = parseInt(signOn.split(":")[0]);

    if(type === "ALL") {
      show = true;
    }
    else if(["CR","CL","GH","RH"].includes(type)){
      show = duty === type;
    }
    else if(type === "STN"){
      show = duty.startsWith("STN");
    }
    else if(type === "TRAIN"){
      show = trains.trim() !== "";
    }
    else if(type === "MORNING"){
      show = (shift === "M") || (!isNaN(startHour) && startHour < 12 && !["CR","CL","GH","RH"].includes(duty));
    }
    else if(type === "EVENING"){
      show = (shift === "E") || (!isNaN(startHour) && startHour >= 12 && startHour < 20 && !["CR","CL","GH","RH"].includes(duty));
    }
    else if(type === "NIGHT"){
      show = (shift === "N") || (!isNaN(startHour) && startHour >= 20) || (nightHrs > 0);
    }
    
    r.style.display = show ? "" : "none";
  });
}

// --- PRINT BUTTON EVENT LISTENERS ---

// 1. Print Summary (Current view)
document.getElementById("printSummaryBtn").addEventListener("click", () => {
  window.print();
});

// Helper to save selection and open window
function openReport(filename) {
  const selectedMonth = document.getElementById("monthSelect").value;
  localStorage.setItem("selectedPrintMonth", selectedMonth);
  window.open(filename, "_blank");
}

// 2. Print NDA
document.getElementById("printNDAButton").addEventListener("click", () => {
  openReport("NDAprint.html");
});

// 3. Print HDA
document.getElementById("printHDAButton").addEventListener("click", () => {
  openReport("HDAprint.html");
});

// 4. Print ICE
document.getElementById("printICEButton").addEventListener("click", () => {
  openReport("ICEprint.html");
});

// INIT
renderProfile();
renderMonthDropdown();
</script>

</body>
</html>
