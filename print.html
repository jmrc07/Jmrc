<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Monthly Duty Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body { font-family: system-ui, -apple-system, sans-serif; margin:0; background:#f8fafc; padding:10px; }
  .container { max-width:900px; margin:auto; background:white; padding:15px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.08); }
  .header { text-align:center; margin-bottom:20px; }
  .profile-box { background:#eef2ff; border-left:4px solid #2563eb; padding:12px; border-radius:8px; margin-bottom:18px; font-size:14px; }

  select { padding:8px 12px; font-size:15px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:15px; width:100%; }

  /* Filter Chips */
  .filter-chips { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; }
  .chip { padding:6px 12px; background:#e2e8f0; border:none; border-radius:20px; cursor:pointer; font-size:13px; transition: background 0.2s; }
  .chip:hover { opacity: 0.9; }
  .chip.active { background:#2563eb; color:white; }

  /* Action Buttons (Print) */
  .action-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; border-top: 1px dashed #cbd5e1; padding-top: 15px; }
  .btn-print { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; font-size:13px; color:white; font-weight:600; }
  
  .btn-summary { background:#475569; } /* Slate */
  .btn-nda { background:#16a34a; }     /* Green */
  .btn-hda { background:#ea580c; }     /* Orange */
  .btn-ice { background:#7c3aed; }     /* Purple */

  .table-container { width:100%; overflow-x:auto; border-radius:8px; }
  table { width:100%; min-width:950px; border-collapse:collapse; font-size:13px; }
  th { background:#2563eb; color:white; padding:8px 5px; white-space:nowrap; position:sticky; top:0; }
  td { padding:6px 5px; border-bottom:1px solid #e2e8f0; white-space:nowrap; }
  tr:nth-child(even){ background:#f8fafc; }

  .total-box { margin-top:20px; padding:12px; background:#f1f5f9; border-left:4px solid #2563eb; border-radius:8px; font-size:14px; }

  @media print {
    select, .no-print, .filter-chips, .action-row { display:none; }
    body{ background:white; padding:0; }
    .container{ box-shadow:none; border-radius:0; }
  }
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h2 style="margin:0;">Monthly Duty Report</h2>
  </div>

  <div class="profile-box" id="profileBox">Loading profile...</div>

  <div class="filter-chips no-print">
    <button class="chip active" data-filter="ALL">All</button>
    <button class="chip" data-filter="MORNING">Morning</button>
    <button class="chip" data-filter="EVENING">Evening</button>
    <button class="chip" data-filter="NIGHT">Night</button>
    <button class="chip" data-filter="CR">CR</button>
    <button class="chip" data-filter="CL">CL</button>
    <button class="chip" data-filter="GH">GH</button>
    <button class="chip" data-filter="RH">RH</button>
    <button class="chip" data-filter="STN">Station</button>
    <button class="chip" data-filter="TRAIN">Train</button>
  </div>

  <select id="monthSelect"></select>

  <div class="action-row no-print">
    <button class="btn-print btn-summary" id="printSummaryBtn">Print Summary (All)</button>
    <button class="btn-print btn-nda" id="printNDAButton">Print NDA</button>
    <button class="btn-print btn-hda" id="printHDAButton">Print HDA</button>
    <button class="btn-print btn-ice" id="printICEButton">Print ICE</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Duty</th>
          <th>Shift</th>
          <th>Sign On</th>
          <th>Sign Off</th>
          <th>On Place</th>
          <th>Off Place</th>
          <th>Hours</th>
          <th>Night</th>
          <th>Trains</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
  </div>

  <div class="total-box" id="totalBox">Totals will appear here...</div>

</div>

<script>
// --- CONFIG DATA (COPIED FROM INDEX.HTML FOR CALCULATIONS) ---
const DUTY_TABLE = {
  "1": { signOn:"04:55", onPlace:"MSOR SCR", signOff:"11:55", offPlace:"MSOR SCR", hours:"07:00" },
  "2": { signOn:"04:55", onPlace:"BICP SCR", signOff:"12:25", offPlace:"MSOR SCR", hours:"07:30" },
  "3": { signOn:"04:55", onPlace:"MSOR SCR", signOff:"12:05", offPlace:"MSOR SCR", hours:"07:10" },
  "4": { signOn:"05:05", onPlace:"BICP SCR", signOff:"12:45", offPlace:"MSOR SCR", hours:"07:40" },
  "5": { signOn:"07:15", onPlace:"MSOR SCR", signOff:"14:35", offPlace:"MSOR SCR", hours:"07:20" },
  "6": { signOn:"05:00", onPlace:"DEPOT", signOff:"14:00", offPlace:"MSOR SCR", hours:"09:00" },
  "8": { signOn:"04:30", onPlace:"DEPOT", signOff:"12:15", offPlace:"MSOR SCR", hours:"07:45" },
  "9": { signOn:"04:50", onPlace:"DEPOT", signOff:"12:35", offPlace:"MSOR SCR", hours:"07:45" },
  "10": { signOn:"07:25", onPlace:"MSOR SCR", signOff:"14:55", offPlace:"MSOR SCR", hours:"07:30" },
  "11": { signOn:"07:35", onPlace:"MSOR SCR", signOff:"15:05", offPlace:"MSOR SCR", hours:"07:30" },
  "12": { signOn:"11:35", onPlace:"MSOR SCR", signOff:"18:45", offPlace:"MSOR SCR", hours:"07:10" },
  "15": { signOn:"11:45", onPlace:"MSOR SCR", signOff:"19:05", offPlace:"MSOR SCR", hours:"07:20" },
  "16": { signOn:"12:25", onPlace:"MSOR SCR", signOff:"20:35", offPlace:"MSOR SCR", hours:"08:10" },
  "17": { signOn:"12:55", onPlace:"MSOR SCR", signOff:"20:45", offPlace:"MSOR SCR", hours:"07:50" },
  "18": { signOn:"13:05", onPlace:"MSOR SCR", signOff:"20:55", offPlace:"MSOR SCR", hours:"07:50" },
  "19": { signOn:"14:35", onPlace:"MSOR SCR", signOff:"22:48", offPlace:"BICP SCR", hours:"08:13" },
  "20": { signOn:"14:45", onPlace:"MSOR SCR", signOff:"22:54", offPlace:"MSOR SCR", hours:"08:09" },
  "22": { signOn:"15:25", onPlace:"MSOR SCR", signOff:"23:10", offPlace:"DEPOT", hours:"07:45" },
  "23": { signOn:"15:05", onPlace:"MSOR SCR", signOff:"23:10", offPlace:"MSOR SCR", hours:"08:05" },
  "24": { signOn:"15:55", onPlace:"MSOR SCR", signOff:"23:05", offPlace:"BICP SCR", hours:"07:10" },
  "25": { signOn:"16:05", onPlace:"MSOR SCR", signOff:"23:20", offPlace:"DEPOT", hours:"07:15" },
  "26": { signOn:"14:00", onPlace:"MSOR SCR", signOff:"23:00", offPlace:"DEPOT", hours:"09:00" },
  "26A": { signOn:"16:00", onPlace:"MSOR SCR", signOff:"01:00", offPlace:"DEPOT", hours:"09:00" },
  "TO Night": { signOn:"22:00", onPlace:"MSOR SCR", signOff:"06:00", offPlace:"DEPOT", hours:"08:00" },
  "TRAINING":{signOn:"09:00",onPlace:"Training",signOff:"17:00",offPlace:"Training",hours:"08:00"},
  "GENERAL":{signOn:"09:30",onPlace:"Office",signOff:"17:30",offPlace:"Office",hours:"08:00"},
  "DCC-M":{signOn:"06:00",onPlace:"DCC",signOff:"14:00",offPlace:"DCC",hours:"08:00"},
  "DCC-E":{signOn:"14:00",onPlace:"DCC",signOff:"22:00",offPlace:"DCC",hours:"08:00"},
  "DCC-N":{signOn:"22:00",onPlace:"DCC",signOff:"06:00",offPlace:"DCC",hours:"08:00"},
  "OCC-M":{signOn:"06:00",onPlace:"OCC",signOff:"14:00",offPlace:"OCC",hours:"08:00"},
  "OCC-E":{signOn:"14:00",onPlace:"OCC",signOff:"22:00",offPlace:"OCC",hours:"08:00"},
  "OCC-N":{signOn:"22:00",onPlace:"OCC",signOff:"06:00",offPlace:"OCC",hours:"08:00"},
  "STN-M":{signOn:"06:00",onPlace:"STATION",signOff:"14:00",offPlace:"STATION",hours:"08:00"},
  "STN-E":{signOn:"14:00",onPlace:"STATION",signOff:"22:00",offPlace:"STATION",hours:"08:00"},
  "STN-N":{signOn:"22:00",onPlace:"STATION",signOff:"06:00",offPlace:"STATION",hours:"08:00"}
};

// --- HELPER FUNCTIONS ---
function parseTimeHour(t){ return (t && t.length===5) ? parseInt(t.substring(0,2),10) : -1; }
function computeNightHours(code, so, sf){
  if(!code) return 0;
  if(code === "26A") return 3;
  if(code === "TO Night") return 8;
  if(String(code).endsWith("-N")) return 8;
  if(String(code).endsWith("-M") || String(code).endsWith("-E")) return 0;
  // Standard Duty Logic
  const h1 = parseTimeHour(so), h2 = parseTimeHour(sf);
  if((h1!==-1 && h1<6) || (h2!==-1 && h2>=22)) return 1;
  return 0;
}
function parseDutyHours(str){
    if(!str) return 0;
    const parts = str.split(":");
    return parts.length > 0 ? parseInt(parts[0]) : 0;
}

// Load Data
const raw = localStorage.getItem("dutyTrackerData");
const data = raw ? JSON.parse(raw) : { records:{}, profile:{}, pay:{} };
const rawRecords = data.records || {};
const printData = data.printData || {}; // We use this only for Profile info

// Profile
function renderProfile(){
  const p = printData.profile || data.profile || {};
  document.getElementById("profileBox").innerHTML = `
    <strong>Name:</strong> ${p.name || "—"}<br>
    <strong>Employee ID:</strong> ${p.empId || "—"}<br>
    <strong>Confirmation Date:</strong> ${p.confirmDate || "—"}
  `;
}

// Month Dropdown
function renderMonthDropdown(){
  const select = document.getElementById("monthSelect");
  select.innerHTML = "";
  const dates = Object.keys(rawRecords);
  if(!dates.length) return;
  const months = [...new Set(dates.map(d => d.substring(0,7)))];
  months.sort().forEach(m => {
    const opt=document.createElement("option"); opt.value=m;
    opt.textContent = new Date(m+"-01").toLocaleDateString("en-IN", { month:"long", year:"numeric" });
    select.appendChild(opt);
  });
  select.value = months[months.length-1];
  loadMonth(select.value);
  select.onchange = () => loadMonth(select.value);
}

// --- MAIN LOGIC ---
function loadMonth(month){
  const body = document.getElementById("reportBody");
  body.innerHTML="";

  // Get Dates for selected month
  const dates = Object.keys(rawRecords)
    .filter(d => d.startsWith(month))
    .sort();

  let totalNight = 0;
  let totalHours = 0;
  let totalRows = 0;

  dates.forEach(date => {
    // rawRecords[date] is now ALWAYS an array in your new index.html
    const entries = Array.isArray(rawRecords[date]) ? rawRecords[date] : [rawRecords[date]];

    entries.forEach(entry => {
        totalRows++;

        // 1. Get Reference Data from Table
        const dInfo = DUTY_TABLE[entry.duty] || {};
        
        // 2. Handle Places (Replace STATION placeholder if needed)
        let sOnP = dInfo.onPlace || entry.signOnPlace || "—";
        let sOffP = dInfo.offPlace || entry.signOffPlace || "—";
        if(entry.station) {
            sOnP = sOnP.replace("STATION", entry.station);
            sOffP = sOffP.replace("STATION", entry.station);
        }

        // 3. Calculate Stats
        const nightHrs = computeNightHours(entry.duty, dInfo.signOn, dInfo.signOff);
        const hrsNum = parseDutyHours(dInfo.hours);

        // Accumulate
        totalNight += nightHrs;
        totalHours += hrsNum;

        // 4. Create Row
        const row = document.createElement("tr");
        
        // Determine Shift Label
        let shiftLabel = "—";
        if(entry.duty.includes("-M") || (dInfo.signOn && parseInt(dInfo.signOn)<12)) shiftLabel="M";
        else if(entry.duty.includes("-E") || (dInfo.signOn && parseInt(dInfo.signOn)>=12 && parseInt(dInfo.signOn)<20)) shiftLabel="E";
        else if(entry.duty.includes("-N") || entry.duty==="TO Night") shiftLabel="N";

        row.innerHTML = `
          <td>${date}</td>
          <td>${entry.duty}</td>
          <td>${shiftLabel}</td>
          <td>${dInfo.signOn || "—"}</td>
          <td>${dInfo.signOff || "—"}</td>
          <td>${sOnP}</td>
          <td>${sOffP}</td>
          <td>${dInfo.hours || "0"}</td>
          <td>${nightHrs}</td>
          <td>${(entry.trains || []).join(", ")}</td>
        `;
        body.appendChild(row);
    });
  });

  document.getElementById("totalBox").innerHTML = `
    <strong>Total Duties:</strong> ${totalRows}<br>
    <strong>Total Duty Hours:</strong> ${totalHours} hrs<br>
    <strong>Total Night Hours:</strong> ${totalNight} hrs
  `;
  
  const activeBtn = document.querySelector('.chip.active');
  if(activeBtn) applyFilter(activeBtn.dataset.filter);
}

// Filters
const chips = document.querySelectorAll('.chip');
chips.forEach(btn => {
  btn.addEventListener('click', ()=>{
    chips.forEach(c=> c.classList.remove('active'));
    btn.classList.add('active');
    applyFilter(btn.dataset.filter);
  })
});

function applyFilter(type){
  const rows = document.querySelectorAll('#reportBody tr');
  rows.forEach(r => {
    const duty = r.children[1].textContent;      
    const shift = r.children[2].textContent;     
    const signOn = r.children[3].textContent;    
    const nightHrs = parseFloat(r.children[8].textContent) || 0; 
    const trains = r.children[9].textContent;    

    let show = true;
    const startHour = parseInt(signOn.split(":")[0]);

    if(type === "ALL") show = true;
    else if(["CR","CL","GH","RH"].includes(type)) show = duty === type;
    else if(type === "STN") show = duty.startsWith("STN");
    else if(type === "TRAIN") show = trains.trim() !== "";
    else if(type === "MORNING") show = (shift === "M");
    else if(type === "EVENING") show = (shift === "E");
    else if(type === "NIGHT") show = (shift === "N") || (nightHrs > 0);
    
    r.style.display = show ? "" : "none";
  });
}

// --- PRINT BUTTON EVENT LISTENERS ---
document.getElementById("printSummaryBtn").addEventListener("click", () => {
  window.print();
});

function openReport(filename) {
  const selectedMonth = document.getElementById("monthSelect").value;
  localStorage.setItem("selectedPrintMonth", selectedMonth);
  window.open(filename, "_blank");
}

document.getElementById("printNDAButton").addEventListener("click", () => { openReport("NDAprint.html"); });
document.getElementById("printHDAButton").addEventListener("click", () => { openReport("HDAprint.html"); });
document.getElementById("printICEButton").addEventListener("click", () => { openReport("ICEprint.html"); });

// INIT
renderProfile();
renderMonthDropdown();
</script>

</body>
</html>
