<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Night Duty Allowance Claim Form</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
/* CENTRE FIT & NO OVERLAP STYLES */
@page { size: A4 portrait; margin: 10mm 20mm; }
html, body { margin: 0; padding: 0; background: #fff; }

body {
    width: 100%;
    font-family: "Times New Roman", serif;
    color: #000;
}

.page { 
    width: 100%; 
    margin: 0 auto; /* Ensures horizontal centering */
}

/* Header */
.logo { text-align:center; margin-bottom:2px; }
.logo img { width:60px; height:auto; }
h1 { text-align:center; font-size:16px; margin:2px 0; font-weight: bold; text-transform: uppercase; }
.sub { text-align:center; font-size:11px; margin-bottom: 5px; }

/* Tables */
table { 
    border-collapse:collapse; 
    width:100%; 
    table-layout:fixed; 
    margin: 5px auto; /* Centers the table */
}
th, td { 
    border:1px solid #000; 
    padding: 3px 1px; 
    font-size:11px; 
    text-align:center; 
    vertical-align: middle; 
    word-wrap: break-word; 
}

/* --- FIXED META COLUMNS (Prevents Overlap) --- */
.meta th { font-weight: bold; background: #f0f0f0; font-size: 10px; }
.meta td { font-size: 11px; }

/* Sum = 100% */
.meta th:nth-child(1), .meta td:nth-child(1) { width: 18%; } /* Name */
.meta th:nth-child(2), .meta td:nth-child(2) { width: 10%; } /* Emp ID */
.meta th:nth-child(3), .meta td:nth-child(3) { width: 14%; } /* Designation */
.meta th:nth-child(4), .meta td:nth-child(4) { width: 14%; } /* Confirm Date */
.meta th:nth-child(5), .meta td:nth-child(5) { width: 12%; } /* Month */
.meta th:nth-child(6), .meta td:nth-child(6) { width: 32%; } /* Pay (Wide) */

.duty th { font-weight:bold; background: #f0f0f0; }

/* Certificate Section */
.cert-title { text-align:center; font-weight:bold; text-decoration:underline; font-size:12px; margin-top:10px; margin-bottom: 2px; }
.cert-intro { font-size:11px; margin-top:2px; text-align: justify; }

.sig-employee { float:right; width:40%; text-align:center; font-size:11px; margin-top:15px; font-weight:bold; }
.cert-points { clear:both; margin-top:5px; font-size:11px; line-height:1.2; text-align: justify; }

/* Footer/Signatures */
.manager-row { margin-top:10px; font-size:11px; overflow: hidden; padding-top:5px; }
.manager-left { float:left; width:48%; text-align: left; }
.manager-right { float:right; width:48%; text-align:right; }

.footer-row { margin-top: 8px; font-size: 11px; clear:both; text-align: left; }
.total-row td { font-weight:bold; border-top: 2px solid #000; background-color: #fafafa; }
</style>
</head>

<body>
<div class="page">
  <div class="logo"><img src="jaipur_logo.png" alt="JMRC Logo"></div>
  <h1>Night Duty Allowance Claim Form</h1>
  <div class="sub">(As per Rule 9.2 (f) of JMRC Recruitment Rules) 2012<br>(To be submitted in Duplicate)</div>

  <table class="meta">
    <tr>
      <th>Name of Employee</th>
      <th>Emp. ID</th>
      <th>Designation & Deptt.</th>
      <th>Date of Confirmation</th>
      <th>Month :-</th>
      <th>Pay of One day (Basic+DA)</th>
    </tr>
    <tr>
      <td id="empName"></td>
      <td id="empId"></td>
      <td>SC/TO</td>
      <td id="confirmDate"></td>
      <td id="month"></td>
      <td id="payOneDay"></td>
    </tr>
  </table>

  <table class="duty">
    <thead>
      <tr><th style="width:8%">S.No.</th><th style="width:16%">Date</th><th style="width:12%">Sign On Time</th><th style="width:12%">Sign Off Time</th><th style="width:12%">Night Duty Hours<br>(2200 to 0600)</th><th>Duty Place/Station</th><th>Remarks</th></tr>
    </thead>
    <tbody id="dutyBody"></tbody>
    <tfoot id="ndaFooter"></tfoot>
  </table>

  <div class="cert-title">Certificate</div>
  <div class="cert-intro">It is certify that the Night Duty Allowance, as claimed above is correct &amp; due to me, and this claim has not been submitted earlier.</div>
  
  <div style="width:100%; overflow:hidden; margin-bottom:5px;">
      <div class="sig-employee"><b>Signature of the employee</b></div>
  </div>

  <div class="cert-points">
    <p>1. As per sign on and sign off duty record of the employee Mr./Mrs. <span id="certName" style="font-weight:bold;"></span><br>SC/TO, Deptt.–OPERATIONS, Duty Place................... the above detail submitted for the Night Duty Allowance is certified and due to the above employee.</p>
    <p style="margin-top:2px;">2. Total Night Duty Allowance payable to him / her is Rs. <b id="totalNDA"></b>/-</p>
  </div>

  <div class="manager-row">
    <div class="manager-left"><b>Sanctioned (As per clause E18 of SOP, JMRC) by:</b></div>
    <div class="manager-right"><b>Name & Signature of Concerned Manager</b></div>
  </div>
  
  <div class="footer-row"><b>Concerned ED/General Manager (Sign & Seal):</b></div>
  <div class="footer-row"><b>Forward to:</b> GM(Finance), JMRC for making payment</div>
</div>

<script>
// DUTY TABLE CONFIG (Includes 26A & TO Night)
const DUTY_TABLE={
  "1":{signOn:"04:55",onPlace:"MSOR SCR",signOff:"11:55",offPlace:"MSOR SCR",hours:"07:00"},
  "2":{signOn:"04:55",onPlace:"BICP SCR",signOff:"12:25",offPlace:"MSOR SCR",hours:"07:30"},
  "3":{signOn:"04:55",onPlace:"MSOR SCR",signOff:"12:05",offPlace:"MSOR SCR",hours:"07:10"},
  "4":{signOn:"05:05",onPlace:"BICP SCR",signOff:"12:45",offPlace:"MSOR SCR",hours:"07:40"},
  "5":{signOn:"07:15",onPlace:"MSOR SCR",signOff:"14:35",offPlace:"MSOR SCR",hours:"07:20"},
  "6":{signOn:"05:00",onPlace:"DEPOT",signOff:"14:00",offPlace:"MSOR SCR",hours:"09:00"},
  "8":{signOn:"04:30",onPlace:"DEPOT",signOff:"12:15",offPlace:"MSOR SCR",hours:"07:45"},
  "9":{signOn:"04:50",onPlace:"DEPOT",signOff:"12:35",offPlace:"MSOR SCR",hours:"07:45"},
  "10":{signOn:"07:25",onPlace:"MSOR SCR",signOff:"14:55",offPlace:"MSOR SCR",hours:"07:30"},
  "11":{signOn:"07:35",onPlace:"MSOR SCR",signOff:"15:05",offPlace:"MSOR SCR",hours:"07:30"},
  "12":{signOn:"11:35",onPlace:"MSOR SCR",signOff:"18:45",offPlace:"MSOR SCR",hours:"07:10"},
  "15":{signOn:"11:45",onPlace:"MSOR SCR",signOff:"19:05",offPlace:"MSOR SCR",hours:"07:20"},
  "16":{signOn:"12:25",onPlace:"MSOR SCR",signOff:"20:35",offPlace:"MSOR SCR",hours:"08:10"},
  "17":{signOn:"12:55",onPlace:"MSOR SCR",signOff:"20:45",offPlace:"MSOR SCR",hours:"07:50"},
  "18":{signOn:"13:05",onPlace:"MSOR SCR",signOff:"20:55",offPlace:"MSOR SCR",hours:"07:50"},
  "19":{signOn:"14:35",onPlace:"MSOR SCR",signOff:"22:48",offPlace:"BICP SCR",hours:"08:13"},
  "20":{signOn:"14:45",onPlace:"MSOR SCR",signOff:"22:54",offPlace:"MSOR SCR",hours:"08:09"},
  "22":{signOn:"15:25",onPlace:"MSOR SCR",signOff:"23:10",offPlace:"DEPOT",hours:"07:45"},
  "23":{signOn:"15:05",onPlace:"MSOR SCR",signOff:"23:10",offPlace:"MSOR SCR",hours:"08:05"},
  "24":{signOn:"15:55",onPlace:"MSOR SCR",signOff:"23:05",offPlace:"BICP SCR",hours:"07:10"},
  "25":{signOn:"16:05",onPlace:"MSOR SCR",signOff:"23:20",offPlace:"DEPOT",hours:"07:15"},
  "26":{signOn:"14:00",onPlace:"MSOR SCR",signOff:"23:00",offPlace:"DEPOT",hours:"09:00"},
  "26A":{signOn:"16:00",onPlace:"MSOR SCR",signOff:"01:00",offPlace:"DEPOT",hours:"09:00"},
  "TO Night":{signOn:"22:00",onPlace:"MSOR SCR",signOff:"06:00",offPlace:"DEPOT",hours:"08:00"},
  "DCC-N":{signOn:"22:00",onPlace:"DCC",signOff:"06:00",offPlace:"DCC",hours:"08:00"},
  "OCC-N":{signOn:"22:00",onPlace:"OCC",signOff:"06:00",offPlace:"OCC",hours:"08:00"},
  "STN-N":{signOn:"22:00",onPlace:"STATION",signOff:"06:00",offPlace:"STATION",hours:"08:00"}
};

// NIGHT HOUR CALCULATION
function parseTimeHour(t){ return (t && t.length===5) ? parseInt(t.substring(0,2),10) : -1; }
function computeNightHours(code, so, sf){
  if(!code) return 0;
  const cStr = String(code);
  if(cStr === "26A") return 3;
  if(cStr === "TO Night" || cStr.endsWith("-N")) return 8;
  
  const h1 = parseTimeHour(so), h2 = parseTimeHour(sf);
  if((h1 !== -1 && h1 < 6) || (h2 !== -1 && h2 >= 22)) return 1;
  return 0;
}

(function(){
  let raw = localStorage.getItem("dutyTrackerData");
  let data = raw ? JSON.parse(raw) : {};
  let records = data.records || {}; 
  let profile = data.profile || {};
  let payData = data.pay || {};

  let selectedMonth = localStorage.getItem("selectedPrintMonth") || "";
  let monthKey = selectedMonth.slice(-2);

  document.getElementById("empName").textContent = profile.name || "";
  document.getElementById("empId").textContent = profile.empId || "";
  document.getElementById("confirmDate").textContent = profile.confirmDate || "";
  document.getElementById("month").textContent = selectedMonth;
  document.getElementById("certName").textContent = profile.name || "";

  let oneDayPay = payData[monthKey] ? Number(payData[monthKey]) : 0;
  document.getElementById("payOneDay").textContent = oneDayPay.toFixed(2);

  let dates = Object.keys(records).filter(d => d.startsWith(selectedMonth)).sort();
  const tbody = document.getElementById("dutyBody");
  let totalHours = 0;
  let sNo = 0;

  dates.forEach(date => {
      const entries = Array.isArray(records[date]) ? records[date] : [records[date]];
      entries.forEach(r => {
          const dStr = String(r.duty);
          const info = DUTY_TABLE[dStr] || {};
          let nh = computeNightHours(dStr, info.signOn, info.signOff);
          
          if(nh > 0){
              sNo++;
              totalHours += nh;
              let place = info.onPlace || r.signOnPlace || "";
              if(r.station) place = place.replace("STATION", r.station);

              // Use info times if available (for 26A/TO Night), otherwise fallback to record times
              let sOn = info.signOn || r.signOnTime || "";
              let sOff = info.signOff || r.signOffTime || "";

              let tr = document.createElement("tr");
              tr.innerHTML = `<td>${sNo}</td><td>${new Date(date).toLocaleDateString("en-IN", {day:"numeric", month:"short", year:"numeric"})}</td><td>${sOn}</td><td>${sOff}</td><td>${nh}</td><td>${place}</td><td></td>`;
              tbody.appendChild(tr);
          }
      });
  });

  let eq = totalHours / 24;
  let nda = eq * oneDayPay;

  document.getElementById("ndaFooter").innerHTML = `
    <tr class="total-row"><td>(A)</td><td colspan="5" style="text-align:left;">TOTAL Night Hours</td><td>${totalHours}</td></tr>
    <tr class="total-row"><td>(B)</td><td colspan="5" style="text-align:left;">Equivalent Night Duty Day = A/24</td><td>${eq.toFixed(2)}</td></tr>
    <tr class="total-row"><td>(C)</td><td colspan="5" style="text-align:left;">NDA Claimed (Rs.) = B × One Day Pay</td><td>${nda.toFixed(2)}</td></tr>
  `;
  document.getElementById("totalNDA").textContent = nda.toFixed(2);
  window.onload = () => setTimeout(()=>window.print(), 500);
})();
</script>
</body>
</html>
