<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hard Duty Allowance Bill</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* 1. PAGE SETUP: Standard A4 with user-defined margins */
@page { size: A4 portrait; margin: 10mm 20mm; }
html, body { margin: 0; padding: 0; background: #fff; }

body { 
    width: 100%; 
    font-family: "Times New Roman", serif; 
    line-height: 1.1; /* Tighter line height for the whole document */
}

.page { width: 100%; margin: 0 auto; }

/* 2. RESET DEFAULT BROWSER MARGINS (Crucial for single page) */
h1, h2, h3, p, div { margin: 0; padding: 0; }

/* 3. HEADER */
.logo { text-align:center; margin-bottom: 2px; }
.logo img { width: 60px; height: auto; }
h1 { text-align:center; font-size: 16px; margin: 2px 0; text-transform: uppercase; font-weight:bold; }
.sub { text-align:center; font-size: 11px; margin-bottom: 5px; }

/* 4. TABLES */
table { 
    border-collapse: collapse; 
    width: 100%; 
    table-layout: fixed; 
    margin: 2px auto; 
}
th, td { 
    border: 1px solid #000; 
    padding: 2px 1px; /* Minimal padding */
    font-size: 11px;  
    text-align: center; 
}

/* Meta Table Columns */
.meta th { font-weight:bold; background: #f0f0f0; }
.meta th:nth-child(1) { width: 35%; }
.meta th:nth-child(2) { width: 15%; }
.meta th:nth-child(3) { width: 25%; }
.meta th:nth-child(4) { width: 25%; }

/* Duty Table */
.duty th { font-weight:bold; background: #f0f0f0; }
.total-row td { font-weight: bold; border-top: 2px solid #000; font-size: 12px; }

/* 5. CERTIFICATE SECTION (Highly Compressed) */
.cert-section { margin-top: 5px; font-size: 11px; text-align: justify; }
.cert-title { text-align:center; font-weight:bold; text-decoration:underline; font-size: 12px; margin-bottom: 2px; }

/* Paragraph spacing within certificate */
.cert-section p { margin-bottom: 3px; }

/* Signature Rows - Float Layout */
.to-sig-row { 
    margin-top: 15px; /* Space for TO Signature */
    overflow: hidden; 
    margin-bottom: 5px;
}
.to-sig-box { float: right; width: 220px; text-align: center; font-weight: bold; }

.manager-row { 
    margin-top: 10px; 
    overflow: hidden; 
    padding-top: 5px;
}
.sanction-block { float: left; width: 50%; text-align: left; }
.manager-to-block { float: right; width: 40%; text-align: center; margin-top: 15px; }

.footer-note { margin-top: 5px; font-weight: bold; font-size: 11px; clear: both; border-top: 1px dashed #ccc; padding-top: 2px;}
</style>
</head>
<body>
<div class="page">
  <div class="logo"><img src="jaipur_logo.png" alt="JMRC Logo"></div>
  <h1>Hard Duty Allowance Bill</h1>
  <div class="sub">As per Rule 9.2 (e) of JMRC Recruitment Rules, 2012<br>(To be submitted in duplicate...)</div>

  <table class="meta">
    <tr><th>Name of Train Operator</th><th>Emp. ID</th><th>Date of Confirmation</th><th>Month :-</th></tr>
    <tr><td id="empName"></td><td id="empId"></td><td id="confirmDate"></td><td id="monthDisplay"></td></tr>
  </table>

  <table class="duty">
    <thead>
      <tr>
        <th style="width:6%">S. No.</th><th style="width:14%">Date</th><th style="width:14%">Train Set No.</th>
        <th style="width:12%">Sign On Time</th><th style="width:12%">Sign Off Time</th>
        <th style="width:12%">Duty Hours</th><th style="width:12%">Approx. Kms</th><th>Remark</th>
      </tr>
    </thead>
    <tbody id="hdaBody"></tbody>
    <tfoot id="hdaFooter"></tfoot>
  </table>

  <div class="cert-section">
    <div class="cert-title">Certificate</div>
    
    <p>1. I, certify that the hard duty allowance, as claimed in this bill is correct & due to me, and this claim was not submitted earlier.</p>
    
    <div class="to-sig-row">
        <div class="to-sig-box">Signature of Train Operator</div>
    </div>
    
    <p>2. As per sign on and sign off duty record at Crew Control/Duty register at MSOR/CDPE/BICP stations, etc., the above details submitted for the hard duty allowance by the TO is certified & due to him/her.</p>
    
    <p style="font-weight:bold; margin-top:4px;">Total Hard Duty Allowance payable to the TO for <span id="totalDutiesCert" style="text-decoration:underline;"></span> SIGN ON is Rs. <span id="totalAmountCert" style="text-decoration:underline;"></span>/-</p>

    <div class="manager-row">
      <div class="sanction-block">
          <div style="font-weight:bold; margin-bottom:20px;">Sanctioned (As per clause E18 of SOP, JMRC) by:</div>
          <div style="font-weight:bold;">General Manager/Operations (Sign & Seal)</div>
      </div>
      <div class="manager-to-block">
          <div style="font-weight:bold;">Signature of Manager (TO)</div>
      </div>
    </div>
    <div class="footer-note">Forward to: GM(Finance) JMRC for making payment</div>
  </div>
</div>

<script>
const DUTY_TABLE={
  "1":{signOn:"04:55",signOff:"11:55",hours:"07:00"},"2":{signOn:"04:55",signOff:"12:25",hours:"07:30"},
  "3":{signOn:"04:55",signOff:"12:05",hours:"07:10"},"4":{signOn:"05:05",signOff:"12:45",hours:"07:40"},
  "5":{signOn:"07:15",signOff:"14:35",hours:"07:20"},"6":{signOn:"05:00",signOff:"14:00",hours:"09:00"},
  "8":{signOn:"04:30",signOff:"12:15",hours:"07:45"},"9":{signOn:"04:50",signOff:"12:35",hours:"07:45"},
  "10":{signOn:"07:25",signOff:"14:55",hours:"07:30"},"11":{signOn:"07:35",signOff:"15:05",hours:"07:30"},
  "12":{signOn:"11:35",signOff:"18:45",hours:"07:10"},"15":{signOn:"11:45",signOff:"19:05",hours:"07:20"},
  "16":{signOn:"12:25",signOff:"20:35",hours:"08:10"},"17":{signOn:"12:55",signOff:"20:45",hours:"07:50"},
  "18":{signOn:"13:05",signOff:"20:55",hours:"07:50"},"19":{signOn:"14:35",signOff:"22:48",hours:"08:13"},
  "20":{signOn:"14:45",signOff:"22:54",hours:"08:09"},"22":{signOn:"15:25",signOff:"23:10",hours:"07:45"},
  "23":{signOn:"15:05",signOff:"23:10",hours:"08:05"},"24":{signOn:"15:55",signOff:"23:05",hours:"07:10"},
  "25":{signOn:"16:05",signOff:"23:20",hours:"07:15"},"26":{signOn:"14:00",signOff:"23:00",hours:"09:00"},
  "26A":{signOn:"16:00",signOff:"01:00",hours:"09:00"},"TO Night":{signOn:"22:00",signOff:"06:00",hours:"08:00"}
};

(function(){
  const raw = localStorage.getItem("dutyTrackerData");
  const data = raw ? JSON.parse(raw) : {};
  const records = data.records || {};
  const profile = data.profile || {};
  
  document.getElementById("empName").textContent = profile.name || "";
  document.getElementById("empId").textContent = profile.empId || "";
  document.getElementById("confirmDate").textContent = profile.confirmDate || "";

  const selectedMonth = localStorage.getItem("selectedPrintMonth");
  if(selectedMonth){
    const d = new Date(selectedMonth + "-01");
    document.getElementById("monthDisplay").textContent = d.toLocaleDateString("en-IN", { month:"long", year:"numeric" });
  }

  const tbody = document.getElementById("hdaBody");
  const dates = Object.keys(records).filter(d => d.startsWith(selectedMonth)).sort();
  let count = 0;

  dates.forEach(date => {
    const entries = Array.isArray(records[date]) ? records[date] : [records[date]];
    entries.forEach(r => {
        const dStr = String(r.duty);
        const dNum = parseInt(dStr);
        if((!isNaN(dNum) && dNum >= 1 && dNum <= 26) || (dStr === "26A" || dStr === "TO Night")){
            count++;
            const info = DUTY_TABLE[dStr] || {};
            const row = document.createElement("tr");
            
            // DATE FORMAT: 5/10/25
            let dObj = new Date(date);
            let dateStr = `${dObj.getDate()}/${dObj.getMonth()+1}/${String(dObj.getFullYear()).slice(-2)}`;

            row.innerHTML = `<td>${count}</td><td>${dateStr}</td><td>${(r.trains || []).join(", ")}</td><td>${info.signOn || r.signOnTime || ""}</td><td>${info.signOff || r.signOffTime || ""}</td><td>${info.hours || r.dutyHours || ""}</td><td>115</td><td></td>`;
            tbody.appendChild(row);
        }
    });
  });

  const totalAmount = count * 100;
  document.getElementById("hdaFooter").innerHTML = `<tr class="total-row"><td colspan="7" style="text-align:right;">Total Claimed Amount (Rs. 100 x ${count}) = </td><td style="text-align:center;">Rs. ${totalAmount}/-</td></tr>`;
  document.getElementById("totalDutiesCert").textContent = count;
  document.getElementById("totalAmountCert").textContent = totalAmount;

  window.onload = () => setTimeout(()=>window.print(), 500);
})();
</script>
</body>
</html>
