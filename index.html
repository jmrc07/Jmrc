<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Duty Tracker v2.4 ‚Äì Final Calculations Fix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root{--bg:#f8fafc;--primary:#2563eb;--primary-dark:#1d4ed8;--surface:#ffffff;--surface-alt:#eef2ff;--border:#e2e8f0;--border-strong:#cbd5e1;--text-primary:#0f172a;--text-muted:#64748b;--special-bg:#ede9fe;--special-bg-active:#ddd6fe;--special-text:#4c1d95;--rest-bg:#e5e7eb;--rest-text:#374151}*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",sans-serif;background:var(--bg);color:var(--text-primary)}.app-container{max-width:720px;margin:0 auto;padding:.75rem .75rem 5.5rem}.screen{display:none}.screen.active{display:block}.profile-card{position:relative;margin-top:.75rem;padding:1.1rem 1.1rem .9rem;border-radius:1.25rem;background:linear-gradient(135deg,#1d4ed8 0%,#2563eb 40%,#3b82f6 100%);box-shadow:0 16px 40px rgba(37,99,235,.5);color:#eff6ff;overflow:hidden}.profile-card::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at top right,rgba(255,255,255,.25),transparent 55%);pointer-events:none}.profile-header{position:relative;display:flex;align-items:center;justify-content:space-between;z-index:1}.profile-left{display:flex;align-items:center;gap:.65rem}.profile-avatar{width:46px;height:46px;border-radius:999px;background:rgba(15,23,42,.15);border:1px solid rgba(191,219,254,.6);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;color:#eff6ff;background-size:cover;background-position:center}.profile-title{margin:0;font-size:1.35rem;font-weight:700}.profile-sub{margin:0;font-size:.8rem;opacity:.9}.profile-datetime{font-size:.8rem;font-weight:500;text-align:right}.profile-footer{position:relative;margin-top:.7rem;font-size:.8rem;display:flex;justify-content:space-between;gap:.35rem;z-index:1}.profile-footer span{white-space:nowrap}#profileExtraWrapper{margin-top:.35rem}#profileMoreBtn{padding:.2rem .6rem;border-radius:999px;border:1px solid rgba(191,219,254,.7);background:rgba(15,23,42,.12);color:#e5edff;font-size:.75rem;cursor:pointer}#profileExtra{margin-top:.25rem;font-size:.78rem;line-height:1.3}.card{margin-top:1rem;padding:.9rem;background:var(--surface);border-radius:1rem;border:1px solid var(--border);box-shadow:0 4px 10px rgba(15,23,42,.06)}.card-title-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem}.card-title{font-size:.98rem;font-weight:600}.card-sub{font-size:.78rem;color:var(--text-muted)}.home-month-row{display:flex;justify-content:space-between;align-items:center;margin-top:.7rem;padding:0 .1rem}.home-month-hint{font-size:.78rem;color:var(--text-muted)}.home-month-select{font-size:.78rem;padding:.15rem .4rem;border-radius:.6rem;border:1px solid var(--border-strong);background:#fff}.timeline-row{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;max-height:420px;overflow-y:auto;padding-right:4px}.timeline-chip{position:relative;flex-shrink:0;width:100%;padding:.6rem .75rem;border-radius:.9rem;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.8rem;display:flex;flex-direction:column;gap:.15rem;cursor:pointer;transition:box-shadow .12s ease;-webkit-tap-highlight-color:transparent}.timeline-chip-top{font-size:.8rem;font-weight:600;display:flex;justify-content:space-between;align-items:center}.timeline-chip-bottom{font-size:.76rem;color:var(--text-muted)}.timeline-chip.today-chip{background:#e0edff;box-shadow:0 0 0 2px rgba(37,99,235,.2)}.today-label-text{display:inline-flex;align-items:center;gap:4px}.today-icon{font-size:.9rem}.timeline-chip.future-chip{background:#fff7ce}.timeline-chip.has-duty{background:#dcfce7}.timeline-chip.has-duty .timeline-chip-bottom{color:#166534;font-weight:600}.timeline-chip.rest-chip{background:var(--rest-bg);color:var(--rest-text)}.timeline-chip.active{box-shadow:0 0 0 2px rgba(37,99,235,.35)}.date-expand{margin-top:.4rem}.expand-block{font-size:.8rem;border-top:1px dashed var(--border-strong);padding-top:.35rem;background:#fff!important;border-radius:.65rem;padding:.6rem .7rem;position:relative}.edit-btn{border:none;background:var(--primary);color:#fff;padding:.25rem .6rem;border-radius:14px;font-size:.72rem;font-weight:600;cursor:pointer;position:absolute;top:6px;right:6px}.rest-actions{margin-top:.45rem;display:flex;justify-content:flex-end;gap:.4rem}.rest-btn{border:none;border-radius:999px;font-size:.72rem;padding:.25rem .6rem;cursor:pointer}.rest-btn-rs{background:#facc15;color:#1f2937}.rest-btn-rc{background:#fb923c;color:#1f2937}.fab{position:fixed;right:18px;bottom:80px;width:56px;height:56px;border-radius:999px;border:none;background:var(--primary);color:#fff;font-size:1.9rem;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.6);cursor:pointer;z-index:50}.overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;z-index:80}.sheet{position:fixed;left:0;right:0;bottom:0;max-width:720px;margin:0 auto;background:#fff;border-radius:16px 16px 0 0;padding:.9rem .9rem 1rem;box-shadow:0 -10px 30px rgba(15,23,42,.5);display:none;z-index:81}#logSheet{min-height:65vh;max-height:85vh;overflow-y:auto}#dutyTableSheet{top:0;bottom:0;border-radius:0;padding-top:.9rem}#restSheet,#paySheet{max-height:70vh;z-index:82}.sheet-handle{width:40px;height:4px;background:var(--border-strong);border-radius:999px;margin:0 auto .5rem}.sheet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}.sheet-title{font-size:.98rem;font-weight:600}.sheet-close{border:none;background:none;font-size:1.4rem;cursor:pointer}.field{margin-top:.6rem}.label{font-size:.78rem;font-weight:500;color:var(--text-muted);margin-bottom:.25rem;display:block}.input{width:100%;padding:.55rem .6rem;border-radius:.6rem;border:1px solid var(--border-strong);font-size:.88rem}.duty-field-header{display:flex;justify-content:space-between;align-items:center}.special-toggle-btn{border-radius:999px;border:1px solid var(--border-strong);background:#f3f4ff;font-size:.75rem;padding:.15rem .6rem;cursor:pointer;color:var(--special-text)}.date-chip-row{display:flex;gap:.35rem;overflow-x:auto;scrollbar-width:none;padding-bottom:.15rem}.date-chip-row::-webkit-scrollbar{display:none}.date-chip{flex-shrink:0;padding:.3rem .6rem;border-radius:999px;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.78rem;cursor:pointer;white-space:nowrap}.date-chip-label{font-weight:600;margin-right:.2rem}.date-chip-secondary{font-size:.72rem;color:var(--text-muted)}.date-chip.active{background:var(--primary);color:#fff}.date-chip.active .date-chip-secondary{color:rgba(255,255,255,.8)}.duty-rows{display:flex;flex-direction:column;gap:.3rem}.duty-row{display:flex;gap:.3rem;overflow-x:auto;scrollbar-width:none}.duty-row::-webkit-scrollbar{display:none}.duty-btn{flex-shrink:0;min-width:40px;padding:.3rem .4rem;border-radius:999px;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.8rem;cursor:pointer;text-align:center}.duty-btn.active{background:#dbeafe;box-shadow:0 1px 6px rgba(37,99,235,.5)}.train-row{display:flex;gap:.3rem;overflow-x:auto;scrollbar-width:none}.train-row::-webkit-scrollbar{display:none}.train-btn{flex-shrink:0;min-width:34px;padding:.3rem .35rem;border-radius:999px;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.8rem;cursor:pointer;text-align:center}.train-btn.active{background:#dbeafe;box-shadow:0 1px 6px rgba(37,99,235,.5)}.special-duty-row{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.35rem}.special-duty-btn{flex-shrink:0;padding:.3rem .6rem;border-radius:999px;border:none;background:var(--special-bg);color:var(--special-text);font-size:.78rem;cursor:pointer;box-shadow:0 1px 4px rgba(76,29,149,.18)}.special-duty-btn.active{background:var(--special-bg-active);box-shadow:0 1px 6px rgba(76,29,149,.35)}.btn-primary{width:100%;margin-top:.6rem;padding:.6rem .7rem;border-radius:.7rem;border:none;background:var(--primary);color:#fff;font-size:.9rem;font-weight:600;cursor:pointer}.history-list{margin-top:.5rem;padding-bottom:4.8rem}.history-item{margin-top:.4rem;padding:.7rem .75rem;background:var(--surface);border-radius:.8rem;border:1px solid var(--border);font-size:.82rem;cursor:pointer}.history-item.active{border-color:var(--primary);background:#fff}.history-header{display:flex;justify-content:space-between;margin-bottom:.15rem;font-weight:600}.history-meta{font-size:.76rem;color:var(--text-muted)}.history-detail{margin-top:.35rem;border-top:1px dashed var(--border-strong);padding-top:.3rem;font-size:.78rem}.history-summary{margin-top:.4rem;display:flex;flex-wrap:wrap;gap:.4rem}.history-summary-card{flex:0 0 calc(50% - .22rem);background:var(--surface);color:var(--text-primary);border:1px solid var(--border);box-shadow:0 2px 6px rgba(15,23,42,.1);border-radius:.7rem;padding:.45rem .55rem;font-size:.78rem}.history-summary-label{font-size:.7rem;color:var(--text-muted)}.history-summary-value{font-size:.95rem;font-weight:600;margin-top:.1rem}.history-summary-sub{font-size:.68rem;color:var(--text-muted);margin-top:.05rem}.history-month-chips{margin-top:.4rem;display:flex;gap:.35rem;overflow-x:auto;scrollbar-width:none;padding-bottom:.15rem}.history-month-chips::-webkit-scrollbar{display:none}.history-month-chip{flex-shrink:0;padding:.3rem .6rem;border-radius:999px;background:var(--surface-alt);color:var(--text-primary);font-size:.78rem;cursor:pointer;white-space:nowrap}.history-month-chip.active{background:var(--primary);color:#fff}.history-search-bar{position:fixed;left:0;right:0;bottom:64px;display:none;z-index:45}.history-search-inner{max-width:720px;margin:0 auto;padding:.4rem .6rem;border-radius:.9rem .9rem 0 0;background:rgba(248,250,252,.96);box-shadow:0 -4px 12px rgba(15,23,42,.16);display:flex;gap:.4rem;align-items:center}.history-search-input{flex:1;border-radius:.6rem;border:1px solid var(--border-strong);padding:.4rem .6rem;font-size:.82rem}.profile-form .field{margin-top:.6rem}.profile-form label{display:block;font-size:.8rem;margin-bottom:.2rem}.profile-form input,.profile-form select{width:100%;padding:.55rem .6rem;border-radius:.55rem;border:1px solid var(--border-strong);font-size:.86rem}.duty-table-container{margin-top:.4rem;max-height:calc(100vh - 90px);overflow-y:auto}.duty-table{width:100%;border-collapse:collapse;font-size:0.8rem}.duty-table th,.duty-table td{border-bottom:1px solid var(--border);padding:.35rem .3rem;text-align:left}.duty-table th{font-weight:600;background:var(--surface-alt)}.bottom-bar{position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;z-index:40}.nav-item{flex:1;text-align:center;font-size:.72rem;color:var(--text-muted);display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center;cursor:pointer}.nav-item span.icon{font-size:1.3rem}.nav-item.active{color:var(--primary);font-weight:600}
</style>
</head>
<body>
<div class="app-container">
  <section id="home" class="screen active">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-left">
          <div class="profile-avatar" id="profileAvatar">U</div>
          <div>
            <p class="profile-title" id="profileTitle">Hello</p>
            <p class="profile-sub" id="profileSub">Set up your profile</p>
          </div>
        </div>
        <div class="profile-datetime" id="liveDateTime">--</div>
      </div>
      <div class="profile-footer">
        <span id="profileEmpText">ID: ‚Äî</span>
        <span id="profileRoleText">Role: ‚Äî</span>
        <span id="profileRestText">Rest: ‚Äî</span>
        <span id="profileCRText">CR: 0</span>
      </div>
      <div id="profileExtraWrapper">
        <button id="profileMoreBtn">View more ‚ñæ</button>
        <div id="profileExtra" style="display:none;"></div>
      </div>
    </div>
    <div class="home-month-row">
      <div class="home-month-hint">Tap a date to view or add duty</div>
      <select id="monthSelect" class="home-month-select"></select>
    </div>
    <div id="calendarRow" class="timeline-row"></div>
    <div id="noDutiesMsg" style="display:none;font-size:0.8rem;color:var(--text-muted);margin-top:0.4rem;">
      No duties logged in this month yet. Tap any date to add.
    </div>
  </section>

  <section id="history" class="screen">
    <div class="card">
      <div class="card-title-row">
        <div class="card-title">History</div>
        <div class="card-sub">Tap a row to expand</div>
      </div>
      <div id="historyMonthChips" class="history-month-chips"></div>
      <div id="historySummary" class="history-summary"></div>
      <div style="margin-top:0.6rem;">
        <button class="btn-primary" onclick="window.open('print.html','_blank')">Print Report</button>
      </div>
      <div id="historyList" class="history-list"></div>
      <div id="noHistoryMsg">No records found. Log a duty to see history.</div>
    </div>
  </section>

  <section id="profile" class="screen">
    <div class="card profile-form">
      <div class="card-title-row">
        <div class="card-title">Profile</div>
        <div class="card-sub">Used in summaries</div>
      </div>
      <div class="field">
        <label for="pfName">Full Name</label>
        <input type="text" id="pfName">
      </div>
      <div class="field">
        <label for="pfEmpId">Employee ID</label>
        <input type="text" id="pfEmpId">
      </div>
      <div class="field">
        <label for="pfRole">Role</label>
        <select id="pfRole">
          <option value="">Select role</option>
          <option value="Station Controller">Station Controller</option>
          <option value="Train Operator">Train Operator</option>
        </select>
      </div>
      <div class="field">
        <label for="pfRest">Weekly Rest Day</label>
        <select id="pfRest">
          <option value="">Select rest day</option>
          <option value="Sunday">Sunday</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
          <option value="Saturday">Saturday</option>
        </select>
      </div>
      <div class="field">
        <label for="pfPhoto">Profile Photo</label>
        <input type="file" id="pfPhoto" accept="image/*">
      </div>
      <div class="field">
        <label for="pfConfirmDate">Date of Confirmation</label>
        <input type="date" id="pfConfirmDate">
      </div>
      <div class="field">
        <label for="pfPmeDate">Date of PME</label>
        <input type="date" id="pfPmeDate">
      </div>
      <div class="field">
        <label for="pfScCompDate">Date of Competency (Station Controller)</label>
        <input type="date" id="pfScCompDate">
      </div>
      <div class="field">
        <label for="pfToCompDate">Date of Competency (Train Operator)</label>
        <input type="date" id="pfToCompDate">
      </div>
      <div class="field">
        <label for="pfCL">Remaining Casual Leave</label>
        <input type="number" id="pfCL" min="0" step="1" placeholder="e.g. 8">
      </div>
      <div class="field">
        <label for="pfRH">Remaining RH</label>
        <input type="number" id="pfRH" min="0" step="1" placeholder="e.g. 4">
      </div>
      <button class="btn-primary" id="saveProfileBtn">Save Profile</button>
    </div>
  </section>

  <section id="settings" class="screen">
    <div class="card">
      <div class="card-title-row">
        <div class="card-title">Settings</div>
        <div class="card-sub">Tools & duty reference</div>
      </div>
      <p style="font-size:0.82rem; color:var(--text-muted); margin-top:0.3rem;">
        Duty timings & places are based on your official duty table. Tap below to view the full table.
      </p>
      <button class="btn-primary" id="viewDutyTableBtn" style="margin-top:0.6rem;">View Duty Table</button>
      <button class="btn-primary" id="configPayBtn" style="margin-top:0.6rem; background:#facc15; color:#1f2937;">
        Configure One Day Pay
      </button>
      <div class="field" style="margin-top:0.9rem;">
        <span class="label">Recent Duties Layout</span>
        <select id="viewModeSelect" class="input" style="padding:0.45rem 0.6rem;">
          <option value="vertical">Vertical (fixed)</option>
          <option value="horizontal">Horizontal (not used)</option>
        </select>
      </div>
    </div>
  </section>
</div>

<button class="fab" id="fabBtn" aria-label="Log duty">+</button>
<div class="overlay" id="overlay"></div>

<div class="sheet" id="logSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Log Duty</div>
    <div style="display:flex;align-items:center;gap:0.4rem;">
      <select id="logMonthSelect" class="home-month-select" style="font-size:0.76rem;"></select>
      <button class="sheet-close" id="sheetCloseBtn">‚úï</button>
    </div>
  </div>
  <div class="field">
    <label class="label">Date</label>
    <div class="date-chip-row" id="dateChips"></div>
  </div>
  <div class="field">
    <div class="duty-field-header">
      <span class="label">Duty Number (1‚Äì26)</span>
      <button class="special-toggle-btn" id="specialDutyToggle">Special ‚ñæ</button>
    </div>
    <div class="duty-rows" id="dutyButtons"></div>
    <div id="specialDutyContainer" style="display:none;"></div>
  </div>
  <div id="inlineShiftStationSelector" style="display:none; margin-top:0.6rem; padding:0.6rem; border:1px solid var(--border); border-radius:0.7rem;">
    <div id="shiftSelector" style="margin-bottom: 0.6rem;">
      <label class="label">Select Shift</label>
      <div id="shiftChips" class="duty-row" style="flex-wrap: wrap; gap: 0.4rem;">
        <button type="button" class="duty-btn" data-shift="M">Morning</button>
        <button type="button" class="duty-btn" data-shift="E">Evening</button>
        <button type="button" class="duty-btn" data-shift="N">Night</button>
      </div>
    </div>
    <div id="stationSelector">
      <label class="label">Select Station</label>
      <div id="inlineStationChips" class="duty-row" style="flex-wrap: wrap; gap: 0.4rem;"></div>
    </div>
  </div>
  <div class="field" id="trainField">
    <label class="label">Train Sets (1‚Äì10)</label>
    <div class="train-row" id="trainButtons"></div>
  </div>
  <button class="btn-primary" id="saveDutyBtn">Save Duty</button>
</div>

<div class="sheet" id="dutyTableSheet">
  <div class="sheet-header">
    <div class="sheet-title">Duty Table</div>
    <button class="sheet-close" id="dutyTableCloseBtn">‚úï</button>
  </div>
  <div class="duty-table-container">
    <table class="duty-table">
      <thead>
        <tr>
          <th>Duty</th><th>Sign On</th><th>On Place</th><th>Sign Off</th><th>Off Place</th><th>Hours</th>
        </tr>
      </thead>
      <tbody id="dutyTableBody"></tbody>
    </table>
  </div>
</div>

<div class="sheet" id="restSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Select New Rest Day</div>
    <button class="sheet-close" id="restCloseBtn">‚úï</button>
  </div>
  <div class="field">
    <label class="label">New Rest Date</label>
    <input type="date" id="restDateInput" class="input" />
  </div>
  <button class="btn-primary" id="saveRestDateBtn">Save Rest Day</button>
</div>

<div class="sheet" id="paySheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">One Day Pay Configuration</div>
    <button class="sheet-close" id="payCloseBtn">‚úï</button>
  </div>
  <div class="field">
    <div id="payMonthChips" class="date-chip-row"></div>
  </div>
  <div class="field">
    <label class="label" id="payInputLabel">Pay for One Day (‚Çπ)</label>
    <input type="number" id="payAmountInput" class="input" min="0" step="1" />
  </div>
  <button class="btn-primary" id="savePayBtn">Save Pay</button>
</div>

<div class="history-search-bar" id="historySearchBar">
  <div class="history-search-inner">
    <input id="historySearchInput" class="history-search-input" type="text" placeholder="Search by date, duty, train, place..." />
  </div>
</div>

<div id="crConsumeModal" class="sheet" style="display:none;">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Use Compensatory Rest</div>
    <button class="sheet-close" onclick="closeCRConsumeModal()">‚úï</button>
  </div>
  <div class="field">
    <label class="label">Available CR Dates</label>
    <div id="crList" class="date-chip-row"></div>
  </div>
  <button class="btn-primary" id="useCRBtn">Use Selected CR</button>
</div>

<div class="bottom-bar">
  <div class="nav-item active" data-tab="home"><span class="icon">üè†</span><span>Home</span></div>
  <div class="nav-item" data-tab="history"><span class="icon">üìú</span><span>History</span></div>
  <div class="nav-item" data-tab="profile"><span class="icon">üë§</span><span>Profile</span></div>
  <div class="nav-item" data-tab="settings"><span class="icon">‚öôÔ∏è</span><span>Settings</span></div>
</div>

<script>
// ======= DUTY TRACKER SCRIPT (Fixed Special Duties + printData) =======

// ----------------- Utility -----------------
const $ = id => document.getElementById(id);

// ----------------- Duty & Special config (Option A: STN keys) -----------------
const DUTY_TABLE = {
  "1": { signOn:"04:55", onPlace:"MSOR SCR", signOff:"11:55", offPlace:"MSOR SCR", hours:"07:00" },
  "2": { signOn:"04:55", onPlace:"BICP SCR", signOff:"12:25", offPlace:"MSOR SCR", hours:"07:30" },
  "3": { signOn:"04:55", onPlace:"MSOR SCR", signOff:"12:05", offPlace:"MSOR SCR", hours:"07:10" },
  "4": { signOn:"05:05", onPlace:"BICP SCR", signOff:"12:45", offPlace:"MSOR SCR", hours:"07:40" },
  "5": { signOn:"07:15", onPlace:"MSOR SCR", signOff:"14:35", offPlace:"MSOR SCR", hours:"07:20" },
  "6": { signOn:"05:00", onPlace:"DEPOT", signOff:"14:00", offPlace:"MSOR SCR", hours:"09:00" },

  "8": { signOn:"04:30", onPlace:"DEPOT", signOff:"12:15", offPlace:"MSOR SCR", hours:"07:45" },
  "9": { signOn:"04:50", onPlace:"DEPOT", signOff:"12:35", offPlace:"MSOR SCR", hours:"07:45" },

  "10": { signOn:"07:25", onPlace:"MSOR SCR", signOff:"14:55", offPlace:"MSOR SCR", hours:"07:30" },
  "11": { signOn:"07:35", onPlace:"MSOR SCR", signOff:"15:05", offPlace:"MSOR SCR", hours:"07:30" },
  "12": { signOn:"11:35", onPlace:"MSOR SCR", signOff:"18:45", offPlace:"MSOR SCR", hours:"07:10" },

  "15": { signOn:"11:45", onPlace:"MSOR SCR", signOff:"19:05", offPlace:"MSOR SCR", hours:"07:20" },
  "16": { signOn:"12:25", onPlace:"MSOR SCR", signOff:"20:35", offPlace:"MSOR SCR", hours:"08:10" },
  "17": { signOn:"12:55", onPlace:"MSOR SCR", signOff:"20:45", offPlace:"MSOR SCR", hours:"07:50" },
  "18": { signOn:"13:05", onPlace:"MSOR SCR", signOff:"20:55", offPlace:"MSOR SCR", hours:"07:50" },

  "19": { signOn:"14:35", onPlace:"MSOR SCR", signOff:"22:48", offPlace:"BICP SCR", hours:"08:13" },
  "20": { signOn:"14:45", onPlace:"MSOR SCR", signOff:"22:54", offPlace:"MSOR SCR", hours:"08:09" },

  "22": { signOn:"15:25", onPlace:"MSOR SCR", signOff:"23:10", offPlace:"DEPOT", hours:"07:45" },
  "23": { signOn:"15:05", onPlace:"MSOR SCR", signOff:"23:10", offPlace:"MSOR SCR", hours:"08:05" },
  "24": { signOn:"15:55", onPlace:"MSOR SCR", signOff:"23:05", offPlace:"BICP SCR", hours:"07:10" },
  "25": { signOn:"16:05", onPlace:"MSOR SCR", signOff:"23:20", offPlace:"DEPOT", hours:"07:15" },

  "26": { signOn:"14:00", onPlace:"MSOR SCR", signOff:"23:00", offPlace:"DEPOT", hours:"09:00" },

  "TRAINING":{signOn:"09:00",onPlace:"Training",signOff:"17:00",offPlace:"Training",hours:"08:00"},
  "GENERAL":{signOn:"09:30",onPlace:"Office",signOff:"17:30",offPlace:"Office",hours:"08:00"},
  // DCC / OCC shift entries
  "DCC-M":{signOn:"06:00",onPlace:"DCC",signOff:"14:00",offPlace:"DCC",hours:"08:00"},
  "DCC-E":{signOn:"14:00",onPlace:"DCC",signOff:"22:00",offPlace:"DCC",hours:"08:00"},
  "DCC-N":{signOn:"22:00",onPlace:"DCC",signOff:"06:00",offPlace:"DCC",hours:"08:00"},
  "OCC-M":{signOn:"06:00",onPlace:"OCC",signOff:"14:00",offPlace:"OCC",hours:"08:00"},
  "OCC-E":{signOn:"14:00",onPlace:"OCC",signOff:"22:00",offPlace:"OCC",hours:"08:00"},
  "OCC-N":{signOn:"22:00",onPlace:"OCC",signOff:"06:00",offPlace:"OCC",hours:"08:00"},
  // STN keys (Option A): use STN-* in the table; onPlace/offPlace contain 'STATION' placeholder to be replaced by actual station code
  "STN-M":{signOn:"06:00",onPlace:"STATION",signOff:"14:00",offPlace:"STATION",hours:"08:00"},
  "STN-E":{signOn:"14:00",onPlace:"STATION",signOff:"22:00",offPlace:"STATION",hours:"08:00"},
  "STN-N":{signOn:"22:00",onPlace:"STATION",signOff:"06:00",offPlace:"STATION",hours:"08:00"}
};

const SPECIAL_DUTIES = [
  {code:"CR",label:"CR",type:"simple",base:"CR"},
  {code:"CL",label:"CL",type:"simple",base:"CL"},
  {code:"GH",label:"GH",type:"simple",base:"GH"},
  {code:"RH",label:"RH",type:"simple",base:"RH"},
  {code:"TRAINING",label:"Trng",type:"simple",base:"TRAINING"},
  {code:"GENERAL",label:"Gen",type:"simple",base:"GENERAL"},
  {code:"DCC",label:"DCC",type:"shift",base:"DCC"},
  {code:"OCC",label:"OCC",type:"shift",base:"OCC"},
  // UI label "Station" but base is STN to match DUTY_TABLE keys (Option A)
  {code:"STATION",label:"Station",type:"shift",base:"STN"}
];

const STATION_LIST=["MSOR","NAMT","VKVR","SMNR","RMNR","CLJP","MRSN","SICP","CDPE","CTCP","BICP"];
const NO_DETAIL_SPECIALS=["CL","RH","GH","CR"];

// ----------------- Data load / init (with printData) ----------------
let data = loadData();
if(!data.availableCR) data.availableCR=[];
if(!data.printData) data.printData = { records: {}, profile: {}, pay: {} };

function loadData(){
  const json = localStorage.getItem("dutyTrackerData");
  return json ? JSON.parse(json) : {records:{},profile:{},manualRestDates:{},pay:{}, printData:{ records:{}, profile:{}, pay:{} } };
}
function saveData(){ localStorage.setItem("dutyTrackerData", JSON.stringify(data)); }

// ----------------- Helpers & compute functions -----------------
function todayISO(){ return new Date().toISOString().substring(0,10); }
function formatDateHuman(isoDate){
  return new Date(isoDate).toLocaleDateString("en-IN",{weekday:"short",day:"2-digit",month:"short",year:"numeric"});
}
function isNumericDuty(code){ return code!==undefined && !isNaN(code) && String(code).length > 0 && Number(code)>=1 && Number(code)<=26; }
function isShiftDuty(code){ return code && (code.startsWith("DCC-") || code.startsWith("OCC-") || code.startsWith("STN-")); }
function isNoDetailSpecial(code){ return code && NO_DETAIL_SPECIALS.indexOf(code) !== -1; }
function parseTimeHour(t){ return (t && t.length===5) ? parseInt(t.substring(0,2),10) : -1; }

function formatDutyLabel(code, tag, stationCode){
  if(!code) return "";
  let baseText = "";
  let shiftName = "";
  const parts = String(code).split("-");
  if(parts.length>1){
    if(parts[1]==="M") shiftName="Morning";
    if(parts[1]==="E") shiftName="Evening";
    if(parts[1]==="N") shiftName="Night";
  }
  if(isNumericDuty(code)) baseText = `Duty ${code}`;
  else if(["CR","CL","GH","RH"].includes(code)) baseText = code;
  else if(code==="TRAINING") baseText = "Trng";
  else if(code==="GENERAL") baseText = "Gen";
  else if(shiftName) baseText = stationCode ? `${shiftName} @${stationCode}` : shiftName;
  
  if(tag==="R/S") return `${baseText} (R/S)`;
  if(tag==="R/C") return `${baseText} (R/C)`;
  return baseText;
}

function calculateHDA(code){
  return (isNumericDuty(code) && Number(code)>=1 && Number(code)<=26) ? 100 : 0;
}
function calculateICE(code, so, sf){
  if(!isNumericDuty(code)) return 0;
  const h1 = parseTimeHour(so), h2 = parseTimeHour(sf);
  if((h1!==-1 && (h1<6 || h1>=22)) || (h2!==-1 && (h2<6 || h2>=22))) return 150;
  return 0;
}
function computeNightHours(code, so, sf){
  if(!code) return 0;
  if(String(code).endsWith("-N")) return 8;
  if(String(code).endsWith("-M") || String(code).endsWith("-E")) return 0;
  if(isNumericDuty(code)){
    const h1 = parseTimeHour(so), h2 = parseTimeHour(sf);
    if((h1!==-1 && h1<6) || (h2!==-1 && h2>=22)) return 1;
  }
  return 0;
}

// ----------------- Clock -----------------
function startClock(){
  setInterval(()=>{
    const now=new Date();
    $("liveDateTime").textContent = now.toLocaleDateString("en-IN",{weekday:"short"}) + ", " + 
    now.toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}) + " ‚Ä¢ " + 
    now.toLocaleTimeString("en-IN",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});
  },1000);
}

// ----------------- Profile rendering + handlers -----------------
let profileExpanded=false;
function renderProfile(){
  const p=data.profile||{};
  $("profileTitle").textContent = p.name ? `Hello, ${p.name.split(" ")[0]}` : "Hello";
  $("profileSub").textContent = p.role||"Set up your profile";
  $("profileEmpText").textContent = `ID: ${p.empId||"‚Äî"}`;
  $("profileRoleText").textContent = `Role: ${p.role||"‚Äî"}`;
  $("profileRestText").textContent = `Rest: ${p.restDay||"‚Äî"}`;
  $("profileCRText").textContent = `CR: ${data.availableCR?data.availableCR.length:0}`;
  
  const av=$("profileAvatar");
  if(p.photo) { av.style.backgroundImage=`url(${p.photo})`; av.textContent=""; }
  else { av.style.backgroundImage="none"; av.textContent=p.name?p.name.split(/\s+/).map(x=>x[0]).join("").slice(0,2).toUpperCase():"U"; }

  ["pfName","pfEmpId","pfRole","pfRest","pfConfirmDate","pfPmeDate","pfScCompDate","pfToCompDate","pfCL","pfRH"]
  .forEach(id => $(id).value = p[id.replace("pf","").replace(/^[A-Z]/, c => c.toLowerCase())] || "");
  
  $("profileExtra").innerHTML = `
    <div>Conf Date: ${p.confirmDate||'‚Äî'}</div><div>PME Date: ${p.pmeDate||'‚Äî'}</div>
    <div>SC Comp: ${p.scCompDate||'‚Äî'}</div><div>TO Comp: ${p.toCompDate||'‚Äî'}</div>
    <div>CL Left: ${p.cl||'‚Äî'}</div><div>RH Left: ${p.rh||'‚Äî'}</div>
  `;
  $("profileMoreBtn").textContent = profileExpanded?"View less ‚ñ¥":"View more ‚ñæ";
  $("profileExtra").style.display = profileExpanded?"block":"none";
}

function attachProfileHandlers(){
  $("saveProfileBtn").addEventListener("click", ()=>{
    data.profile={
      name:$("pfName").value.trim(), empId:$("pfEmpId").value.trim(), role:$("pfRole").value,
      restDay:$("pfRest").value, confirmDate:$("pfConfirmDate").value, pmeDate:$("pfPmeDate").value,
      scCompDate:$("pfScCompDate").value, toCompDate:$("pfToCompDate").value, cl:$("pfCL").value, rh:$("pfRH").value
    };
    data.printData = data.printData || { records:{}, profile:{}, pay:{} };
    data.printData.profile = {
      name: data.profile.name || "",
      empId: data.profile.empId || "",
      confirmDate: data.profile.confirmDate || ""
    };
    console.log("[PRINTDATA] profile saved ->", data.printData.profile);
    saveData(); renderProfile(); alert("Profile saved!");
  });
  $("pfPhoto").addEventListener("change", e=>{
    const f=e.target.files[0], r=new FileReader();
    if(f) { r.onload=ev=>{ data.profile.photo=ev.target.result; saveData(); renderProfile(); }; r.readAsDataURL(f); }
  });
  $("profileMoreBtn").addEventListener("click", ()=>{ profileExpanded=!profileExpanded; renderProfile(); });
}

// ----------------- Navigation -----------------
let currentTab="home", openHistoryDate=null;
function setActiveTab(id){
  currentTab=id;
  document.querySelectorAll(".screen").forEach(el=>el.classList.toggle("active",el.id===id));
  document.querySelectorAll(".nav-item").forEach(el=>el.classList.toggle("active",el.dataset.tab===id));
  $("fabBtn").style.display = id==="home"?"flex":"none";
  hideAllSheets();
  $("historySearchBar").style.display = id==="history"?"block":"none";
  if(id==="history") renderHistory();
}
function attachNav(){
  document.querySelectorAll(".nav-item").forEach(el=>el.addEventListener("click", ()=>setActiveTab(el.dataset.tab)));
}

// ----------------- App state -----------------
let selectedLogDate=todayISO(), selectedDutyCode=null, selectedTrains=[], specialDutyOpen=false;
let expandedDate=null, restEditMode=null, pendingRestOldDate=null;
let selectedStation=null, selectedShiftCode=null;
let selectedPayMonth=String(new Date().getMonth()+1).padStart(2,"0");
let logMonthYear={year:new Date().getFullYear(), month:new Date().getMonth()};
let currentMonthYear={year:new Date().getFullYear(), month:new Date().getMonth()};

function showOverlay(){ $("overlay").style.display="block"; }
function hideOverlay(){ $("overlay").style.display="none"; }
function hideAllSheets(){
  hideOverlay();
  ["logSheet","dutyTableSheet","restSheet","paySheet","crConsumeModal"].forEach(id=>$(id).style.display="none");
  restEditMode=null; pendingRestOldDate=null;
}

// ----------------- Inline station chips -----------------
function renderInlineStationChips(){
  const c=$("inlineStationChips"); c.innerHTML="";
  STATION_LIST.forEach(code=>{
    const b=document.createElement("button"); b.className="train-btn"; b.textContent=code; b.dataset.station=code;
    if(selectedStation===code) b.classList.add("active");
    b.addEventListener("click", e=>{
      e.preventDefault(); selectedStation=code;
      c.querySelectorAll(".train-btn").forEach(x=>x.classList.toggle("active", x.dataset.station===code));
      updateDutyChipStates();
    });
    c.appendChild(b);
  });
}

// ----------------- Duty selection handlers -----------------
function handleDutySelection(dNo){
  selectedDutyCode=dNo; selectedTrains=[];
  // Option A: treat STN as shift duty base
  const isShift = (dNo==="DCC"||dNo==="OCC"||dNo==="STN");
  $("inlineShiftStationSelector").style.display = isShift ? "block" : "none";
  $("trainField").style.display = (isNumericDuty(dNo)) ? "block" : "none";
  
  if(isShift){
    const r = data.records[selectedLogDate];
    if(r && r.duty && r.duty.startsWith(dNo)){
      // pre-fill if existing
      selectedShiftCode = r.duty.split("-")[1] || null;
      selectedStation = r.station || null;
    } else {
      selectedShiftCode = null; selectedStation = null;
    }
    document.querySelectorAll("#shiftChips button").forEach(b=>b.classList.toggle("active", b.dataset.shift===selectedShiftCode));
    // Show station selector only for STN
    if(dNo==="STN"){
      $("stationSelector").style.display="block";
      renderInlineStationChips();
    } else {
      $("stationSelector").style.display="none";
    }
  } else {
    selectedStation = null; selectedShiftCode = null;
  }
  updateDutyChipStates(); updateSpecialDutyStates();
}

function showFabLog(){
  showOverlay(); $("logSheet").style.display="block";
  renderLogMonthSelect(); renderLogDateChips(); renderDutyButtons();
  renderSpecialDutyButtons(); renderTrainButtons();
  $("inlineShiftStationSelector").style.display="none"; $("trainField").style.display="none";
  selectedDutyCode=null; selectedTrains=[]; selectedStation=null; selectedShiftCode=null;
}

function showLogSheetFor(iso, rTag){
  selectedLogDate=iso;
  if(rTag==="R/S"){
    if(!data.availableCR) data.availableCR=[];
    data.availableCR.push(iso); saveData();
    restEditMode=null; pendingRestOldDate=null;
    showFabLog(); return;
  }
  const rec=data.records[iso];
  if(rec){
    selectedTrains=rec.trains||[];
    if(isShiftDuty(rec.duty)){
      const p=rec.duty.split("-"); selectedDutyCode=p[0]; selectedShiftCode=p[1]; selectedStation=rec.station||null;
    } else { selectedDutyCode=rec.duty; selectedShiftCode=null; selectedStation=null; }
  } else {
    selectedDutyCode=null; selectedTrains=[]; selectedShiftCode=null; selectedStation=null;
  }
  if(rTag){
    restEditMode=rTag; pendingRestOldDate=iso;
    showOverlay(); $("restSheet").style.display="block"; $("restDateInput").value=iso;
    return;
  }
  restEditMode=null; pendingRestOldDate=null;
  showOverlay(); $("logSheet").style.display="block";
  renderLogMonthSelect(); renderLogDateChips(); renderDutyButtons(); renderSpecialDutyButtons();
  renderTrainButtons(); $("trainField").style.display=(selectedDutyCode&&isNumericDuty(selectedDutyCode))?"block":"none";
  
  const isShiftNow = (selectedDutyCode==="DCC"||selectedDutyCode==="OCC"||selectedDutyCode==="STN");
  $("inlineShiftStationSelector").style.display=isShiftNow?"block":"none";
  if(isShiftNow){
    renderInlineStationChips();
    document.querySelectorAll("#shiftChips button").forEach(b=>b.classList.toggle("active",b.dataset.shift===selectedShiftCode));
    if(selectedDutyCode==="STN") $("stationSelector").style.display="block"; else $("stationSelector").style.display="none";
  }
}

// ----------------- Attach buttons / sheets -----------------
function attachFabAndSheets(){
  $("fabBtn").addEventListener("click", showFabLog);
  $("overlay").addEventListener("click", hideAllSheets);
  ["sheetCloseBtn","dutyTableCloseBtn","restCloseBtn","payCloseBtn"].forEach(id=>$(id).addEventListener("click", hideAllSheets));
  $("viewDutyTableBtn").addEventListener("click", ()=>{ showOverlay(); $("dutyTableSheet").style.display="block"; });
  $("configPayBtn").addEventListener("click", ()=>{ showOverlay(); $("paySheet").style.display="block"; renderPayMonthChips(); });
  
  document.querySelectorAll("#shiftChips button").forEach(b => b.addEventListener("click", e=>{
    e.preventDefault();
    document.querySelectorAll("#shiftChips button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); selectedShiftCode=b.dataset.shift;
  }));

  $("saveRestDateBtn").addEventListener("click", ()=>{
    const val=$("restDateInput").value;
    if(!val){ alert("Select date"); return; }
    if(data.records[val]){ alert("Date has duty"); return; }
    if(restEditMode==="R/C" && pendingRestOldDate){
      data.records[pendingRestOldDate]={duty:"CR",tag:"R/C",trains:[],station:null};
      data.manualRestDates[val]=true;
      if(data.manualRestDates[pendingRestOldDate]) delete data.manualRestDates[pendingRestOldDate];
      updatePrintRecord(pendingRestOldDate);
    } else if(restEditMode==="R/S" && pendingRestOldDate){
      data.records[pendingRestOldDate]={duty:"CR",tag:"R/S",trains:[],station:null};
      updatePrintRecord(pendingRestOldDate);
    } else {
      data.manualRestDates[val]=true;
    }
    saveData(); hideAllSheets(); renderCalendar(); if(currentTab==="history") renderHistory();
  });

  $("savePayBtn").addEventListener("click", ()=>{
    const amt=Number($("payAmountInput").value);
    if(amt<0 || isNaN(amt)){ alert("Invalid amount"); return; }
    data.pay[selectedPayMonth]=amt;
    data.printData = data.printData || { records:{}, profile:{}, pay:{} };
    data.printData.pay[selectedPayMonth] = amt;
    console.log("[PRINTDATA] pay saved ->", selectedPayMonth, amt);
    saveData(); hideAllSheets(); if(currentTab==="history") renderHistory();
  });
}

// ----------------- Pay month chips -----------------
function renderPayMonthChips(){
  const c=$("payMonthChips"), names=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  c.innerHTML="";
  names.forEach((nm,i)=>{
    const m=String(i+1).padStart(2,"0"), d=document.createElement("div");
    d.className="date-chip"+(selectedPayMonth===m?" active":"");
    d.innerHTML=`<span class="date-chip-label">${nm}</span><span class="date-chip-secondary">${data.pay[m]?`‚Çπ${data.pay[m]}`:"Set"}</span>`;
    d.addEventListener("click", ()=>{
      selectedPayMonth=m; renderPayMonthChips();
      $("payAmountInput").value=data.pay[m]||""; $("payInputLabel").textContent=`Pay for One Day in ${nm} (‚Çπ)`;
    });
    c.appendChild(d);
  });
}

// ----------------- Log month and dates -----------------
function renderLogMonthSelect(){
  const s=$("logMonthSelect"); s.innerHTML="";
  for(let m=0;m<12;m++){
    const o=document.createElement("option"); o.value=`${logMonthYear.year}-${String(m+1).padStart(2,"0")}`;
    o.textContent=new Date(logMonthYear.year,m,1).toLocaleDateString("en-IN",{month:"short",year:"numeric"});
    if(m===logMonthYear.month) o.selected=true; s.appendChild(o);
  }
  s.onchange=function(){ const p=this.value.split("-"); logMonthYear.year=Number(p[0]); logMonthYear.month=Number(p[1])-1; renderLogDateChips(); };
}

function renderLogDateChips(){
  const c=$("dateChips"), y=logMonthYear.year, m=logMonthYear.month, dim=new Date(y,m+1,0).getDate(), frag=document.createDocumentFragment();
  c.innerHTML="";
  for(let i=1;i<=dim;i++){
    const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const r=data.records[iso];
    const txt=r?formatDutyLabel(r.duty,r.tag,r.station):(data.manualRestDates[iso]?"REST":"");
    const d=document.createElement("div");
    d.className=`date-chip${selectedLogDate===iso?" active":""}${iso===todayISO()?" today-chip":""}`;
    d.innerHTML=`<span class="date-chip-label">${i}</span><span class="date-chip-secondary">${new Date(y,m,i).toLocaleDateString("en-IN",{weekday:"short"})} ${txt}</span>`;
    d.onclick=()=>{
      selectedLogDate=iso; renderLogDateChips();
      if(data.records[iso]) showLogSheetFor(iso,null);
      else {
        selectedDutyCode=null; selectedTrains=[]; selectedStation=null; selectedShiftCode=null;
        updateDutyChipStates(); updateSpecialDutyStates(); $("trainField").style.display="none"; $("inlineShiftStationSelector").style.display="none";
      }
    };
    frag.appendChild(d);
  }
  c.appendChild(frag);
}

// ----------------- Duty buttons & trains -----------------
function renderDutyButtons(){
  const c=$("dutyButtons"); c.innerHTML="";
  [ ["1","2","3","4","5","6","8","9","10","11","12"], ["15","16","17","18","19","20","22","23","24","25","26"] ].forEach(grp=>{
    const r=document.createElement("div"); r.className="duty-row";
    grp.forEach(no=>{
      const b=document.createElement("button"); b.className="duty-btn"; b.textContent=no; b.dataset.no=no;
      b.onclick=e=>{ e.preventDefault(); handleDutySelection(no); updateTrainButtonStates(); };
      r.appendChild(b);
    });
    c.appendChild(r);
  });
  updateDutyChipStates();
}
function updateDutyChipStates(){
  document.querySelectorAll("#dutyButtons .duty-btn").forEach(b=>{
    const no=b.dataset.no, act=isNumericDuty(no)?(selectedDutyCode===no):(selectedDutyCode && selectedDutyCode.split("-")[0]===no);
    b.classList.toggle("active", act);
  });
  if($("inlineShiftStationSelector").style.display==="block") renderInlineStationChips();
}
function renderSpecialDutyButtons(){
  const c=$("specialDutyContainer"); c.innerHTML="";
  if(!specialDutyOpen){ c.style.display="none"; return; }
  c.style.display="block";
  const r=document.createElement("div"); r.className="special-duty-row";
  SPECIAL_DUTIES.forEach(s=>{
    const b=document.createElement("button"); b.className="special-duty-btn"; b.textContent=s.label; b.dataset.base=s.base;
    b.onclick=e=>{
      e.preventDefault();
      if(s.code==="CR"){ openCRConsumeModal(); return; }
      handleDutySelection(s.base); updateDutyChipStates(); updateSpecialDutyStates();
    };
    r.appendChild(b);
  });
  c.appendChild(r); updateSpecialDutyStates();
}
function updateSpecialDutyStates(){
  document.querySelectorAll(".special-duty-btn").forEach(b=>{
    let act=false;
    if(selectedDutyCode && !isNumericDuty(selectedDutyCode) && selectedDutyCode.split("-")[0]===b.dataset.base) act=true;
    b.classList.toggle("active", act);
  });
}
function renderTrainButtons(){
  const c=$("trainButtons"); c.innerHTML="";
  for(let i=1;i<=10;i++){
    const b=document.createElement("button"); b.className="train-btn"; b.textContent=i; b.dataset.no=i;
    b.onclick=e=>{
      e.preventDefault(); const idx=selectedTrains.indexOf(String(i));
      if(idx>-1) selectedTrains.splice(idx,1); else selectedTrains.push(String(i));
      selectedTrains.sort((a,b)=>Number(a)-Number(b)); updateTrainButtonStates();
    };
    c.appendChild(b);
  }
  updateTrainButtonStates();
}
function updateTrainButtonStates(){
  document.querySelectorAll("#trainButtons .train-btn").forEach(b=>b.classList.toggle("active",selectedTrains.includes(b.dataset.no)));
}

// ----------------- PRINT DATA Build / Update -----------------
function buildFinalPrintRecord(date, rec){
  if(!rec) return null;
  const out = { date: date };
  const dutyCode = rec.duty || "";
  out.duty = dutyCode;

  const di = DUTY_TABLE[dutyCode] || DUTY_TABLE[dutyCode.split("-")[0]] || null;

  let signOn = di && di.signOn ? di.signOn : "‚Äî";
  let signOff = di && di.signOff ? di.signOff : "‚Äî";
  let onPlace = di && di.onPlace ? di.onPlace : "‚Äî";
  let offPlace = di && di.offPlace ? di.offPlace : "‚Äî";
  let dutyHours = di && di.hours ? di.hours : "‚Äî";

  if(rec.station && typeof onPlace === "string"){
    onPlace = onPlace.replace(/STATION|DCC|OCC/g, rec.station);
    offPlace = offPlace.replace(/STATION|DCC|OCC/g, rec.station);
  }

  if(isNoDetailSpecial(String(dutyCode).split("-")[0])){
    signOn = "‚Äî"; signOff = "‚Äî"; dutyHours = "‚Äî";
  }

  const nightHours = (signOn==="‚Äî" || signOff==="‚Äî") ? 0 : computeNightHours(dutyCode, signOn, signOff);

  const trains = (rec.trains && rec.trains.length>0) ? rec.trains.slice().map(String).sort((a,b)=>Number(a)-Number(b)) : [];

  let shift = null;
  if(String(dutyCode).includes("-")){
    const p = dutyCode.split("-");
    shift = p[1] || null;
  }

  out.signOnTime = signOn;
  out.signOffTime = signOff;
  out.dutyHours = dutyHours;
  out.nightDutyHours = Number(nightHours);
  out.signOnPlace = onPlace;
  out.signOffPlace = offPlace;
  out.trains = trains;
  out.shift = shift;
  out.dutyType = isNoDetailSpecial(String(dutyCode).split("-")[0]) ? String(dutyCode).split("-")[0] : (String(dutyCode).split("-")[0] || dutyCode);
  out.station = rec.station || null;

  return out;
}

function updatePrintRecord(date){
  data.printData = data.printData || { records:{}, profile:{}, pay:{} };
  const rec = data.records[date];
  if(!rec){
    if(data.printData.records && data.printData.records[date]){
      delete data.printData.records[date];
      console.log("[PRINTDATA] deleted record for", date);
    }
    return;
  }
  const built = buildFinalPrintRecord(date, rec);
  if(built){
    data.printData.records[date] = built;
    console.log("[PRINTDATA] updated record ->", date, built);
  }
}

// ----------------- Save Duty button (MAIN) -----------------
$("saveDutyBtn").addEventListener("click", ()=>{
  if(!selectedDutyCode){ alert("Select duty"); return; }
  let code = selectedDutyCode;
  let st = null;

  // For DCC / OCC (shift-only) -> require shift but NOT station
  if(code === "DCC" || code === "OCC"){
    if(!selectedShiftCode){ alert("Select shift"); return; }
    code = `${code}-${selectedShiftCode}`;
    st = null;
  }
  // For STN (station) -> require shift + station
  else if(code === "STN"){
    if(!selectedShiftCode){ alert("Select shift"); return; }
    if(!selectedStation){ alert("Select station"); return; }
    code = `STN-${selectedShiftCode}`;
    st = selectedStation;
  }
  // Numeric duties
  else if(isNumericDuty(code)){
    if(selectedTrains.length===0){ alert("Select train"); return; }
    // leave code as numeric string
    st = null;
  }
  // Simple specials (CR,CL,GH,RH,TRAINING,GENERAL)
  else {
    st = null;
  }

  // Save to records
  data.records[selectedLogDate] = { duty: code, tag: null, trains: isNumericDuty(code) ? selectedTrains.slice() : [], station: st };

  // If rest edit mode R/S then handle CR movement (existing logic)
  if(restEditMode==="R/S" && pendingRestOldDate){
    if(!data.availableCR) data.availableCR=[];
    data.availableCR.push(pendingRestOldDate);
    if(data.records[pendingRestOldDate] && data.records[pendingRestOldDate].duty==="CR") delete data.records[pendingRestOldDate];
    updatePrintRecord(pendingRestOldDate);
  }
  if(data.manualRestDates[selectedLogDate]) delete data.manualRestDates[selectedLogDate];

  // Update print data for this date
  updatePrintRecord(selectedLogDate);

  saveData(); hideAllSheets(); renderCalendar(); if(currentTab==="history") renderHistory();
});

// ----------------- special toggle -----------------
$("specialDutyToggle").addEventListener("click", function(){ specialDutyOpen=!specialDutyOpen; this.textContent=specialDutyOpen?"Special ‚ñ¥":"Special ‚ñæ"; renderSpecialDutyButtons(); });

// ----------------- Calendar rendering -----------------
function renderCalendar(){
  const c=$("calendarRow"), y=currentMonthYear.year, m=currentMonthYear.month;
  c.innerHTML="";
  const dim=new Date(y,m+1,0).getDate(), today=todayISO(), frag=document.createDocumentFragment();
  const restIdx=data.profile.restDay ? ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].indexOf(data.profile.restDay) : -1;
  let todayEl=null;
  
  for(let i=1;i<=dim;i++){
    const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const rec=data.records[iso];
    const dow=new Date(y,m,i).getDay();
    let isRest = (restIdx>-1 && dow===restIdx) || (data.manualRestDates && data.manualRestDates[iso]);
    if(rec && rec.tag && (rec.tag==="R/S"||rec.tag==="R/C")) isRest=true; else if(rec) isRest=false;
    
    const ch=document.createElement("div"); ch.className="timeline-chip"; ch.dataset.date=iso;
    const isToday=(iso===today);
    if(isToday) ch.classList.add("today-chip");
    else if(iso>today && (new Date(today).getFullYear()===y && new Date(today).getMonth()===m)) ch.classList.add("future-chip");
    
    let top=`<div class="timeline-chip-top"><span class="${isToday?'today-label-text':''}">${isToday?`TODAY ${String(i).padStart(2,"0")}<span class='today-icon'>‚ö°</span>`:new Date(y,m,i).toLocaleDateString("en-IN",{weekday:"short"})+' '+String(i).padStart(2,"0")}</span><span style="font-weight:700;font-size:0.8rem;">${rec?formatDutyLabel(rec.duty,rec.tag,rec.station):(isRest?"REST":"")}</span></div>`;
    let bot=`<div class="timeline-chip-bottom">${rec?"Tap to view or edit":(isRest?"Weekly rest day ‚Äì tap to edit":"Tap to add duty")}</div>`;
    
    if(rec) ch.classList.add("has-duty");
    if(isRest && !rec) ch.classList.add("rest-chip");
    if(rec && isRest) ch.classList.add("rest-chip-duty");
    
    ch.innerHTML = top + bot + '<div class="date-expand" style="display:none"></div>';
    ch.onclick=()=>handleDateClick(iso);
    frag.appendChild(ch);
    if(isToday) todayEl=ch;
  }
  c.appendChild(frag);
  $("noDutiesMsg").style.display=Object.keys(data.records).length===0?"block":"none";
  if(todayEl) todayEl.scrollIntoView({behavior:'smooth',block:'center'});
}

// ----------------- Date click handling -----------------
function handleDateClick(iso){
  const ch=document.querySelector(`.timeline-chip[data-date="${iso}"]`);
  if(expandedDate && expandedDate!==iso){
    const p=document.querySelector(`.timeline-chip[data-date="${expandedDate}"]`);
    if(p){ p.classList.remove("active"); p.querySelector(".date-expand").style.display="none"; }
  }
  if(expandedDate===iso){ expandedDate=null; ch.classList.remove("active"); ch.querySelector(".date-expand").style.display="none"; return; }
  
  expandedDate=iso; ch.classList.add("active");
  const ex=ch.querySelector(".date-expand"); ex.style.display="block"; ex.innerHTML="";
  
  const rec=data.records[iso];
  if(rec){
    const d=DUTY_TABLE[rec.duty]||{};
    let op=d.onPlace||"‚Äî", fp=d.offPlace||"‚Äî";
    if(rec.station){ op=op.replace(/STATION|DCC|OCC/g,rec.station); fp=fp.replace(/STATION|DCC|OCC/g,rec.station); }
    ex.innerHTML=`<div class="expand-block"><div><strong>${formatDateHuman(iso)}</strong></div><div>Duty: ${formatDutyLabel(rec.duty,rec.tag,rec.station)}</div><button class="edit-btn">Edit Duty</button></div>`;
    ex.querySelector(".edit-btn").onclick=e=>{ e.stopPropagation(); showLogSheetFor(iso,null); };
  } else if(ch.classList.contains("rest-chip")){
    ex.innerHTML=`<div class="expand-block"><div><strong>${formatDateHuman(iso)}</strong></div><div>Scheduled Weekly Rest</div><div class="rest-actions"><button class="rest-btn rest-btn-rs" title="Rest Suspended">R/S</button><button class="rest-btn rest-btn-rc" title="Rest Changed">R/C</button></div></div>`;
    ex.querySelector(".rest-btn-rs").onclick=e=>{ e.stopPropagation(); showLogSheetFor(iso,"R/S"); };
    ex.querySelector(".rest-btn-rc").onclick=e=>{ e.stopPropagation(); showLogSheetFor(iso,"R/C"); };
  } else {
    showLogSheetFor(iso,null);
  }
}

// ----------------- History -----------------
let historyFilterMonth="all";
function renderHistoryMonthChips(){
  const c=$("historyMonthChips"), dates=Object.keys(data.records).sort().reverse();
  const months=[...new Set(dates.map(d=>d.substring(0,7)))];
  c.innerHTML=`<div class="history-month-chip${historyFilterMonth==='all'?' active':''}">All</div>`;
  c.firstChild.onclick=()=>{ historyFilterMonth="all"; renderHistory(); };
  months.forEach(m=>{
    const d=document.createElement("div");
    d.className=`history-month-chip${historyFilterMonth===m?' active':''}`;
    d.textContent=new Date(m.split("-")[0], m.split("-")[1]-1, 1).toLocaleDateString("en-IN",{month:"short",year:"numeric"});
    d.onclick=()=>{ historyFilterMonth=m; renderHistory(); };
    c.appendChild(d);
  });
}

function renderHistory(){
  renderHistoryMonthChips();
  const term=$("historySearchInput").value.toLowerCase().trim();
  let dates=Object.keys(data.records).sort().reverse();
  if(historyFilterMonth!=="all") dates=dates.filter(d=>d.startsWith(historyFilterMonth));
  if(term) dates=dates.filter(d=>{
    const r=data.records[d], dt=DUTY_TABLE[r.duty]||{};
    return d.includes(term) || (r.duty||"").toLowerCase().includes(term) || (r.trains||[]).join(",").includes(term) ||
           (dt.onPlace||"").toLowerCase().includes(term) || (dt.offPlace||"").toLowerCase().includes(term) ||
           (r.station||"").toLowerCase().includes(term) || ["cl","gh","rh","cr"].includes(term) && r.duty.toLowerCase()===term;
  });

  const sum={tot:0,cr:0,cl:0,gh:0,rh:0,hda:0,ice:0,nh:0,nda:0,ndays:0};
  dates.forEach(d=>{
    const r=data.records[d], di=DUTY_TABLE[r.duty]||{};
    sum.tot++; if(r.duty==="CR") sum.cr++; else if(r.duty==="CL") sum.cl++; else if(r.duty==="GH") sum.gh++; else if(r.duty==="RH") sum.rh++;
    sum.hda+=calculateHDA(r.duty); sum.ice+=calculateICE(r.duty,di.signOn,di.signOff); sum.nh+=computeNightHours(r.duty,di.signOn,di.signOff);
  });
  
  const mPay=(historyFilterMonth!=="all" && data.pay[historyFilterMonth.split("-")[1]]) || null;
  if(mPay){ sum.ndays=sum.nh/24; sum.nda=sum.ndays*mPay; }
  const totAll=sum.hda+sum.ice+(sum.nda||0);

  const hs=$("historySummary"); hs.innerHTML="";
  if(dates.length>0){
    const add=(t,v,s)=>hs.innerHTML+=`<div class="history-summary-card"><div class="history-summary-label">${t}</div><div class="history-summary-value">${v}</div>${s?`<div class="history-summary-sub">${s}</div>`:""}</div>`;
    add("Total Duties",sum.tot,`CR: ${sum.cr}, CL: ${sum.cl}, GH: ${sum.gh}, RH: ${sum.rh}`);
    add("Night Hours (A)",sum.nh.toFixed(1)+" hrs",null);
    add("ICE",`‚Çπ ${sum.ice}`,null);
    add("HDA",`‚Çπ ${sum.hda}`,null);
    add("NDA",sum.nda!==null?`‚Çπ ${sum.nda.toFixed(0)}`:"‚Äî", sum.nda!==null?`Night Days: ${sum.ndays.toFixed(1)}`:"1-day pay not set or 'All'");
    add("Total Allowance",`‚Çπ ${totAll.toFixed(0)}`,null);
  }

  const l=$("historyList"); l.innerHTML="";
  $("noHistoryMsg").style.display=dates.length===0?"block":"none";
  const frag=document.createDocumentFragment();
  
  dates.forEach(d=>{
    const r=data.records[d], di=DUTY_TABLE[r.duty]||{}, hda=calculateHDA(r.duty), ice=calculateICE(r.duty,di.signOn,di.signOff), nh=computeNightHours(r.duty,di.signOn,di.signOff);
    let op=di.onPlace||"‚Äî", fp=di.offPlace||"‚Äî";
    if(r.station){ op=op.replace(/STATION|DCC|OCC/g,r.station); fp=fp.replace(/STATION|DCC|OCC/g,r.station); }
    
    const item=document.createElement("div"); item.className=`history-item${openHistoryDate===d?' active':''}`;
    item.onclick=()=>{ openHistoryDate=(openHistoryDate===d)?null:d; renderHistory(); };
    
    let meta="";
    if(!isShiftDuty(r.duty) && !isNoDetailSpecial(r.duty)) meta=`<div class="history-meta">${di.signOn||'‚Äî'} @ ${op} ‚Äì ${di.signOff||'‚Äî'} @ ${fp} (${di.hours||'‚Äî'})</div>`;
    
    item.innerHTML=`<div class="history-header"><span>${formatDateHuman(d)}</span><span>${formatDutyLabel(r.duty,r.tag,r.station)}</span></div>${meta}
    <div class="history-detail" style="display:${openHistoryDate===d?'block':'none'}">
      <div>Hours: ${di.hours||'‚Äî'}</div><div>Trains: ${(r.trains||[]).join(", ")||'None'}</div>
      <div>HDA: ‚Çπ${hda}</div><div>ICE: ‚Çπ${ice}</div><div>Night Hrs: ${nh}</div>
      <button class="edit-btn" style="position:static;margin-top:.4rem;float:right">Edit Duty</button>
    </div>`;
    item.querySelector(".edit-btn").onclick=e=>{ e.stopPropagation(); showLogSheetFor(d,null); };
    frag.appendChild(item);
  });
  l.appendChild(frag);
}
$("historySearchInput").addEventListener("input", renderHistory);

// ----------------- CR Logic -----------------
function openCRConsumeModal(){
  if(!data.availableCR || data.availableCR.length===0){ alert("No available CR"); return; }
  showOverlay(); $("crConsumeModal").style.display="block";
  const c=$("crList"); c.innerHTML="";
  data.availableCR.forEach(date=>{
    const d=document.createElement("div"); d.className="date-chip"; d.dataset.date=date;
    d.innerHTML=`<span class="date-chip-label">${date.substring(8)}</span><span class="date-chip-secondary">${formatDateHuman(date)}</span>`;
    d.onclick=()=>{ c.querySelectorAll(".date-chip").forEach(x=>x.classList.remove("active")); d.classList.add("active"); };
    c.appendChild(d);
  });
}
function closeCRConsumeModal(){ hideOverlay(); $("crConsumeModal").style.display="none"; }

$("useCRBtn").addEventListener("click", ()=>{
  const ch=document.querySelector("#crList .date-chip.active");
  if(!ch){ alert("Select a CR"); return; }
  const crDate=ch.dataset.date;
  data.records[selectedLogDate]={duty:"CR", tag:null, trains:[], station:null};
  updatePrintRecord(selectedLogDate);
  data.availableCR=data.availableCR.filter(d=>d!==crDate);
  saveData(); closeCRConsumeModal(); renderCalendar(); if(currentTab==="history") renderHistory();
});

// ----------------- Duty table render -----------------
function renderDutyTableFull(){
  const tb=$("dutyTableBody"); tb.innerHTML="";
  const add=(k)=>{
    const d=DUTY_TABLE[k], tr=document.createElement("tr");
    tr.innerHTML=`<td>${k}</td><td>${d.signOn||""}</td><td>${d.onPlace||""}</td><td>${d.signOff||""}</td><td>${d.offPlace||""}</td><td>${d.hours||""}</td>`;
    tb.appendChild(tr);
  }
  const tr1=document.createElement("tr"); tr1.innerHTML="<th colspan='6'>Standard Duties (1‚Äì26)</th>"; tb.appendChild(tr1);
  Object.keys(DUTY_TABLE).filter(k=>isNumericDuty(k)).sort((a,b)=>Number(a)-Number(b)).forEach(add);
  const tr2=document.createElement("tr"); tr2.innerHTML="<th colspan='6'>Special Duties</th>"; tb.appendChild(tr2);
  Object.keys(DUTY_TABLE).filter(k=>!isNumericDuty(k)).sort().forEach(add);
}

// ----------------- Init -----------------
document.addEventListener("DOMContentLoaded", ()=>{
  startClock(); renderProfile(); attachProfileHandlers(); attachNav(); attachFabAndSheets();
  renderDutyTableFull();
  const s=$("monthSelect"); const by=new Date().getFullYear();
  for(let m=0;m<12;m++){
    const o=document.createElement("option"); o.value=m;
    o.textContent=new Date(by,m,1).toLocaleDateString("en-IN",{month:"long"});
    if(m===currentMonthYear.month) o.selected=true; s.appendChild(o);
  }
  s.onchange=function(){ currentMonthYear.month=Number(this.value); renderCalendar(); };
  renderCalendar();

  console.log("[INIT] Special duties fixed (Option A: STN-*). printData records:", Object.keys(data.printData.records||{}).length);
});
</script>
</body>
</html>