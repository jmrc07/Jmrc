<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Duty Tracker v4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
:root{--bg:#f8fafc;--primary:#2563eb;--primary-dark:#1d4ed8;--surface:#ffffff;--surface-alt:#eef2ff;--border:#e2e8f0;--border-strong:#cbd5e1;--text-primary:#0f172a;--text-muted:#64748b;--special-bg:#ede9fe;--special-bg-active:#ddd6fe;--special-text:#4c1d95;--rest-bg:#e5e7eb;--rest-text:#374151;--alarm:#ef4444}*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",sans-serif;background:var(--bg);color:var(--text-primary)}.app-container{max-width:720px;margin:0 auto;padding:0 .75rem 5.5rem}.screen{display:none}.screen.active{display:block}

/* --- FIXED HEADER STYLES (Compact & Dynamic) --- */
.profile-card-wrapper {
  position: fixed; top: 0; left: 0; right: 0; z-index: 60;
  background: var(--bg);
  padding: 0.5rem 0.75rem 0.25rem; /* Compact padding */
  max-width: 720px; margin: 0 auto;
  transition: transform 0.3s ease;
}
.profile-card-wrapper.hidden { transform: translateY(-120%); pointer-events: none; }

/* Compact Profile Card */
.profile-card{position:relative; padding:0.75rem 0.9rem; border-radius:1rem; background:linear-gradient(135deg,#1d4ed8 0%,#2563eb 40%,#3b82f6 100%); box-shadow:0 8px 20px rgba(37,99,235,.4); color:#eff6ff; overflow:hidden}
.profile-card::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at top right,rgba(255,255,255,.25),transparent 55%);pointer-events:none}

.profile-header{position:relative;display:flex;align-items:center;justify-content:space-between;z-index:1}
.profile-left { display: flex; align-items: center; gap: 10px; }
.profile-avatar{width:32px;height:32px;border-radius:999px;background:rgba(15,23,42,.15);border:1px solid rgba(191,219,254,.6);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;color:#eff6ff;background-size:cover;background-position:center}
.profile-title{margin:0;font-size:1.1rem;font-weight:700}
.profile-datetime{font-size:.9rem;font-weight:600;text-align:right}
.profile-date-sub { font-size: 0.7rem; opacity: 0.85; text-align: right; }

/* Compact Next Trip & Alarm UI */
.duty-status-row { margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
.duty-info { display: flex; flex-direction: row; align-items: center; gap: 8px; }
.current-duty-badge { background: rgba(255,255,255,0.25); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
.next-trip-info { font-size: 0.8rem; opacity: 0.95; }
.countdown-box { text-align: right; display: flex; flex-direction: column; align-items: flex-end;}
.countdown-timer { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.countdown-label { font-size: 0.55rem; opacity: 0.8; margin-top: 1px; }

.card-actions { margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px dashed rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
.alarm-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 15px; padding: 3px 8px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.alarm-btn.active { background: #fff; color: var(--primary); font-weight: 600; }
.view-trips-btn { background: none; border: none; color: #dbeafe; font-size: 0.7rem; cursor: pointer; text-decoration: underline; }

/* Page Padding Helper */
/* Will be adjusted dynamically via JS based on visible header */
#homeContent { margin-top: 10px; } 

/* Common Components */
.card{margin-top:1rem;padding:.9rem;background:var(--surface);border-radius:1rem;border:1px solid var(--border);box-shadow:0 4px 10px rgba(15,23,42,.06)}.card-title-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem}.card-title{font-size:.98rem;font-weight:600}.card-sub{font-size:.78rem;color:var(--text-muted)}.home-month-row{display:flex;justify-content:space-between;align-items:center;margin-top:.7rem;padding:0 .1rem}.home-month-hint{font-size:.78rem;color:var(--text-muted)}.home-month-select{font-size:.78rem;padding:.15rem .4rem;border-radius:.6rem;border:1px solid var(--border-strong);background:#fff}.timeline-row{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;max-height:calc(100vh - 240px);overflow-y:auto;padding-right:4px}

.timeline-chip{position:relative;flex-shrink:0;width:100%;padding:.6rem .75rem;border-radius:.9rem;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.8rem;display:flex;flex-direction:column;gap:.15rem;cursor:pointer;transition:box-shadow .12s ease;-webkit-tap-highlight-color:transparent}.timeline-chip-top{font-size:.8rem;font-weight:600;display:flex;justify-content:space-between;align-items:center}.timeline-chip-bottom{font-size:.76rem;color:var(--text-muted)}.timeline-chip.today-chip{background:#e0edff;box-shadow:0 0 0 2px rgba(37,99,235,.2); z-index: 2;}.today-label-text{display:inline-flex;align-items:center;gap:4px}.today-icon{font-size:.9rem}.timeline-chip.future-chip{background:#fff; opacity: 0.9; border: 1px dashed var(--border);}.timeline-chip.has-duty{background:#dcfce7}.timeline-chip.has-duty .timeline-chip-bottom{color:#166534;font-weight:600}.timeline-chip.rest-chip{background:var(--rest-bg);color:var(--rest-text)}.timeline-chip.active{box-shadow:0 0 0 2px rgba(37,99,235,.35)}.date-expand{margin-top:.4rem}.expand-block{font-size:.8rem;border-top:1px dashed var(--border-strong);padding-top:.35rem;background:#fff!important;border-radius:.65rem;padding:.6rem .7rem;position:relative}.edit-btn{border:none;background:var(--primary);color:#fff;padding:.25rem .6rem;border-radius:14px;font-size:.72rem;font-weight:600;cursor:pointer;position:absolute;top:6px;right:6px}.rest-actions{margin-top:.45rem;display:flex;justify-content:flex-end;gap:.4rem}.rest-btn{border:none;border-radius:999px;font-size:.72rem;padding:.25rem .6rem;cursor:pointer}.rest-btn-rs{background:#facc15;color:#1f2937}.rest-btn-rc{background:#fb923c;color:#1f2937}.fab{position:fixed;right:18px;bottom:80px;width:56px;height:56px;border-radius:999px;border:none;background:var(--primary);color:#fff;font-size:1.9rem;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.6);cursor:pointer;z-index:50}.overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;z-index:80}.sheet{position:fixed;left:0;right:0;bottom:0;max-width:720px;margin:0 auto;background:#fff;border-radius:16px 16px 0 0;padding:.9rem .9rem 1rem;box-shadow:0 -10px 30px rgba(15,23,42,.5);display:none;z-index:81}#logSheet{min-height:65vh;max-height:85vh;overflow-y:auto}
#dutyTableSheet,#profileSummarySheet,#currentDutyTripsSheet{top:0;bottom:0;border-radius:0;padding-top:.9rem; max-height: 100vh; z-index: 85;}
#restSheet,#paySheet,#alarmSheet{max-height:70vh;z-index:82}
.sheet-handle{width:40px;height:4px;background:var(--border-strong);border-radius:999px;margin:0 auto .5rem}.sheet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}.sheet-title{font-size:.98rem;font-weight:600}.sheet-close{border:none;background:none;font-size:1.4rem;cursor:pointer}.field{margin-top:.6rem}.label{font-size:.78rem;font-weight:500;color:var(--text-muted);margin-bottom:.25rem;display:block}.input{width:100%;padding:.55rem .6rem;border-radius:.6rem;border:1px solid var(--border-strong);font-size:.88rem}.duty-field-header{display:flex;justify-content:space-between;align-items:center}.special-toggle-btn{border-radius:999px;border:1px solid var(--border-strong);background:#f3f4ff;font-size:.75rem;padding:.15rem .6rem;cursor:pointer;color:var(--special-text)}.date-chip-row{display:flex;gap:.35rem;overflow-x:auto;scrollbar-width:none;padding-bottom:.15rem}.date-chip-row::-webkit-scrollbar{display:none}.date-chip{flex-shrink:0;padding:.3rem .6rem;border-radius:999px;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.78rem;cursor:pointer;white-space:nowrap}.date-chip-label{font-weight:600;margin-right:.2rem}.date-chip-secondary{font-size:.72rem;color:var(--text-muted)}.date-chip.active{background:var(--primary);color:#fff}.date-chip.active .date-chip-secondary{color:rgba(255,255,255,.8)}.duty-rows{display:flex;flex-direction:column;gap:.3rem}.duty-row{display:flex;gap:.3rem;overflow-x:auto;scrollbar-width:none}.duty-row::-webkit-scrollbar{display:none}.duty-btn{flex-shrink:0;min-width:40px;padding:.3rem .4rem;border-radius:999px;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.8rem;cursor:pointer;text-align:center}.duty-btn.active{background:#dbeafe;box-shadow:0 1px 6px rgba(37,99,235,.5)}.train-row{display:flex;gap:.3rem;overflow-x:auto;scrollbar-width:none}.train-row::-webkit-scrollbar{display:none}.train-btn{flex-shrink:0;min-width:34px;padding:.3rem .35rem;border-radius:999px;background:#fff;box-shadow:0 1px 4px rgba(15,23,42,.1);font-size:.8rem;cursor:pointer;text-align:center}.train-btn.active{background:#dbeafe;box-shadow:0 1px 6px rgba(37,99,235,.5)}.special-duty-row{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.35rem}.special-duty-btn{flex-shrink:0;padding:.3rem .6rem;border-radius:999px;border:none;background:var(--special-bg);color:var(--special-text);font-size:.78rem;cursor:pointer;box-shadow:0 1px 4px rgba(76,29,149,.18)}.special-duty-btn.active{background:var(--special-bg-active);box-shadow:0 1px 6px rgba(76,29,149,.35)}.btn-primary{width:100%;margin-top:.6rem;padding:.6rem .7rem;border-radius:.7rem;border:none;background:var(--primary);color:#fff;font-size:.9rem;font-weight:600;cursor:pointer}.history-list{margin-top:.5rem;padding-bottom:4.8rem}.history-item{margin-top:.4rem;padding:.7rem .75rem;background:var(--surface);border-radius:.8rem;border:1px solid var(--border);font-size:.82rem;cursor:pointer}.history-item.active{border-color:var(--primary);background:#fff}.history-header{display:flex;justify-content:space-between;margin-bottom:.15rem;font-weight:600}.history-meta{font-size:.76rem;color:var(--text-muted)}.history-detail{margin-top:.35rem;border-top:1px dashed var(--border-strong);padding-top:.3rem;font-size:.78rem}.history-summary{margin-top:.4rem;display:flex;flex-wrap:wrap;gap:.4rem}.history-summary-card{flex:0 0 calc(50% - .22rem);background:var(--surface);color:var(--text-primary);border:1px solid var(--border);box-shadow:0 2px 6px rgba(15,23,42,.1);border-radius:.7rem;padding:.45rem .55rem;font-size:.78rem}.history-summary-label{font-size:.7rem;color:var(--text-muted)}.history-summary-value{font-size:.95rem;font-weight:600;margin-top:.1rem}.history-summary-sub{font-size:.68rem;color:var(--text-muted);margin-top:.05rem}.history-month-chips{margin-top:.4rem;display:flex;gap:.35rem;overflow-x:auto;scrollbar-width:none;padding-bottom:.15rem}.history-month-chips::-webkit-scrollbar{display:none}.history-month-chip{flex-shrink:0;padding:.3rem .6rem;border-radius:999px;background:var(--surface-alt);color:var(--text-primary);font-size:.78rem;cursor:pointer;white-space:nowrap}.history-month-chip.active{background:var(--primary);color:#fff}.history-search-bar{position:fixed;left:0;right:0;bottom:64px;display:none;z-index:45}.history-search-inner{max-width:720px;margin:0 auto;padding:.4rem .6rem;border-radius:.9rem .9rem 0 0;background:rgba(248,250,252,.96);box-shadow:0 -4px 12px rgba(15,23,42,.16);display:flex;gap:.4rem;align-items:center}.history-search-input{flex:1;border-radius:.6rem;border:1px solid var(--border-strong);padding:.4rem .6rem;font-size:.82rem}.profile-form .field{margin-top:.6rem}.profile-form label{display:block;font-size:.8rem;margin-bottom:.2rem}.profile-form input,.profile-form select{width:100%;padding:.55rem .6rem;border-radius:.55rem;border:1px solid var(--border-strong);font-size:.86rem}.duty-table-container{margin-top:.4rem;max-height:calc(100vh - 150px);overflow-y:auto}.duty-table{width:100%;border-collapse:collapse;font-size:0.8rem}.duty-table th,.duty-table td{border-bottom:1px solid var(--border);padding:.35rem .3rem;text-align:left}.duty-table th{font-weight:600;background:var(--surface-alt)}.bottom-bar{position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;z-index:40}.nav-item{flex:1;text-align:center;font-size:.72rem;color:var(--text-muted);display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center;cursor:pointer}.nav-item span.icon{font-size:1.3rem}.nav-item.active{color:var(--primary);font-weight:600}

.profile-summary-list { margin-top: 1rem; }
.profile-item { display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
.profile-item span:first-child { color: var(--text-muted); }
.profile-item span:last-child { font-weight: 600; }
.alarm-option { padding: 0.8rem; border-bottom: 1px solid var(--border); cursor: pointer; text-align: center; font-weight: 500; }
.current-trip-row { background: #eff6ff; border-left: 3px solid var(--primary); }

/* New Styles for Trip Chip Filter */
.trip-filter-chips { display: flex; gap: 6px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; border-bottom: 1px solid var(--border); background: #fff; position: sticky; top: 0; z-index: 10; }
.trip-filter-chips::-webkit-scrollbar { display: none; }
.trip-chip { flex-shrink: 0; width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); cursor: pointer; }
.trip-chip.active { background: var(--primary); color: #fff; border-color: var(--primary-dark); box-shadow: 0 2px 6px rgba(37,99,235,0.4); }
</style>
</head>
<body>
<div class="app-container">
  
  <div class="profile-card-wrapper" id="fixedHeader">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-left">
          <div class="profile-avatar" id="profileAvatar">U</div>
          <div>
            <p class="profile-title" id="profileTitle">Hello</p>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="profile-datetime" id="liveDateTime">--:--</div>
          <div class="profile-date-sub" id="liveDate">--</div>
        </div>
      </div>
      
      <div class="duty-status-row" id="statusRow">
        <div class="duty-info">
          <div class="current-duty-badge" id="currentDutyBadge">No Duty</div>
          <div class="next-trip-info" id="nextTripText">--</div>
        </div>
        <div class="countdown-box" id="countdownBox" style="display:none;">
          <div class="countdown-timer" id="countdownTimer">00:00:00</div>
          <div class="countdown-label">UNTIL DEPARTURE</div>
        </div>
      </div>

      <div class="card-actions" id="cardActions" style="display:none;">
        <button class="alarm-btn" id="alarmBtn">
          <span>üîî</span> <span id="alarmBtnText">Set Alarm</span>
        </button>
        <button class="view-trips-btn" id="viewCurrentTripsBtn">View Today's Trips ‚Ä∫</button>
      </div>
    </div>
  </div>

  <section id="home" class="screen active">
    <div id="homeContent">
      <div class="home-month-row">
        <div class="home-month-hint">Scrolling up for future dates</div>
        <select id="monthSelect" class="home-month-select"></select>
      </div>
      <div id="calendarRow" class="timeline-row"></div>
      <div id="noDutiesMsg" style="display:none;font-size:0.8rem;color:var(--text-muted);margin-top:0.4rem;">
        No duties logged in this month yet. Tap any date to add.
      </div>
    </div>
  </section>

  <section id="history" class="screen">
    <div style="margin-top: 20px; padding-bottom:80px;">
      <div class="card">
        <div class="card-title-row">
          <div class="card-title">History</div>
          <div class="card-sub">Tap a row to expand</div>
        </div>
        <div id="historyMonthChips" class="history-month-chips"></div>
        <div id="historySummary" class="history-summary"></div>
        <div style="margin-top:0.6rem;">
          <button class="btn-primary" onclick="window.open('print.html','_blank')">Print Report</button>
        </div>
        <div id="historyList" class="history-list"></div>
        <div id="noHistoryMsg">No records found. Log a duty to see history.</div>
      </div>
    </div>
  </section>

  <section id="trips" class="screen">
    <div style="margin-top: 20px; padding-bottom:80px;">
      <div class="card">
         <div class="card-title-row">
          <div class="card-title">Trip Chart</div>
          <div class="card-sub">Filter by Duty No.</div>
        </div>
        <div class="trip-filter-chips" id="tripFilterChips"></div>
        <div class="duty-table-container">
          <table class="duty-table">
            <thead><tr><th>Duty</th><th>Dep</th><th>From</th><th>To</th><th>Train</th></tr></thead>
            <tbody id="tripChartBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="settings" class="screen">
    <div style="margin-top: 20px; padding-bottom:80px;">
      <div class="card">
        <div class="card-title-row">
          <div class="card-title">Settings</div>
          <div class="card-sub">Tools & reference</div>
        </div>
        <button class="btn-primary" id="viewProfileSummaryBtn" style="margin-top:0.6rem; background:#4f46e5;">View Profile Summary</button>
        <button class="btn-primary" id="viewDutyTableBtn" style="margin-top:0.6rem;">View Duty Table Reference</button>
        <button class="btn-primary" id="configPayBtn" style="margin-top:0.6rem; background:#facc15; color:#1f2937;">
          Configure One Day Pay
        </button>
      </div>

      <div class="card profile-form" style="margin-top: 1rem;">
        <div class="card-title-row">
          <div class="card-title">Edit Profile</div>
          <div class="card-sub">Update your details</div>
        </div>
        <div class="field"><label for="pfName">Full Name</label><input type="text" id="pfName"></div>
        <div class="field"><label for="pfEmpId">Employee ID</label><input type="text" id="pfEmpId"></div>
        <div class="field">
          <label for="pfRole">Role</label>
          <select id="pfRole">
            <option value="">Select role</option>
            <option value="Station Controller">Station Controller</option>
            <option value="Train Operator">Train Operator</option>
          </select>
        </div>
        <div class="field">
          <label for="pfRest">Weekly Rest Day</label>
          <select id="pfRest">
            <option value="">Select rest day</option>
            <option value="Sunday">Sunday</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
          </select>
        </div>
        <div class="field"><label for="pfPhoto">Profile Photo</label><input type="file" id="pfPhoto" accept="image/*"></div>
        <div class="field"><label for="pfConfirmDate">Date of Confirmation</label><input type="date" id="pfConfirmDate"></div>
        <div class="field"><label for="pfPmeDate">Date of PME</label><input type="date" id="pfPmeDate"></div>
        <div class="field"><label for="pfCL">Remaining CL</label><input type="number" id="pfCL" min="0" step="1"></div>
        <div class="field"><label for="pfRH">Remaining RH</label><input type="number" id="pfRH" min="0" step="1"></div>
        <button class="btn-primary" id="saveProfileBtn">Save Profile</button>
      </div>
    </div>
  </section>
</div>

<button class="fab" id="fabBtn" aria-label="Log duty">+</button>
<div class="overlay" id="overlay"></div>

<div class="sheet" id="logSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Log Duty</div>
    <div style="display:flex;align-items:center;gap:0.4rem;">
      <select id="logMonthSelect" class="home-month-select" style="font-size:0.76rem;"></select>
      <button class="sheet-close" id="sheetCloseBtn">‚úï</button>
    </div>
  </div>
  <div class="field">
    <label class="label">Date</label>
    <div class="date-chip-row" id="dateChips"></div>
  </div>
  <div class="field">
    <div class="duty-field-header">
      <span class="label">Duty Number (1‚Äì26)</span>
      <button class="special-toggle-btn" id="specialDutyToggle">Special ‚ñæ</button>
    </div>
    <div class="duty-rows" id="dutyButtons"></div>
    <div id="specialDutyContainer" style="display:none;"></div>
  </div>
  <div id="inlineShiftStationSelector" style="display:none; margin-top:0.6rem; padding:0.6rem; border:1px solid var(--border); border-radius:0.7rem;">
    <div id="shiftSelector" style="margin-bottom: 0.6rem;">
      <label class="label">Select Shift</label>
      <div id="shiftChips" class="duty-row" style="flex-wrap: wrap; gap: 0.4rem;">
        <button type="button" class="duty-btn" data-shift="M">Morning</button>
        <button type="button" class="duty-btn" data-shift="E">Evening</button>
        <button type="button" class="duty-btn" data-shift="N">Night</button>
      </div>
    </div>
    <div id="stationSelector">
      <label class="label">Select Station</label>
      <div id="inlineStationChips" class="duty-row" style="flex-wrap: wrap; gap: 0.4rem;"></div>
    </div>
  </div>
  <div class="field" id="trainField">
    <label class="label">Train Sets (1‚Äì10)</label>
    <div class="train-row" id="trainButtons"></div>
  </div>
  <button class="btn-primary" id="saveDutyBtn">Save Duty</button>
</div>

<div class="sheet" id="dutyTableSheet">
  <div class="sheet-header">
    <div class="sheet-title">Duty Table Reference</div>
    <button class="sheet-close" id="dutyTableCloseBtn">‚úï</button>
  </div>
  <div class="duty-table-container">
    <table class="duty-table">
      <thead><tr><th>Duty</th><th>Sign On</th><th>On Place</th><th>Sign Off</th><th>Off Place</th><th>Hours</th></tr></thead>
      <tbody id="dutyTableBody"></tbody>
    </table>
  </div>
</div>

<div class="sheet" id="restSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header"><div class="sheet-title">Select New Rest Day</div><button class="sheet-close" id="restCloseBtn">‚úï</button></div>
  <div class="field"><label class="label">New Rest Date</label><input type="date" id="restDateInput" class="input" /></div>
  <button class="btn-primary" id="saveRestDateBtn">Save Rest Day</button>
</div>

<div class="sheet" id="paySheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header"><div class="sheet-title">One Day Pay Config</div><button class="sheet-close" id="payCloseBtn">‚úï</button></div>
  <div class="field"><div id="payMonthChips" class="date-chip-row"></div></div>
  <div class="field"><label class="label" id="payInputLabel">Pay for One Day (‚Çπ)</label><input type="number" id="payAmountInput" class="input" min="0" step="1" /></div>
  <button class="btn-primary" id="savePayBtn">Save Pay</button>
</div>

<div class="history-search-bar" id="historySearchBar">
  <div class="history-search-inner">
    <input id="historySearchInput" class="history-search-input" type="text" placeholder="Search..." />
  </div>
</div>

<div id="crConsumeModal" class="sheet" style="display:none;">
  <div class="sheet-handle"></div>
  <div class="sheet-header"><div class="sheet-title">Use CR</div><button class="sheet-close" onclick="closeCRConsumeModal()">‚úï</button></div>
  <div class="field"><label class="label">Available CR Dates</label><div id="crList" class="date-chip-row"></div></div>
  <button class="btn-primary" id="useCRBtn">Use Selected CR</button>
</div>

<div class="sheet" id="profileSummarySheet">
  <div class="sheet-header"><div class="sheet-title">Profile Summary</div><button class="sheet-close" id="profileSummaryCloseBtn">‚úï</button></div>
  <div class="profile-summary-list">
    <div class="profile-item"><span>Name</span><span id="psName">‚Äî</span></div>
    <div class="profile-item"><span>Employee ID</span><span id="psEmpId">‚Äî</span></div>
    <div class="profile-item"><span>Role</span><span id="psRole">‚Äî</span></div>
    <div class="profile-item"><span>Weekly Rest</span><span id="psRest">‚Äî</span></div>
    <div class="profile-item"><span>Available CR</span><span id="psCR">0</span></div>
    <div class="profile-item"><span>CL Left</span><span id="psCL">‚Äî</span></div>
    <div class="profile-item"><span>RH Left</span><span id="psRH">‚Äî</span></div>
    <div class="profile-item"><span>Conf Date</span><span id="psConf">‚Äî</span></div>
    <div class="profile-item"><span>PME Date</span><span id="psPME">‚Äî</span></div>
  </div>
</div>

<div class="sheet" id="currentDutyTripsSheet">
  <div class="sheet-header"><div class="sheet-title">Today's Trips</div><button class="sheet-close" id="currentTripsCloseBtn">‚úï</button></div>
  <div class="duty-table-container">
    <table class="duty-table"><thead><tr><th>Dep</th><th>From</th><th>To</th><th>Train</th></tr></thead><tbody id="currentDutyTripsBody"></tbody></table>
  </div>
</div>

<div class="sheet" id="alarmSheet">
  <div class="sheet-header"><div class="sheet-title">Set Reminder</div><button class="sheet-close" id="alarmCloseBtn">‚úï</button></div>
  <div style="padding-bottom:1rem;">
    <div class="alarm-option" data-min="5">5 Minutes Before</div>
    <div class="alarm-option" data-min="10">10 Minutes Before</div>
    <div class="alarm-option" data-min="15">15 Minutes Before</div>
    <div class="alarm-option" data-min="20">20 Minutes Before</div>
    <div class="alarm-option" data-min="30">30 Minutes Before</div>
    <div class="alarm-option" id="turnOffAlarmBtn" style="color:#ef4444;">Turn Off Alarm</div>
  </div>
</div>

<div class="bottom-bar">
  <div class="nav-item active" data-tab="home"><span class="icon">üè†</span><span>Home</span></div>
  <div class="nav-item" data-tab="trips"><span class="icon">üöÜ</span><span>Trip Chart</span></div>
  <div class="nav-item" data-tab="history"><span class="icon">üìú</span><span>History</span></div>
  <div class="nav-item" data-tab="settings"><span class="icon">‚öôÔ∏è</span><span>Settings</span></div>
</div>

<script>
// ======= DUTY TRACKER SCRIPT v4.0 =======

const $ = id => document.getElementById(id);

// ----------------- CONFIG -----------------
const DUTY_TABLE = {
  "1": { signOn:"04:55", onPlace:"MSOR SCR", signOff:"11:55", offPlace:"MSOR SCR", hours:"07:00" },
  "2": { signOn:"04:55", onPlace:"BICP SCR", signOff:"12:25", offPlace:"MSOR SCR", hours:"07:30" },
  "3": { signOn:"04:55", onPlace:"MSOR SCR", signOff:"12:05", offPlace:"MSOR SCR", hours:"07:10" },
  "4": { signOn:"05:05", onPlace:"BICP SCR", signOff:"12:45", offPlace:"MSOR SCR", hours:"07:40" },
  "5": { signOn:"07:15", onPlace:"MSOR SCR", signOff:"14:35", offPlace:"MSOR SCR", hours:"07:20" },
  "6": { signOn:"05:00", onPlace:"DEPOT", signOff:"14:00", offPlace:"MSOR SCR", hours:"09:00" },
  "8": { signOn:"04:30", onPlace:"DEPOT", signOff:"12:15", offPlace:"MSOR SCR", hours:"07:45" },
  "9": { signOn:"04:50", onPlace:"DEPOT", signOff:"12:35", offPlace:"MSOR SCR", hours:"07:45" },
  "10": { signOn:"07:25", onPlace:"MSOR SCR", signOff:"14:55", offPlace:"MSOR SCR", hours:"07:30" },
  "11": { signOn:"07:35", onPlace:"MSOR SCR", signOff:"15:05", offPlace:"MSOR SCR", hours:"07:30" },
  "12": { signOn:"11:35", onPlace:"MSOR SCR", signOff:"18:45", offPlace:"MSOR SCR", hours:"07:10" },
  "15": { signOn:"11:45", onPlace:"MSOR SCR", signOff:"19:05", offPlace:"MSOR SCR", hours:"07:20" },
  "16": { signOn:"12:25", onPlace:"MSOR SCR", signOff:"20:35", offPlace:"MSOR SCR", hours:"08:10" },
  "17": { signOn:"12:55", onPlace:"MSOR SCR", signOff:"20:45", offPlace:"MSOR SCR", hours:"07:50" },
  "18": { signOn:"13:05", onPlace:"MSOR SCR", signOff:"20:55", offPlace:"MSOR SCR", hours:"07:50" },
  "19": { signOn:"14:35", onPlace:"MSOR SCR", signOff:"22:48", offPlace:"BICP SCR", hours:"08:13" },
  "20": { signOn:"14:45", onPlace:"MSOR SCR", signOff:"22:54", offPlace:"MSOR SCR", hours:"08:09" },
  "22": { signOn:"15:25", onPlace:"MSOR SCR", signOff:"23:10", offPlace:"DEPOT", hours:"07:45" },
  "23": { signOn:"15:05", onPlace:"MSOR SCR", signOff:"23:10", offPlace:"MSOR SCR", hours:"08:05" },
  "24": { signOn:"15:55", onPlace:"MSOR SCR", signOff:"23:05", offPlace:"BICP SCR", hours:"07:10" },
  "25": { signOn:"16:05", onPlace:"MSOR SCR", signOff:"23:20", offPlace:"DEPOT", hours:"07:15" },
  "26": { signOn:"14:00", onPlace:"MSOR SCR", signOff:"23:00", offPlace:"DEPOT", hours:"09:00" },
  "TRAINING":{signOn:"09:00",onPlace:"Training",signOff:"17:00",offPlace:"Training",hours:"08:00"},
  "GENERAL":{signOn:"09:30",onPlace:"Office",signOff:"17:30",offPlace:"Office",hours:"08:00"},
  "DCC-M":{signOn:"06:00",onPlace:"DCC",signOff:"14:00",offPlace:"DCC",hours:"08:00"},
  "DCC-E":{signOn:"14:00",onPlace:"DCC",signOff:"22:00",offPlace:"DCC",hours:"08:00"},
  "DCC-N":{signOn:"22:00",onPlace:"DCC",signOff:"06:00",offPlace:"DCC",hours:"08:00"},
  "OCC-M":{signOn:"06:00",onPlace:"OCC",signOff:"14:00",offPlace:"OCC",hours:"08:00"},
  "OCC-E":{signOn:"14:00",onPlace:"OCC",signOff:"22:00",offPlace:"OCC",hours:"08:00"},
  "OCC-N":{signOn:"22:00",onPlace:"OCC",signOff:"06:00",offPlace:"OCC",hours:"08:00"},
  "STN-M":{signOn:"06:00",onPlace:"STATION",signOff:"14:00",offPlace:"STATION",hours:"08:00"},
  "STN-E":{signOn:"14:00",onPlace:"STATION",signOff:"22:00",offPlace:"STATION",hours:"08:00"},
  "STN-N":{signOn:"22:00",onPlace:"STATION",signOff:"06:00",offPlace:"STATION",hours:"08:00"}
};

const TRIP_DATA = [
  {d:"1",f:"MSOR",dep:"05:20",t:"BICP",tr:"401"},{d:"1",f:"BICP",dep:"05:59",t:"MSOR",tr:"1801"},{d:"1",f:"MSOR",dep:"06:30",t:"BICP",tr:"401"},{d:"1",f:"BICP",dep:"06:59",t:"MSOR",tr:"1801"},{d:"1",f:"MSOR",dep:"08:00",t:"BICP",tr:"402"},{d:"1",f:"BICP",dep:"08:29",t:"MSOR",tr:"1802"},{d:"1",f:"MSOR",dep:"09:50",t:"BICP",tr:"405"},{d:"1",f:"BICP",dep:"10:19",t:"MSOR",tr:"1805"},{d:"1",f:"MSOR",dep:"10:50",t:"BICP",tr:"405"},{d:"1",f:"BICP",dep:"11:19",t:"MSOR",tr:"1805"},
  {d:"2",f:"MSOR",dep:"05:58",t:"BICP",tr:"402"},{d:"2",f:"BICP",dep:"06:29",t:"MSOR",tr:"1802"},{d:"2",f:"MSOR",dep:"07:00",t:"BICP",tr:"402"},{d:"2",f:"BICP",dep:"07:29",t:"MSOR",tr:"1802"},{d:"2",f:"MSOR",dep:"08:30",t:"BICP",tr:"401"},{d:"2",f:"BICP",dep:"08:59",t:"MSOR",tr:"1801"},{d:"2",f:"MSOR",dep:"09:30",t:"BICP",tr:"401"},{d:"2",f:"BICP",dep:"09:59",t:"MSOR",tr:"1801"},{d:"2",f:"MSOR",dep:"11:20",t:"BICP",tr:"404"},{d:"2",f:"BICP",dep:"11:49",t:"MSOR",tr:"1804"},
  {d:"3",f:"MSOR",dep:"05:38",t:"BICP",tr:"403"},{d:"3",f:"BICP",dep:"06:09",t:"MSOR",tr:"1803"},{d:"3",f:"MSOR",dep:"06:40",t:"BICP",tr:"403"},{d:"3",f:"BICP",dep:"07:09",t:"MSOR",tr:"1803"},{d:"3",f:"MSOR",dep:"08:10",t:"BICP",tr:"406"},{d:"3",f:"BICP",dep:"08:39",t:"MSOR",tr:"1806"},{d:"3",f:"MSOR",dep:"10:00",t:"BICP",tr:"402"},{d:"3",f:"BICP",dep:"10:29",t:"MSOR",tr:"1802"},{d:"3",f:"MSOR",dep:"11:00",t:"BICP",tr:"402"},{d:"3",f:"BICP",dep:"11:29",t:"MSOR",tr:"1802"},
  {d:"4",f:"MSOR",dep:"06:18",t:"BICP",tr:"404"},{d:"4",f:"BICP",dep:"06:49",t:"MSOR",tr:"1804"},{d:"4",f:"MSOR",dep:"07:20",t:"BICP",tr:"404"},{d:"4",f:"BICP",dep:"07:49",t:"MSOR",tr:"1804"},{d:"4",f:"MSOR",dep:"09:10",t:"BICP",tr:"406"},{d:"4",f:"BICP",dep:"09:39",t:"MSOR",tr:"1806"},{d:"4",f:"MSOR",dep:"11:40",t:"BICP",tr:"403"},{d:"4",f:"BICP",dep:"12:09",t:"MSOR",tr:"1803"},
  {d:"5",f:"MSOR",dep:"07:30",t:"BICP",tr:"401"},{d:"5",f:"BICP",dep:"07:59",t:"MSOR",tr:"1801"},{d:"5",f:"MSOR",dep:"09:40",t:"BICP",tr:"403"},{d:"5",f:"BICP",dep:"10:09",t:"MSOR",tr:"1803"},{d:"5",f:"MSOR",dep:"10:40",t:"BICP",tr:"403"},{d:"5",f:"BICP",dep:"11:09",t:"MSOR",tr:"1803"},{d:"5",f:"MSOR",dep:"12:30",t:"BICP",tr:"401"},{d:"5",f:"BICP",dep:"12:59",t:"MSOR",tr:"1801"},{d:"5",f:"MSOR",dep:"13:30",t:"BICP",tr:"401"},{d:"5",f:"BICP",dep:"13:59",t:"MSOR",tr:"1801"},
  {d:"8",f:"MSOR",dep:"05:48",t:"BICP",tr:"405"},{d:"8",f:"BICP",dep:"06:19",t:"MSOR",tr:"1805"},{d:"8",f:"MSOR",dep:"06:50",t:"BICP",tr:"405"},{d:"8",f:"BICP",dep:"07:19",t:"MSOR",tr:"1805"},{d:"8",f:"MSOR",dep:"08:20",t:"BICP",tr:"404"},{d:"8",f:"BICP",dep:"08:49",t:"MSOR",tr:"1804"},{d:"8",f:"MSOR",dep:"09:20",t:"BICP",tr:"404"},{d:"8",f:"BICP",dep:"09:49",t:"MSOR",tr:"1804"},{d:"8",f:"MSOR",dep:"11:10",t:"BICP",tr:"406"},{d:"8",f:"BICP",dep:"11:39",t:"MSOR",tr:"1806"},
  {d:"9",f:"MSOR",dep:"06:08",t:"BICP",tr:"406"},{d:"9",f:"BICP",dep:"06:39",t:"MSOR",tr:"1806"},{d:"9",f:"MSOR",dep:"07:10",t:"BICP",tr:"406"},{d:"9",f:"BICP",dep:"07:39",t:"MSOR",tr:"1806"},{d:"9",f:"MSOR",dep:"09:00",t:"BICP",tr:"402"},{d:"9",f:"BICP",dep:"09:29",t:"MSOR",tr:"1802"},{d:"9",f:"MSOR",dep:"10:30",t:"BICP",tr:"401"},{d:"9",f:"BICP",dep:"10:59",t:"MSOR",tr:"1801"},{d:"9",f:"MSOR",dep:"11:30",t:"BICP",tr:"401"},{d:"9",f:"BICP",dep:"11:59",t:"MSOR",tr:"1801"},
  {d:"10",f:"MSOR",dep:"07:40",t:"BICP",tr:"403"},{d:"10",f:"BICP",dep:"08:09",t:"MSOR",tr:"1803"},{d:"10",f:"MSOR",dep:"08:40",t:"BICP",tr:"403"},{d:"10",f:"BICP",dep:"09:09",t:"MSOR",tr:"1803"},{d:"10",f:"MSOR",dep:"10:10",t:"BICP",tr:"406"},{d:"10",f:"BICP",dep:"10:39",t:"MSOR",tr:"1806"},{d:"10",f:"MSOR",dep:"12:20",t:"BICP",tr:"404"},{d:"10",f:"BICP",dep:"12:49",t:"MSOR",tr:"1804"},{d:"10",f:"MSOR",dep:"13:50",t:"BICP",tr:"405"},{d:"10",f:"BICP",dep:"14:19",t:"MSOR",tr:"1805"},
  {d:"11",f:"MSOR",dep:"07:50",t:"BICP",tr:"405"},{d:"11",f:"BICP",dep:"08:19",t:"MSOR",tr:"1805"},{d:"11",f:"MSOR",dep:"08:50",t:"BICP",tr:"405"},{d:"11",f:"BICP",dep:"09:19",t:"MSOR",tr:"1805"},{d:"11",f:"MSOR",dep:"10:20",t:"BICP",tr:"404"},{d:"11",f:"BICP",dep:"10:49",t:"MSOR",tr:"1804"},{d:"11",f:"MSOR",dep:"12:10",t:"BICP",tr:"406"},{d:"11",f:"BICP",dep:"12:39",t:"MSOR",tr:"1806"},{d:"11",f:"MSOR",dep:"14:00",t:"BICP",tr:"402"},{d:"11",f:"BICP",dep:"14:29",t:"MSOR",tr:"1802"},
  {d:"12",f:"MSOR",dep:"11:50",t:"BICP",tr:"405"},{d:"12",f:"BICP",dep:"12:19",t:"MSOR",tr:"1805"},{d:"12",f:"MSOR",dep:"12:50",t:"BICP",tr:"405"},{d:"12",f:"BICP",dep:"13:19",t:"MSOR",tr:"1805"},{d:"12",f:"MSOR",dep:"14:30",t:"BICP",tr:"401"},{d:"12",f:"BICP",dep:"14:59",t:"MSOR",tr:"1801"},{d:"12",f:"MSOR",dep:"15:30",t:"BICP",tr:"401"},{d:"12",f:"BICP",dep:"15:59",t:"MSOR",tr:"1801"},{d:"12",f:"MSOR",dep:"17:40",t:"BICP",tr:"403"},{d:"12",f:"BICP",dep:"18:09",t:"MSOR",tr:"1803"},
  {d:"15",f:"MSOR",dep:"12:00",t:"BICP",tr:"402"},{d:"15",f:"BICP",dep:"12:29",t:"MSOR",tr:"1802"},{d:"15",f:"MSOR",dep:"13:00",t:"BICP",tr:"402"},{d:"15",f:"BICP",dep:"13:29",t:"MSOR",tr:"1802"},{d:"15",f:"MSOR",dep:"14:40",t:"BICP",tr:"403"},{d:"15",f:"BICP",dep:"15:09",t:"MSOR",tr:"1803"},{d:"15",f:"MSOR",dep:"17:00",t:"BICP",tr:"402"},{d:"15",f:"BICP",dep:"17:29",t:"MSOR",tr:"1802"},{d:"15",f:"MSOR",dep:"18:00",t:"BICP",tr:"402"},{d:"15",f:"BICP",dep:"18:29",t:"MSOR",tr:"1802"},
  {d:"16",f:"MSOR",dep:"12:40",t:"BICP",tr:"403"},{d:"16",f:"BICP",dep:"13:09",t:"MSOR",tr:"1803"},{d:"16",f:"MSOR",dep:"13:40",t:"BICP",tr:"403"},{d:"16",f:"BICP",dep:"14:09",t:"MSOR",tr:"1803"},{d:"16",f:"MSOR",dep:"15:10",t:"BICP",tr:"406"},{d:"16",f:"BICP",dep:"15:39",t:"MSOR",tr:"1806"},{d:"16",f:"MSOR",dep:"17:50",t:"BICP",tr:"405"},{d:"16",f:"BICP",dep:"18:19",t:"MSOR",tr:"1805"},{d:"16",f:"MSOR",dep:"19:30",t:"BICP",tr:"401"},{d:"16",f:"BICP",dep:"19:59",t:"MSOR",tr:"1801"},
  {d:"17",f:"MSOR",dep:"13:10",t:"BICP",tr:"406"},{d:"17",f:"BICP",dep:"13:39",t:"MSOR",tr:"1806"},{d:"17",f:"MSOR",dep:"14:10",t:"BICP",tr:"406"},{d:"17",f:"BICP",dep:"14:39",t:"MSOR",tr:"1806"},{d:"17",f:"MSOR",dep:"16:30",t:"BICP",tr:"401"},{d:"17",f:"BICP",dep:"16:59",t:"MSOR",tr:"1801"},{d:"17",f:"MSOR",dep:"18:10",t:"BICP",tr:"406"},{d:"17",f:"BICP",dep:"18:39",t:"MSOR",tr:"1806"},{d:"17",f:"MSOR",dep:"19:40",t:"BICP",tr:"403"},{d:"17",f:"BICP",dep:"20:09",t:"MSOR",tr:"1803"},
  {d:"18",f:"MSOR",dep:"13:20",t:"BICP",tr:"404"},{d:"18",f:"BICP",dep:"13:49",t:"MSOR",tr:"1804"},{d:"18",f:"MSOR",dep:"14:20",t:"BICP",tr:"404"},{d:"18",f:"BICP",dep:"14:49",t:"MSOR",tr:"1804"},{d:"18",f:"MSOR",dep:"16:50",t:"BICP",tr:"405"},{d:"18",f:"BICP",dep:"17:19",t:"MSOR",tr:"1805"},{d:"18",f:"MSOR",dep:"18:50",t:"BICP",tr:"405"},{d:"18",f:"BICP",dep:"19:19",t:"MSOR",tr:"1805"},{d:"18",f:"MSOR",dep:"19:50",t:"BICP",tr:"405"},{d:"18",f:"BICP",dep:"20:19",t:"MSOR",tr:"1805"},
  {d:"19",f:"MSOR",dep:"14:50",t:"BICP",tr:"405"},{d:"19",f:"BICP",dep:"15:19",t:"MSOR",tr:"1805"},{d:"19",f:"MSOR",dep:"15:50",t:"BICP",tr:"405"},{d:"19",f:"BICP",dep:"16:19",t:"MSOR",tr:"1805"},{d:"19",f:"MSOR",dep:"18:30",t:"BICP",tr:"401"},{d:"19",f:"BICP",dep:"18:59",t:"MSOR",tr:"1801"},{d:"19",f:"MSOR",dep:"20:00",t:"BICP",tr:"402"},{d:"19",f:"BICP",dep:"20:29",t:"MSOR",tr:"1802"},{d:"19",f:"MSOR",dep:"21:00",t:"BICP",tr:"402"},{d:"19",f:"BICP",dep:"21:29",t:"MSOR",tr:"1802"},{d:"19",f:"MSOR",dep:"22:05",t:"BICP",tr:"402"},
  {d:"20",f:"MSOR",dep:"15:00",t:"BICP",tr:"402"},{d:"20",f:"BICP",dep:"15:29",t:"MSOR",tr:"1802"},{d:"20",f:"MSOR",dep:"16:00",t:"BICP",tr:"402"},{d:"20",f:"BICP",dep:"16:29",t:"MSOR",tr:"1802"},{d:"20",f:"MSOR",dep:"19:10",t:"BICP",tr:"406"},{d:"20",f:"BICP",dep:"19:39",t:"MSOR",tr:"1806"},{d:"20",f:"MSOR",dep:"20:40",t:"BICP",tr:"403"},{d:"20",f:"BICP",dep:"21:09",t:"MSOR",tr:"1803"},{d:"20",f:"MSOR",dep:"21:40",t:"BICP",tr:"403"},{d:"20",f:"BICP",dep:"22:11",t:"MSOR",tr:"1803"},
  {d:"22",f:"MSOR",dep:"15:40",t:"BICP",tr:"403"},{d:"22",f:"BICP",dep:"16:09",t:"MSOR",tr:"1803"},{d:"22",f:"MSOR",dep:"16:40",t:"BICP",tr:"403"},{d:"22",f:"BICP",dep:"17:09",t:"MSOR",tr:"1803"},{d:"22",f:"MSOR",dep:"18:20",t:"BICP",tr:"404"},{d:"22",f:"BICP",dep:"18:49",t:"MSOR",tr:"1804"},{d:"22",f:"MSOR",dep:"20:20",t:"BICP",tr:"404"},{d:"22",f:"BICP",dep:"20:49",t:"MSOR",tr:"1804"},{d:"22",f:"MSOR",dep:"21:20",t:"BICP",tr:"404"},{d:"22",f:"BICP",dep:"21:51",t:"MSOR",tr:"1804"},
  {d:"23",f:"MSOR",dep:"15:20",t:"BICP",tr:"404"},{d:"23",f:"BICP",dep:"15:49",t:"MSOR",tr:"1804"},{d:"23",f:"MSOR",dep:"17:30",t:"BICP",tr:"401"},{d:"23",f:"BICP",dep:"17:59",t:"MSOR",tr:"1801"},{d:"23",f:"MSOR",dep:"19:20",t:"BICP",tr:"404"},{d:"23",f:"BICP",dep:"19:49",t:"MSOR",tr:"1804"},{d:"23",f:"MSOR",dep:"20:50",t:"BICP",tr:"405"},{d:"23",f:"BICP",dep:"21:19",t:"MSOR",tr:"1805"},{d:"23",f:"MSOR",dep:"21:50",t:"BICP",tr:"405"},{d:"23",f:"BICP",dep:"22:21",t:"MSOR",tr:"1805"},
  {d:"24",f:"MSOR",dep:"16:10",t:"BICP",tr:"406"},{d:"24",f:"BICP",dep:"16:39",t:"MSOR",tr:"1806"},{d:"24",f:"MSOR",dep:"17:10",t:"BICP",tr:"406"},{d:"24",f:"BICP",dep:"17:39",t:"MSOR",tr:"1806"},{d:"24",f:"MSOR",dep:"18:40",t:"BICP",tr:"403"},{d:"24",f:"BICP",dep:"19:09",t:"MSOR",tr:"1803"},{d:"24",f:"MSOR",dep:"20:10",t:"BICP",tr:"406"},{d:"24",f:"BICP",dep:"20:39",t:"MSOR",tr:"1806"},{d:"24",f:"MSOR",dep:"21:10",t:"BICP",tr:"406"},{d:"24",f:"BICP",dep:"21:41",t:"MSOR",tr:"1806"},{d:"24",f:"MSOR",dep:"22:21",t:"BICP",tr:"406"},
  {d:"25",f:"MSOR",dep:"16:20",t:"BICP",tr:"404"},{d:"25",f:"BICP",dep:"16:49",t:"MSOR",tr:"1804"},{d:"25",f:"MSOR",dep:"17:20",t:"BICP",tr:"404"},{d:"25",f:"BICP",dep:"17:49",t:"MSOR",tr:"1804"},{d:"25",f:"MSOR",dep:"19:00",t:"BICP",tr:"402"},{d:"25",f:"BICP",dep:"19:29",t:"MSOR",tr:"1802"},{d:"25",f:"MSOR",dep:"20:30",t:"BICP",tr:"401"},{d:"25",f:"BICP",dep:"20:59",t:"MSOR",tr:"1801"},{d:"25",f:"MSOR",dep:"21:30",t:"BICP",tr:"401"},{d:"25",f:"BICP",dep:"22:01",t:"MSOR",tr:"1801"}
];

const SPECIAL_DUTIES = [
  {code:"CR",label:"CR",type:"simple",base:"CR"},
  {code:"CL",label:"CL",type:"simple",base:"CL"},
  {code:"GH",label:"GH",type:"simple",base:"GH"},
  {code:"RH",label:"RH",type:"simple",base:"RH"},
  {code:"TRAINING",label:"Trng",type:"simple",base:"TRAINING"},
  {code:"GENERAL",label:"Gen",type:"simple",base:"GENERAL"},
  {code:"DCC",label:"DCC",type:"shift",base:"DCC"},
  {code:"OCC",label:"OCC",type:"shift",base:"OCC"},
  {code:"STATION",label:"Station",type:"shift",base:"STN"}
];

const STATION_LIST=["MSOR","NAMT","VKVR","SMNR","RMNR","CLJP","MRSN","SICP","CDPE","CTCP","BICP"];
const NO_DETAIL_SPECIALS=["CL","RH","GH","CR"];

let data = loadData();
if(!data.availableCR) data.availableCR=[];
if(!data.printData) data.printData = { records: {}, profile: {}, pay: {} };
if(!data.alarm) data.alarm = {time: null};

function loadData(){
  const json = localStorage.getItem("dutyTrackerData");
  return json ? JSON.parse(json) : {records:{},profile:{},manualRestDates:{},pay:{}, printData:{ records:{}, profile:{}, pay:{} }, alarm:{time:null} };
}
function saveData(){ localStorage.setItem("dutyTrackerData", JSON.stringify(data)); }

// ----------------- HELPERS -----------------
function todayISO(){ return new Date().toISOString().substring(0,10); }
function formatDateHuman(isoDate){ return new Date(isoDate).toLocaleDateString("en-IN",{weekday:"short",day:"2-digit",month:"short",year:"numeric"}); }
function isNumericDuty(code){ return code!==undefined && !isNaN(code) && String(code).length > 0 && Number(code)>=1 && Number(code)<=26; }
function isShiftDuty(code){ return code && (code.startsWith("DCC-") || code.startsWith("OCC-") || code.startsWith("STN-")); }
function isNoDetailSpecial(code){ return code && NO_DETAIL_SPECIALS.indexOf(code) !== -1; }
function parseTimeHour(t){ return (t && t.length===5) ? parseInt(t.substring(0,2),10) : -1; }

function formatDutyLabel(code, tag, stationCode){
  if(!code) return "";
  let baseText = "";
  let shiftName = "";
  const parts = String(code).split("-");
  if(parts.length>1){
    if(parts[1]==="M") shiftName="Morning";
    if(parts[1]==="E") shiftName="Evening";
    if(parts[1]==="N") shiftName="Night";
  }
  if(isNumericDuty(code)) baseText = `Duty ${code}`;
  else if(["CR","CL","GH","RH"].includes(code)) baseText = code;
  else if(code==="TRAINING") baseText = "Trng";
  else if(code==="GENERAL") baseText = "Gen";
  else if(shiftName) baseText = stationCode ? `${shiftName} @${stationCode}` : shiftName;
  if(tag==="R/S") return `${baseText} (R/S)`;
  if(tag==="R/C") return `${baseText} (R/C)`;
  return baseText;
}

function calculateHDA(code){ return (isNumericDuty(code) && Number(code)>=1 && Number(code)<=26) ? 100 : 0; }
function calculateICE(code, so, sf){
  if(!isNumericDuty(code)) return 0;
  const h1 = parseTimeHour(so), h2 = parseTimeHour(sf);
  if((h1!==-1 && (h1<6 || h1>=22)) || (h2!==-1 && (h2<6 || h2>=22))) return 150;
  return 0;
}
function computeNightHours(code, so, sf){
  if(!code) return 0;
  if(String(code).endsWith("-N")) return 8;
  if(String(code).endsWith("-M") || String(code).endsWith("-E")) return 0;
  if(isNumericDuty(code)){
    const h1 = parseTimeHour(so), h2 = parseTimeHour(sf);
    if((h1!==-1 && h1<6) || (h2!==-1 && h2>=22)) return 1;
  }
  return 0;
}

// ----------------- HEADER LAYOUT -----------------
function updateLayout(){
  const h = $("fixedHeader").offsetHeight;
  // Only add margin to Home Content, others have fixed padding
  if(!$("fixedHeader").classList.contains("hidden")){
     $("homeContent").style.marginTop = (h + 5) + "px";
  } else {
     $("homeContent").style.marginTop = "10px";
  }
}
window.addEventListener("resize", updateLayout);

// ----------------- ALARM & CLOCK LOGIC -----------------
let nextTripTarget = null;
let isAlarmRinging = false;
let audioContext = null;

// Unlock Audio Context on first interaction (FIX FOR NO SOUND)
function unlockAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    // Play a silent buffer to unlock
    const buffer = audioContext.createBuffer(1, 1, 22050);
    const source = audioContext.createSource();
    source.buffer = buffer;
    source.connect(audioContext.destination);
    source.start(0);
  } else if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
  // Remove listener after first interaction
  document.removeEventListener('click', unlockAudio);
  document.removeEventListener('touchstart', unlockAudio);
}

document.addEventListener('click', unlockAudio);
document.addEventListener('touchstart', unlockAudio);

function beep(){
  if(!audioContext) unlockAudio();
  if(!audioContext) return; 
  try {
    const osc = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    osc.type = "square";
    osc.frequency.setValueAtTime(880, audioContext.currentTime); // A5
    osc.frequency.exponentialRampToValueAtTime(440, audioContext.currentTime + 0.1);
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    osc.connect(gainNode);
    gainNode.connect(audioContext.destination);
    osc.start();
    osc.stop(audioContext.currentTime + 0.2);
  } catch(e){ console.error(e); }
}

function triggerAlarm(){
  isAlarmRinging = true;
  const interval = setInterval(beep, 500); // Beep every 500ms
  // Use timeout to avoid infinite loop if user is away
  setTimeout(()=>{
    if(isAlarmRinging && confirm("ALARM: Trip Departing Soon! Click OK to stop.")){
      clearInterval(interval);
      clearAlarm();
    } else {
      clearInterval(interval);
    }
    isAlarmRinging = false;
  }, 100); // Prompt immediately blocks, loop runs in background in some browsers
}

function clearAlarm(){
  data.alarm.time = null;
  saveData();
  $("alarmBtn").classList.remove("active");
  $("alarmBtnText").textContent = "Set Alarm";
  hideAllSheets();
}

function setAlarm(min){
  if(!nextTripTarget){ alert("No next trip found."); return; }
  const trig = new Date(nextTripTarget.getTime() - min*60000);
  data.alarm.time = trig.toISOString();
  saveData();
  $("alarmBtn").classList.add("active");
  $("alarmBtnText").textContent = `${min}m`;
  hideAllSheets();
  alert("Alarm set for " + trig.toLocaleTimeString());
}

// ----------------- NEXT TRIP CALC -----------------
function updateNextTripLogic(){
  const today = new Date().toISOString().substring(0,10);
  const rec = data.records[today];
  
  $("cardActions").style.display = "none";
  $("countdownBox").style.display = "none";
  $("currentDutyBadge").textContent = "No Duty";
  $("nextTripText").textContent = "--";
  nextTripTarget = null;

  if(!rec) return;

  let dText = formatDutyLabel(rec.duty, rec.tag, rec.station);
  $("currentDutyBadge").textContent = dText;

  if(!isNumericDuty(rec.duty)) { updateLayout(); return; }

  // Show actions
  $("cardActions").style.display = "flex";

  // Find next trip
  const now = new Date();
  const curVal = now.getHours()*60 + now.getMinutes();
  const trips = TRIP_DATA.filter(x => x.d === String(rec.duty));
  
  let next = null;
  for(let t of trips){
    const [h,m] = t.dep.split(":").map(Number);
    if((h*60 + m) > curVal){
      next = t;
      break;
    }
  }

  if(next){
    $("nextTripText").innerHTML = `Next: <b>${next.dep}</b> ${next.f}‚Üí${next.t}`;
    $("countdownBox").style.display = "flex";
    
    const tDate = new Date();
    const [th, tm] = next.dep.split(":").map(Number);
    tDate.setHours(th, tm, 0, 0);
    nextTripTarget = tDate;
  } else {
    $("nextTripText").textContent = "All trips completed";
  }
  updateLayout();
}

function startClock(){
  updateNextTripLogic();
  setInterval(()=>{
    const now=new Date();
    $("liveDateTime").textContent = now.toLocaleTimeString("en-IN",{hour12:false,hour:"2-digit",minute:"2-digit"});
    $("liveDate").textContent = now.toLocaleDateString("en-IN",{weekday:"short",day:"2-digit",month:"short"});

    if(nextTripTarget){
      const diff = nextTripTarget - now;
      if(diff > 0){
        const h = Math.floor(diff/3600000);
        const m = Math.floor((diff%3600000)/60000);
        const s = Math.floor((diff%60000)/1000);
        $("countdownTimer").textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      } else {
        $("countdownTimer").textContent = "00:00:00";
        updateNextTripLogic();
      }
    }
    
    if(data.alarm && data.alarm.time && !isAlarmRinging){
      const aTime = new Date(data.alarm.time);
      // Trigger if time passed within last minute
      if(now >= aTime && now < new Date(aTime.getTime() + 60000)) triggerAlarm();
    }
  },1000);
}

// ----------------- NEW RENDERERS (Charts/Summary) -----------------

function renderProfileSummary(){
  const p=data.profile||{};
  $("psName").textContent = p.name || "‚Äî";
  $("psEmpId").textContent = p.empId || "‚Äî";
  $("psRole").textContent = p.role || "‚Äî";
  $("psRest").textContent = p.restDay || "‚Äî";
  $("psCR").textContent = data.availableCR ? data.availableCR.length : 0;
  $("psCL").textContent = p.cl || "‚Äî";
  $("psRH").textContent = p.rh || "‚Äî";
  $("psConf").textContent = p.confirmDate || "‚Äî";
  $("psPME").textContent = p.pmeDate || "‚Äî";
  
  if(p.name){
    $("profileTitle").textContent = `Hello, ${p.name.split(" ")[0]}`;
    $("profileAvatar").textContent = p.name[0].toUpperCase();
    if(p.photo) $("profileAvatar").style.backgroundImage=`url(${p.photo})`;
  }
}

function renderCurrentTrips(){
  const today = new Date().toISOString().substring(0,10);
  const rec = data.records[today];
  const tb = $("currentDutyTripsBody"); tb.innerHTML="";
  if(!rec || !isNumericDuty(rec.duty)) return;

  const trips = TRIP_DATA.filter(x=>x.d===String(rec.duty));
  const now = new Date();
  const curVal = now.getHours()*60 + now.getMinutes();
  
  let foundNext = false;
  trips.forEach(t=>{
    const [h,m] = t.dep.split(":").map(Number);
    const tVal = h*60+m;
    const tr = document.createElement("tr");
    if(tVal > curVal && !foundNext){
      tr.className = "current-trip-row";
      foundNext = true;
    }
    tr.innerHTML=`<td><b>${t.dep}</b></td><td>${t.f}</td><td>${t.t}</td><td>${t.tr}</td>`;
    tb.appendChild(tr);
  });
}

// TRIP CHART SECTION LOGIC
let tripChartFilter = "1";

function renderTripSection(){
  // Render Chips 1-26
  const c = $("tripFilterChips");
  if(c.innerHTML === "") {
    for(let i=1; i<=26; i++) {
      // Skip missing numbers if any, based on DUTY_TABLE or just numeric
      if([7,13,14,21].includes(i)) continue; // Gaps in original data provided
      const chip = document.createElement("div");
      chip.className = "trip-chip" + (String(i)===tripChartFilter ? " active" : "");
      chip.textContent = i;
      chip.onclick = () => {
        tripChartFilter = String(i);
        document.querySelectorAll(".trip-chip").forEach(el => el.classList.remove("active"));
        chip.classList.add("active");
        renderTripTable();
      };
      c.appendChild(chip);
    }
  }
  renderTripTable();
}

function renderTripTable(){
  const tb = $("tripChartBody"); tb.innerHTML="";
  const filtered = TRIP_DATA.filter(x => x.d === tripChartFilter);
  if(filtered.length === 0){
    tb.innerHTML = "<tr><td colspan='5' style='text-align:center;padding:1rem;'>No trips found for Duty "+tripChartFilter+"</td></tr>";
    return;
  }
  filtered.forEach(r=>{
    tb.innerHTML+=`<tr><td>${r.d}</td><td>${r.dep}</td><td>${r.f}</td><td>${r.t}</td><td>${r.tr}</td></tr>`;
  });
}

// ----------------- HANDLERS -----------------

let profileExpanded=false;
function renderProfile(){
  const p=data.profile||{};
  $("pfName").value = p.name || "";
  $("pfEmpId").value = p.empId || "";
  $("pfRole").value = p.role || "";
  $("pfRest").value = p.restDay || "";
  $("pfConfirmDate").value = p.confirmDate || "";
  $("pfPmeDate").value = p.pmeDate || "";
  $("pfCL").value = p.cl || "";
  $("pfRH").value = p.rh || "";
}

function attachProfileHandlers(){
  $("saveProfileBtn").addEventListener("click", ()=>{
    data.profile={
      name:$("pfName").value.trim(), empId:$("pfEmpId").value.trim(), role:$("pfRole").value,
      restDay:$("pfRest").value, confirmDate:$("pfConfirmDate").value, pmeDate:$("pfPmeDate").value,
      cl:$("pfCL").value, rh:$("pfRH").value
    };
    data.printData.profile = { name: data.profile.name || "", empId: data.profile.empId || "", confirmDate: data.profile.confirmDate || "" };
    saveData(); renderProfileSummary(); alert("Profile saved!");
  });
  $("pfPhoto").addEventListener("change", e=>{
    const f=e.target.files[0], r=new FileReader();
    if(f) { r.onload=ev=>{ data.profile.photo=ev.target.result; saveData(); renderProfileSummary(); }; r.readAsDataURL(f); }
  });
}

let currentTab="home", openHistoryDate=null;
function setActiveTab(id){
  currentTab=id;
  document.querySelectorAll(".screen").forEach(el=>el.classList.toggle("active",el.id===id));
  document.querySelectorAll(".nav-item").forEach(el=>el.classList.toggle("active",el.dataset.tab===id));
  
  // Toggle Header based on tab
  if(id === "home"){
    $("fixedHeader").classList.remove("hidden");
    $("fabBtn").style.display = "flex";
  } else {
    $("fixedHeader").classList.add("hidden");
    $("fabBtn").style.display = "none";
  }
  updateLayout(); // Recalculate margins

  hideAllSheets();
  $("historySearchBar").style.display = id==="history"?"block":"none";
  if(id==="history") renderHistory();
  if(id==="trips") renderTripSection();
  if(id==="home") setTimeout(updateNextTripLogic, 50); 
}

function attachNav(){
  document.querySelectorAll(".nav-item").forEach(el=>el.addEventListener("click", ()=>setActiveTab(el.dataset.tab)));
}

// App state
let selectedLogDate=todayISO(), selectedDutyCode=null, selectedTrains=[], specialDutyOpen=false;
let expandedDate=null, restEditMode=null, pendingRestOldDate=null;
let selectedStation=null, selectedShiftCode=null;
let selectedPayMonth=String(new Date().getMonth()+1).padStart(2,"0");
let logMonthYear={year:new Date().getFullYear(), month:new Date().getMonth()};
let currentMonthYear={year:new Date().getFullYear(), month:new Date().getMonth()};

function showOverlay(){ $("overlay").style.display="block"; }
function hideAllSheets(){
  $("overlay").style.display="none";
  document.querySelectorAll(".sheet").forEach(s => s.style.display="none");
  restEditMode=null; pendingRestOldDate=null;
}

// Inline station chips logic
function renderInlineStationChips(){
  const c=$("inlineStationChips"); c.innerHTML="";
  STATION_LIST.forEach(code=>{
    const b=document.createElement("button"); b.className="train-btn"; b.textContent=code; b.dataset.station=code;
    if(selectedStation===code) b.classList.add("active");
    b.addEventListener("click", e=>{
      e.preventDefault(); selectedStation=code;
      c.querySelectorAll(".train-btn").forEach(x=>x.classList.toggle("active", x.dataset.station===code));
      updateDutyChipStates();
    });
    c.appendChild(b);
  });
}

// Duty selection logic
function handleDutySelection(dNo){
  selectedDutyCode=dNo; selectedTrains=[];
  const isShift = (dNo==="DCC"||dNo==="OCC"||dNo==="STN");
  $("inlineShiftStationSelector").style.display = isShift ? "block" : "none";
  $("trainField").style.display = (isNumericDuty(dNo)) ? "block" : "none";
  if(isShift){
    const r = data.records[selectedLogDate];
    if(r && r.duty && r.duty.startsWith(dNo)){
      selectedShiftCode = r.duty.split("-")[1] || null;
      selectedStation = r.station || null;
    } else { selectedShiftCode = null; selectedStation = null; }
    document.querySelectorAll("#shiftChips button").forEach(b=>b.classList.toggle("active", b.dataset.shift===selectedShiftCode));
    if(dNo==="STN"){ $("stationSelector").style.display="block"; renderInlineStationChips(); }
    else { $("stationSelector").style.display="none"; }
  } else { selectedStation = null; selectedShiftCode = null; }
  updateDutyChipStates(); updateSpecialDutyStates();
}

function showFabLog(){
  showOverlay(); $("logSheet").style.display="block";
  renderLogMonthSelect(); renderLogDateChips(); renderDutyButtons();
  renderSpecialDutyButtons(); renderTrainButtons();
  $("inlineShiftStationSelector").style.display="none"; $("trainField").style.display="none";
  selectedDutyCode=null; selectedTrains=[]; selectedStation=null; selectedShiftCode=null;
}

function showLogSheetFor(iso, rTag){
  selectedLogDate=iso;
  if(rTag==="R/S"){
    if(!data.availableCR) data.availableCR=[];
    data.availableCR.push(iso); saveData();
    restEditMode=null; pendingRestOldDate=null;
    showFabLog(); return;
  }
  const rec=data.records[iso];
  if(rec){
    selectedTrains=rec.trains||[];
    if(isShiftDuty(rec.duty)){
      const p=rec.duty.split("-"); selectedDutyCode=p[0]; selectedShiftCode=p[1]; selectedStation=rec.station||null;
    } else { selectedDutyCode=rec.duty; selectedShiftCode=null; selectedStation=null; }
  } else { selectedDutyCode=null; selectedTrains=[]; selectedShiftCode=null; selectedStation=null; }
  if(rTag){
    restEditMode=rTag; pendingRestOldDate=iso;
    showOverlay(); $("restSheet").style.display="block"; $("restDateInput").value=iso;
    return;
  }
  restEditMode=null; pendingRestOldDate=null;
  showOverlay(); $("logSheet").style.display="block";
  renderLogMonthSelect(); renderLogDateChips(); renderDutyButtons(); renderSpecialDutyButtons();
  renderTrainButtons(); $("trainField").style.display=(selectedDutyCode&&isNumericDuty(selectedDutyCode))?"block":"none";
  const isShiftNow = (selectedDutyCode==="DCC"||selectedDutyCode==="OCC"||selectedDutyCode==="STN");
  $("inlineShiftStationSelector").style.display=isShiftNow?"block":"none";
  if(isShiftNow){
    renderInlineStationChips();
    document.querySelectorAll("#shiftChips button").forEach(b=>b.classList.toggle("active",b.dataset.shift===selectedShiftCode));
    if(selectedDutyCode==="STN") $("stationSelector").style.display="block"; else $("stationSelector").style.display="none";
  }
}

// Attach Listeners
function attachFabAndSheets(){
  $("fabBtn").addEventListener("click", showFabLog);
  $("overlay").addEventListener("click", hideAllSheets);
  document.querySelectorAll(".sheet-close").forEach(b=>b.addEventListener("click", hideAllSheets));
  
  $("viewDutyTableBtn").addEventListener("click", ()=>{ showOverlay(); $("dutyTableSheet").style.display="block"; });
  $("configPayBtn").addEventListener("click", ()=>{ showOverlay(); $("paySheet").style.display="block"; renderPayMonthChips(); });
  $("viewProfileSummaryBtn").addEventListener("click", ()=>{ renderProfileSummary(); showOverlay(); $("profileSummarySheet").style.display="block"; });
  $("viewCurrentTripsBtn").addEventListener("click", ()=>{ renderCurrentTrips(); showOverlay(); $("currentDutyTripsSheet").style.display="block"; });
  $("alarmBtn").addEventListener("click", ()=>{ showOverlay(); $("alarmSheet").style.display="block"; });

  document.querySelectorAll(".alarm-option").forEach(el => {
    el.addEventListener("click", function(){
      if(this.id==="turnOffAlarmBtn") clearAlarm();
      else setAlarm(parseInt(this.dataset.min));
    });
  });

  document.querySelectorAll("#shiftChips button").forEach(b => b.addEventListener("click", e=>{
    e.preventDefault();
    document.querySelectorAll("#shiftChips button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); selectedShiftCode=b.dataset.shift;
  }));

  $("saveRestDateBtn").addEventListener("click", ()=>{
    const val=$("restDateInput").value;
    if(!val){ alert("Select date"); return; }
    if(data.records[val]){ alert("Date has duty"); return; }
    if(restEditMode==="R/C" && pendingRestOldDate){
      data.records[pendingRestOldDate]={duty:"CR",tag:"R/C",trains:[],station:null};
      data.manualRestDates[val]=true;
      if(data.manualRestDates[pendingRestOldDate]) delete data.manualRestDates[pendingRestOldDate];
      updatePrintRecord(pendingRestOldDate);
    } else if(restEditMode==="R/S" && pendingRestOldDate){
      data.records[pendingRestOldDate]={duty:"CR",tag:"R/S",trains:[],station:null};
      updatePrintRecord(pendingRestOldDate);
    } else { data.manualRestDates[val]=true; }
    saveData(); hideAllSheets(); renderCalendar(); if(currentTab==="history") renderHistory();
  });

  $("savePayBtn").addEventListener("click", ()=>{
    const amt=Number($("payAmountInput").value);
    if(amt<0 || isNaN(amt)){ alert("Invalid amount"); return; }
    data.pay[selectedPayMonth]=amt;
    data.printData.pay[selectedPayMonth] = amt;
    saveData(); hideAllSheets(); if(currentTab==="history") renderHistory();
  });

  $("saveDutyBtn").addEventListener("click", ()=>{
    if(!selectedDutyCode){ alert("Select duty"); return; }
    let code = selectedDutyCode; let st = null;
    if(code === "DCC" || code === "OCC"){
      if(!selectedShiftCode){ alert("Select shift"); return; }
      code = `${code}-${selectedShiftCode}`; st = null;
    } else if(code === "STN"){
      if(!selectedShiftCode){ alert("Select shift"); return; }
      if(!selectedStation){ alert("Select station"); return; }
      code = `STN-${selectedShiftCode}`; st = selectedStation;
    } else if(isNumericDuty(code)){
      if(selectedTrains.length===0){ alert("Select train"); return; }
      st = null;
    } else { st = null; }

    data.records[selectedLogDate] = { duty: code, tag: null, trains: isNumericDuty(code) ? selectedTrains.slice() : [], station: st };
    if(restEditMode==="R/S" && pendingRestOldDate){
      if(!data.availableCR) data.availableCR=[];
      data.availableCR.push(pendingRestOldDate);
      if(data.records[pendingRestOldDate] && data.records[pendingRestOldDate].duty==="CR") delete data.records[pendingRestOldDate];
      updatePrintRecord(pendingRestOldDate);
    }
    if(data.manualRestDates[selectedLogDate]) delete data.manualRestDates[selectedLogDate];
    updatePrintRecord(selectedLogDate);
    saveData(); hideAllSheets(); renderCalendar(); if(currentTab==="history") renderHistory();
    updateNextTripLogic();
  });

  $("specialDutyToggle").addEventListener("click", (e)=>{
    e.preventDefault(); specialDutyOpen=!specialDutyOpen; renderSpecialDutyButtons();
  });
}

// Pay chips
function renderPayMonthChips(){
  const c=$("payMonthChips"), names=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  c.innerHTML="";
  names.forEach((nm,i)=>{
    const m=String(i+1).padStart(2,"0"), d=document.createElement("div");
    d.className="date-chip"+(selectedPayMonth===m?" active":"");
    d.innerHTML=`<span class="date-chip-label">${nm}</span><span class="date-chip-secondary">${data.pay[m]?`‚Çπ${data.pay[m]}`:"Set"}</span>`;
    d.addEventListener("click", ()=>{
      selectedPayMonth=m; renderPayMonthChips();
      $("payAmountInput").value=data.pay[m]||""; $("payInputLabel").textContent=`Pay for One Day in ${nm} (‚Çπ)`;
    });
    c.appendChild(d);
  });
}

// Log Month/Date chips
function renderLogMonthSelect(){
  const s=$("logMonthSelect"); s.innerHTML="";
  for(let m=0;m<12;m++){
    const o=document.createElement("option"); o.value=`${logMonthYear.year}-${String(m+1).padStart(2,"0")}`;
    o.textContent=new Date(logMonthYear.year,m,1).toLocaleDateString("en-IN",{month:"short",year:"numeric"});
    if(m===logMonthYear.month) o.selected=true; s.appendChild(o);
  }
  s.onchange=function(){ const p=this.value.split("-"); logMonthYear.year=Number(p[0]); logMonthYear.month=Number(p[1])-1; renderLogDateChips(); };
}
function renderLogDateChips(){
  const c=$("dateChips"), y=logMonthYear.year, m=logMonthYear.month, dim=new Date(y,m+1,0).getDate(), frag=document.createDocumentFragment();
  c.innerHTML="";
  for(let i=1;i<=dim;i++){
    const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const r=data.records[iso];
    const txt=r?formatDutyLabel(r.duty,r.tag,r.station):(data.manualRestDates[iso]?"REST":"");
    const d=document.createElement("div");
    d.className=`date-chip${selectedLogDate===iso?" active":""}${iso===todayISO()?" today-chip":""}`;
    d.innerHTML=`<span class="date-chip-label">${i}</span><span class="date-chip-secondary">${new Date(y,m,i).toLocaleDateString("en-IN",{weekday:"short"})} ${txt}</span>`;
    d.onclick=()=>{
      selectedLogDate=iso; renderLogDateChips();
      if(data.records[iso]) showLogSheetFor(iso,null);
      else {
        selectedDutyCode=null; selectedTrains=[]; selectedStation=null; selectedShiftCode=null;
        updateDutyChipStates(); updateSpecialDutyStates(); $("trainField").style.display="none"; $("inlineShiftStationSelector").style.display="none";
      }
    };
    frag.appendChild(d);
  }
  c.appendChild(frag);
}

// Duty/Train Buttons
function renderDutyButtons(){
  const c=$("dutyButtons"); c.innerHTML="";
  [ ["1","2","3","4","5","6","8","9","10","11","12"], ["15","16","17","18","19","20","22","23","24","25","26"] ].forEach(grp=>{
    const r=document.createElement("div"); r.className="duty-row";
    grp.forEach(no=>{
      const b=document.createElement("button"); b.className="duty-btn"; b.textContent=no; b.dataset.no=no;
      b.onclick=e=>{ e.preventDefault(); handleDutySelection(no); updateTrainButtonStates(); };
      r.appendChild(b);
    });
    c.appendChild(r);
  });
  updateDutyChipStates();
}
function updateDutyChipStates(){
  document.querySelectorAll("#dutyButtons .duty-btn").forEach(b=>{
    const no=b.dataset.no, act=isNumericDuty(no)?(selectedDutyCode===no):(selectedDutyCode && selectedDutyCode.split("-")[0]===no);
    b.classList.toggle("active", act);
  });
  if($("inlineShiftStationSelector").style.display==="block") renderInlineStationChips();
}
function renderSpecialDutyButtons(){
  const c=$("specialDutyContainer"); c.innerHTML="";
  if(!specialDutyOpen){ c.style.display="none"; return; }
  c.style.display="block";
  const r=document.createElement("div"); r.className="special-duty-row";
  SPECIAL_DUTIES.forEach(s=>{
    const b=document.createElement("button"); b.className="special-duty-btn"; b.textContent=s.label; b.dataset.base=s.base;
    b.onclick=e=>{
      e.preventDefault();
      if(s.code==="CR"){ openCRConsumeModal(); return; }
      handleDutySelection(s.base); updateDutyChipStates(); updateSpecialDutyStates();
    };
    r.appendChild(b);
  });
  c.appendChild(r); updateSpecialDutyStates();
}
function updateSpecialDutyStates(){
  document.querySelectorAll(".special-duty-btn").forEach(b=>{
    let act=false;
    if(selectedDutyCode && !isNumericDuty(selectedDutyCode) && selectedDutyCode.split("-")[0]===b.dataset.base) act=true;
    b.classList.toggle("active", act);
  });
}
function renderTrainButtons(){
  const c=$("trainButtons"); c.innerHTML="";
  for(let i=1;i<=10;i++){
    const b=document.createElement("button"); b.className="train-btn"; b.textContent=i; b.dataset.no=i;
    b.onclick=e=>{
      e.preventDefault(); const idx=selectedTrains.indexOf(String(i));
      if(idx>-1) selectedTrains.splice(idx,1); else selectedTrains.push(String(i));
      selectedTrains.sort((a,b)=>Number(a)-Number(b)); updateTrainButtonStates();
    };
    c.appendChild(b);
  }
  updateTrainButtonStates();
}
function updateTrainButtonStates(){
  document.querySelectorAll("#trainButtons .train-btn").forEach(b=>b.classList.toggle("active",selectedTrains.includes(b.dataset.no)));
}

// Print Data builder
function buildFinalPrintRecord(date, rec){
  if(!rec) return null;
  const out = { date: date };
  const dutyCode = rec.duty || "";
  out.duty = dutyCode;
  const di = DUTY_TABLE[dutyCode] || DUTY_TABLE[dutyCode.split("-")[0]] || null;
  let signOn = di && di.signOn ? di.signOn : "‚Äî";
  let signOff = di && di.signOff ? di.signOff : "‚Äî";
  let onPlace = di && di.onPlace ? di.onPlace : "‚Äî";
  let offPlace = di && di.offPlace ? di.offPlace : "‚Äî";
  let dutyHours = di && di.hours ? di.hours : "‚Äî";
  if(rec.station && typeof onPlace === "string"){
    onPlace = onPlace.replace(/STATION|DCC|OCC/g, rec.station);
    offPlace = offPlace.replace(/STATION|DCC|OCC/g, rec.station);
  }
  if(isNoDetailSpecial(String(dutyCode).split("-")[0])){ signOn = "‚Äî"; signOff = "‚Äî"; dutyHours = "‚Äî"; }
  const nightHours = (signOn==="‚Äî" || signOff==="‚Äî") ? 0 : computeNightHours(dutyCode, signOn, signOff);
  const trains = (rec.trains && rec.trains.length>0) ? rec.trains.slice().map(String).sort((a,b)=>Number(a)-Number(b)) : [];
  let shift = null;
  if(String(dutyCode).includes("-")){ shift = dutyCode.split("-")[1] || null; }
  out.signOnTime = signOn; out.signOffTime = signOff; out.dutyHours = dutyHours;
  out.nightDutyHours = Number(nightHours); out.signOnPlace = onPlace; out.signOffPlace = offPlace;
  out.trains = trains; out.shift = shift;
  out.dutyType = isNoDetailSpecial(String(dutyCode).split("-")[0]) ? String(dutyCode).split("-")[0] : (String(dutyCode).split("-")[0] || dutyCode);
  out.station = rec.station || null;
  return out;
}
function updatePrintRecord(date){
  data.printData = data.printData || { records:{}, profile:{}, pay:{} };
  const rec = data.records[date];
  if(!rec){ if(data.printData.records && data.printData.records[date]) delete data.printData.records[date]; return; }
  const built = buildFinalPrintRecord(date, rec);
  if(built) data.printData.records[date] = built;
}

// Calendar
function renderCalendar(){
  const c=$("calendarRow"), y=currentMonthYear.year, m=currentMonthYear.month;
  c.innerHTML="";
  const dim=new Date(y,m+1,0).getDate(), today=todayISO(), frag=document.createDocumentFragment();
  const restIdx=data.profile.restDay ? ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].indexOf(data.profile.restDay) : -1;
  let todayEl=null;
  
  // Loop backwards for Descending order (31 -> 1)
  for(let i=dim;i>=1;i--){
    const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const rec=data.records[iso];
    const dow=new Date(y,m,i).getDay();
    let isRest = (restIdx>-1 && dow===restIdx) || (data.manualRestDates && data.manualRestDates[iso]);
    if(rec && rec.tag && (rec.tag==="R/S"||rec.tag==="R/C")) isRest=true; else if(rec) isRest=false;
    
    const ch=document.createElement("div"); ch.className="timeline-chip"; ch.dataset.date=iso;
    const isToday=(iso===today);
    if(isToday) ch.classList.add("today-chip");
    else if(iso>today && (new Date(today).getFullYear()===y && new Date(today).getMonth()===m)) ch.classList.add("future-chip");
    
    let top=`<div class="timeline-chip-top"><span class="${isToday?'today-label-text':''}">${isToday?`TODAY ${String(i).padStart(2,"0")}<span class='today-icon'>‚ö°</span>`:new Date(y,m,i).toLocaleDateString("en-IN",{weekday:"short"})+' '+String(i).padStart(2,"0")}</span><span style="font-weight:700;font-size:0.8rem;">${rec?formatDutyLabel(rec.duty,rec.tag,rec.station):(isRest?"REST":"")}</span></div>`;
    let bot=`<div class="timeline-chip-bottom">${rec?"Tap to view or edit":(isRest?"Weekly rest day ‚Äì tap to edit":"Tap to add duty")}</div>`;
    
    if(rec) ch.classList.add("has-duty");
    if(isRest && !rec) ch.classList.add("rest-chip");
    if(rec && isRest) ch.classList.add("rest-chip-duty");
    ch.innerHTML = top + bot + '<div class="date-expand" style="display:none"></div>';
    ch.onclick=()=>handleDateClick(iso);
    frag.appendChild(ch);
    if(isToday) todayEl=ch;
  }
  c.appendChild(frag);
  $("noDutiesMsg").style.display=Object.keys(data.records).length===0?"block":"none";
  
  // Scroll to Today (Top of screen logic)
  if(todayEl) {
    // Wait for DOM paint then scroll
    setTimeout(() => {
       todayEl.scrollIntoView({behavior:'auto', block:'start'}); 
    }, 50);
  }
}

function handleDateClick(iso){
  const ch=document.querySelector(`.timeline-chip[data-date="${iso}"]`);
  if(expandedDate && expandedDate!==iso){
    const p=document.querySelector(`.timeline-chip[data-date="${expandedDate}"]`);
    if(p){ p.classList.remove("active"); p.querySelector(".date-expand").style.display="none"; }
  }
  if(expandedDate===iso){ expandedDate=null; ch.classList.remove("active"); ch.querySelector(".date-expand").style.display="none"; return; }
  expandedDate=iso; ch.classList.add("active");
  const ex=ch.querySelector(".date-expand"); ex.style.display="block"; ex.innerHTML="";
  const rec=data.records[iso];
  if(rec){
    const d=DUTY_TABLE[rec.duty]||{};
    let op=d.onPlace||"‚Äî", fp=d.offPlace||"‚Äî";
    if(rec.station){ op=op.replace(/STATION|DCC|OCC/g,rec.station); fp=fp.replace(/STATION|DCC|OCC/g,rec.station); }
    ex.innerHTML=`<div class="expand-block"><div><strong>${formatDateHuman(iso)}</strong></div><div>Duty: ${formatDutyLabel(rec.duty,rec.tag,rec.station)}</div><button class="edit-btn">Edit Duty</button></div>`;
    ex.querySelector(".edit-btn").onclick=e=>{ e.stopPropagation(); showLogSheetFor(iso,null); };
  } else if(ch.classList.contains("rest-chip")){
    ex.innerHTML=`<div class="expand-block"><div><strong>${formatDateHuman(iso)}</strong></div><div>Scheduled Weekly Rest</div><div class="rest-actions"><button class="rest-btn rest-btn-rs" title="Rest Suspended">R/S</button><button class="rest-btn rest-btn-rc" title="Rest Changed">R/C</button></div></div>`;
    ex.querySelector(".rest-btn-rs").onclick=e=>{ e.stopPropagation(); showLogSheetFor(iso,"R/S"); };
    ex.querySelector(".rest-btn-rc").onclick=e=>{ e.stopPropagation(); showLogSheetFor(iso,"R/C"); };
  } else { showLogSheetFor(iso,null); }
}

// History
let historyFilterMonth="all";
function renderHistoryMonthChips(){
  const c=$("historyMonthChips"), dates=Object.keys(data.records).sort().reverse();
  const months=[...new Set(dates.map(d=>d.substring(0,7)))];
  c.innerHTML=`<div class="history-month-chip${historyFilterMonth==='all'?' active':''}">All</div>`;
  c.firstChild.onclick=()=>{ historyFilterMonth="all"; renderHistory(); };
  months.forEach(m=>{
    const d=document.createElement("div");
    d.className=`history-month-chip${historyFilterMonth===m?' active':''}`;
    d.textContent=new Date(m.split("-")[0], m.split("-")[1]-1, 1).toLocaleDateString("en-IN",{month:"short",year:"numeric"});
    d.onclick=()=>{ historyFilterMonth=m; renderHistory(); };
    c.appendChild(d);
  });
}
function renderHistory(){
  renderHistoryMonthChips();
  const term=$("historySearchInput").value.toLowerCase().trim();
  let dates=Object.keys(data.records).sort().reverse();
  if(historyFilterMonth!=="all") dates=dates.filter(d=>d.startsWith(historyFilterMonth));
  if(term) dates=dates.filter(d=>{
    const r=data.records[d], dt=DUTY_TABLE[r.duty]||{};
    return d.includes(term) || (r.duty||"").toLowerCase().includes(term) || (r.trains||[]).join(",").includes(term) ||
           (dt.onPlace||"").toLowerCase().includes(term) || (dt.offPlace||"").toLowerCase().includes(term) ||
           (r.station||"").toLowerCase().includes(term) || ["cl","gh","rh","cr"].includes(term) && r.duty.toLowerCase()===term;
  });
  const sum={tot:0,cr:0,cl:0,gh:0,rh:0,hda:0,ice:0,nh:0,nda:0,ndays:0};
  dates.forEach(d=>{
    const r=data.records[d], di=DUTY_TABLE[r.duty]||{};
    sum.tot++; if(r.duty==="CR") sum.cr++; else if(r.duty==="CL") sum.cl++; else if(r.duty==="GH") sum.gh++; else if(r.duty==="RH") sum.rh++;
    sum.hda+=calculateHDA(r.duty); sum.ice+=calculateICE(r.duty,di.signOn,di.signOff); sum.nh+=computeNightHours(r.duty,di.signOn,di.signOff);
  });
  const mPay=(historyFilterMonth!=="all" && data.pay[historyFilterMonth.split("-")[1]]) || null;
  if(mPay){ sum.ndays=sum.nh/24; sum.nda=sum.ndays*mPay; }
  const totAll=sum.hda+sum.ice+(sum.nda||0);

  const hs=$("historySummary"); hs.innerHTML="";
  if(dates.length>0){
    const add=(t,v,s)=>hs.innerHTML+=`<div class="history-summary-card"><div class="history-summary-label">${t}</div><div class="history-summary-value">${v}</div>${s?`<div class="history-summary-sub">${s}</div>`:""}</div>`;
    add("Total Duties",sum.tot,`CR: ${sum.cr}, CL: ${sum.cl}, GH: ${sum.gh}, RH: ${sum.rh}`);
    add("Night Hours (A)",sum.nh.toFixed(1)+" hrs",null);
    add("ICE",`‚Çπ ${sum.ice}`,null);
    add("HDA",`‚Çπ ${sum.hda}`,null);
    add("NDA",sum.nda!==null?`‚Çπ ${sum.nda.toFixed(0)}`:"‚Äî", sum.nda!==null?`Night Days: ${sum.ndays.toFixed(1)}`:"1-day pay not set or 'All'");
    add("Total Allowance",`‚Çπ ${totAll.toFixed(0)}`,null);
  }
  const l=$("historyList"); l.innerHTML="";
  $("noHistoryMsg").style.display=dates.length===0?"block":"none";
  const frag=document.createDocumentFragment();
  dates.forEach(d=>{
    const r=data.records[d], di=DUTY_TABLE[r.duty]||{}, hda=calculateHDA(r.duty), ice=calculateICE(r.duty,di.signOn,di.signOff), nh=computeNightHours(r.duty,di.signOn,di.signOff);
    let op=di.onPlace||"‚Äî", fp=di.offPlace||"‚Äî";
    if(r.station){ op=op.replace(/STATION|DCC|OCC/g,r.station); fp=fp.replace(/STATION|DCC|OCC/g,r.station); }
    const item=document.createElement("div"); item.className=`history-item${openHistoryDate===d?' active':''}`;
    item.onclick=()=>{ openHistoryDate=(openHistoryDate===d)?null:d; renderHistory(); };
    let meta="";
    if(!isShiftDuty(r.duty) && !isNoDetailSpecial(r.duty)) meta=`<div class="history-meta">${di.signOn||'‚Äî'} @ ${op} ‚Äì ${di.signOff||'‚Äî'} @ ${fp} (${di.hours||'‚Äî'})</div>`;
    item.innerHTML=`<div class="history-header"><span>${formatDateHuman(d)}</span><span>${formatDutyLabel(r.duty,r.tag,r.station)}</span></div>${meta}
    <div class="history-detail" style="display:${openHistoryDate===d?'block':'none'}">
      <div>Hours: ${di.hours||'‚Äî'}</div><div>Trains: ${(r.trains||[]).join(", ")||'None'}</div>
      <div>HDA: ‚Çπ${hda}</div><div>ICE: ‚Çπ${ice}</div><div>Night Hrs: ${nh}</div>
      <button class="edit-btn" style="position:static;margin-top:.4rem;float:right">Edit Duty</button>
    </div>`;
    item.querySelector(".edit-btn").onclick=e=>{ e.stopPropagation(); showLogSheetFor(d,null); };
    frag.appendChild(item);
  });
  l.appendChild(frag);
}
$("historySearchInput").addEventListener("input", renderHistory);

// CR Modal
function openCRConsumeModal(){
  if(!data.availableCR || data.availableCR.length===0){ alert("No available CR"); return; }
  showOverlay(); $("crConsumeModal").style.display="block";
  const c=$("crList"); c.innerHTML="";
  data.availableCR.forEach(date=>{
    const d=document.createElement("div"); d.className="date-chip"; d.dataset.date=date;
    d.innerHTML=`<span class="date-chip-label">${date.substring(8)}</span><span class="date-chip-secondary">${formatDateHuman(date)}</span>`;
    d.onclick=()=>{ c.querySelectorAll(".date-chip").forEach(x=>x.classList.remove("active")); d.classList.add("active"); };
    c.appendChild(d);
  });
}
function closeCRConsumeModal(){ hideOverlay(); $("crConsumeModal").style.display="none"; }
$("useCRBtn").addEventListener("click", ()=>{
  const ch=document.querySelector("#crList .date-chip.active");
  if(!ch){ alert("Select a CR"); return; }
  const crDate=ch.dataset.date;
  data.records[selectedLogDate]={duty:"CR", tag:null, trains:[], station:null};
  updatePrintRecord(selectedLogDate);
  data.availableCR=data.availableCR.filter(d=>d!==crDate);
  saveData(); closeCRConsumeModal(); renderCalendar(); if(currentTab==="history") renderHistory();
});

// Duty Table
function renderDutyTableFull(){
  const tb=$("dutyTableBody"); tb.innerHTML="";
  const add=(k)=>{
    const d=DUTY_TABLE[k], tr=document.createElement("tr");
    tr.innerHTML=`<td>${k}</td><td>${d.signOn||""}</td><td>${d.onPlace||""}</td><td>${d.signOff||""}</td><td>${d.offPlace||""}</td><td>${d.hours||""}</td>`;
    tb.appendChild(tr);
  }
  const tr1=document.createElement("tr"); tr1.innerHTML="<th colspan='6'>Standard Duties (1‚Äì26)</th>"; tb.appendChild(tr1);
  Object.keys(DUTY_TABLE).filter(k=>isNumericDuty(k)).sort((a,b)=>Number(a)-Number(b)).forEach(add);
  const tr2=document.createElement("tr"); tr2.innerHTML="<th colspan='6'>Special Duties</th>"; tb.appendChild(tr2);
  Object.keys(DUTY_TABLE).filter(k=>!isNumericDuty(k)).sort().forEach(add);
}

// Init
document.addEventListener("DOMContentLoaded", ()=>{
  startClock(); renderProfile(); attachProfileHandlers(); attachNav(); attachFabAndSheets();
  renderDutyTableFull(); renderProfileSummary();
  const s=$("monthSelect"); const by=new Date().getFullYear();
  for(let m=0;m<12;m++){
    const o=document.createElement("option"); o.value=m;
    o.textContent=new Date(by,m,1).toLocaleDateString("en-IN",{month:"long"});
    if(m===currentMonthYear.month) o.selected=true; s.appendChild(o);
  }
  s.onchange=function(){ currentMonthYear.month=Number(this.value); renderCalendar(); };
  renderCalendar();
  updateLayout();
  if(data.alarm && data.alarm.time){
    $("alarmBtn").classList.add("active");
    $("alarmBtnText").textContent = "Alarm Set";
  }
});
</script>
</body>
</html>