<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Incidental Contingent Expenditure</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* 1. Ultra Compact Vertical Fit */
@page { size: A4; margin: 5mm; }
html, body { margin: 0; padding: 0; background: #fff; }
body { 
    width: 210mm; 
    transform: scale(0.72); 
    transform-origin: top center; 
    margin: 0 auto; 
    font-family: "Times New Roman", serif; 
}
.page { width:760px; margin:0 auto; padding:0; }

/* 2. Header */
.logo { text-align:center; margin-bottom:2px; }
.logo img { width:65px; height:auto; }
h1 { text-align:center; font-size:16px; margin:2px 0; text-transform: uppercase; font-weight:bold; }
.sub { text-align:center; font-size:10px; margin-bottom:4px; }

/* 3. Tables */
table { border-collapse:collapse; width:100%; table-layout:fixed; margin-top:4px; }
th, td { border:1px solid #000; padding:2px 3px; font-size:10px; text-align:center; vertical-align:middle; }
.meta th { background: #f0f0f0; }
.duty th { font-weight:bold; background: #f0f0f0; }
.total-row td { font-weight: bold; border-top: 2px solid #000; background: #fff; }

/* 4. Certificate */
.cert-section { margin-top: 8px; font-size: 10px; line-height: 1.2; }
.cert-title { text-align:center; font-weight:bold; text-decoration:underline; font-size:11px; margin-bottom:4px; }
.to-sig-row { margin-top: 10px; overflow: hidden; }
.to-sig-box { float: right; width: 200px; text-align: center; }

/* 5. Manager & Footer */
.manager-row { margin-top: 10px; overflow: hidden; }
.sanction-block { float: left; width: 45%; }
.manager-to-block { float: right; width: 30%; text-align: center; margin-top: 20px; }
.footer-note { margin-top: 8px; font-weight: bold; font-size: 10px; clear: both; }
</style>
</head>
<body>
<div class="page">
  <div class="logo"><img src="jaipur_logo.png" alt="JMRC Logo"></div>
  <h1>Incidental Contingent Expenditure</h1>
  <div class="sub">(Compensatory Conveyance Hire Charges fixed @ Rs.150 per On/Off before 06:00 hrs and after 22:00 hrs to TOs)<br>(To be submitted in duplicate...)</div>

  <table class="meta">
    <tr><th>Name Of Train Operator</th><th>Emp. ID</th><th>Date of Confirmation</th><th>Month :-</th></tr>
    <tr><td id="empName"></td><td id="empId"></td><td id="confirmDate"></td><td id="monthDisplay"></td></tr>
  </table>

  <table class="duty">
    <thead>
      <tr>
        <th style="width:6%">S. No.</th><th style="width:16%">Date</th><th style="width:10%">Duty No.</th>
        <th style="width:14%">Train Set No.</th><th style="width:15%">Sign ON/OFF Time</th><th style="width:15%">Sign ON/OFF Place</th><th>Remark</th>
      </tr>
    </thead>
    <tbody id="iceBody"></tbody>
    <tfoot id="iceFooter"></tfoot>
  </table>

  <div class="cert-section">
    <div class="cert-title">Certificate</div>
    <p>I, certify that the Compensatory Incidental Contingent Expenditure (Conveyance Hire Charges), as claimed in this bill is correct & due to me, and this claim was not submitted earlier.</p>
    
    <div class="to-sig-row">
      <div class="to-sig-box">Signature of Train Operator</div>
    </div>
    
    <p style="margin-top:8px;">As per sign on and sign off duty record, the above detail submitted for the Incidental Contingent Expenditure (Conveyance Hire Charges) by the TO is certified & due to him/her.</p>
    <p style="font-weight:bold; margin-top:5px;">Total Incidental Contingent Expenditure payable to the TO is Rs. <span id="totalAmountCert" style="text-decoration:underline;"></span>/-</p>

    <div class="manager-row">
      <div class="sanction-block"><div style="font-weight:bold; margin-bottom:15px;">Sanctioned by:</div><div style="font-weight:bold;">General Manager/Operations<br>(Sign & Seal)</div></div>
      <div class="manager-to-block"><div style="padding-top:5px; font-weight:bold;">Signature of Manager (TO)</div></div>
    </div>
    <div class="footer-note">Forward to: GM(Finance) JMRC for making payment</div>
  </div>
</div>

<script>
// DUTY TABLE CONFIG - Including 26A explicitly
const DUTY_TABLE={
  "1":{signOn:"04:55",onPlace:"MSOR SCR",signOff:"11:55",offPlace:"MSOR SCR"},
  "2":{signOn:"04:55",onPlace:"BICP SCR",signOff:"12:25",offPlace:"MSOR SCR"},
  "3":{signOn:"04:55",onPlace:"MSOR SCR",signOff:"12:05",offPlace:"MSOR SCR"},
  "4":{signOn:"05:05",onPlace:"BICP SCR",signOff:"12:45",offPlace:"MSOR SCR"},
  "5":{signOn:"07:15",onPlace:"MSOR SCR",signOff:"14:35",offPlace:"MSOR SCR"},
  "6":{signOn:"05:00",onPlace:"DEPOT",signOff:"14:00",offPlace:"MSOR SCR"},
  "8":{signOn:"04:30",onPlace:"DEPOT",signOff:"12:15",offPlace:"MSOR SCR"},
  "9":{signOn:"04:50",onPlace:"DEPOT",signOff:"12:35",offPlace:"MSOR SCR"},
  "10":{signOn:"07:25",onPlace:"MSOR SCR",signOff:"14:55",offPlace:"MSOR SCR"},
  "11":{signOn:"07:35",onPlace:"MSOR SCR",signOff:"15:05",offPlace:"MSOR SCR"},
  "12":{signOn:"11:35",onPlace:"MSOR SCR",signOff:"18:45",offPlace:"MSOR SCR"},
  "15":{signOn:"11:45",onPlace:"MSOR SCR",signOff:"19:05",offPlace:"MSOR SCR"},
  "16":{signOn:"12:25",onPlace:"MSOR SCR",signOff:"20:35",offPlace:"MSOR SCR"},
  "17":{signOn:"12:55",onPlace:"MSOR SCR",signOff:"20:45",offPlace:"MSOR SCR"},
  "18":{signOn:"13:05",onPlace:"MSOR SCR",signOff:"20:55",offPlace:"MSOR SCR"},
  "19":{signOn:"14:35",onPlace:"MSOR SCR",signOff:"22:48",offPlace:"BICP SCR"},
  "20":{signOn:"14:45",onPlace:"MSOR SCR",signOff:"22:54",offPlace:"MSOR SCR"},
  "22":{signOn:"15:25",onPlace:"MSOR SCR",signOff:"23:10",offPlace:"DEPOT"},
  "23":{signOn:"15:05",onPlace:"MSOR SCR",signOff:"23:10",offPlace:"MSOR SCR"},
  "24":{signOn:"15:55",onPlace:"MSOR SCR",signOff:"23:05",offPlace:"BICP SCR"},
  "25":{signOn:"16:05",onPlace:"MSOR SCR",signOff:"23:20",offPlace:"DEPOT"},
  "26":{signOn:"14:00",onPlace:"MSOR SCR",signOff:"23:00",offPlace:"DEPOT"},
  "26A":{signOn:"16:00",onPlace:"MSOR SCR",signOff:"01:00",offPlace:"DEPOT"},
  "TO Night":{signOn:"22:00",onPlace:"MSOR SCR",signOff:"06:00",offPlace:"DEPOT"}
};

// HELPER: Parse "HH" from "HH:MM"
function parseTimeHour(t){ return (t && t.length===5) ? parseInt(t.substring(0,2),10) : -1; }

// LOGIC: Filter which duties are eligible for check
function isEligibleForICE(code){
  const s = String(code).toUpperCase();
  if(s === "26A") return true; 
  if(s === "TO NIGHT") return false; // Explicitly excluded from ICE
  const n = parseInt(s);
  // Numeric duties 1-26 are eligible
  return !isNaN(n) && n>=1 && n<=26;
}

// LOGIC: Check time (Before 06:00 OR After 22:00)
function checkTimeCondition(so, sf){
  const h1 = parseTimeHour(so);
  const h2 = parseTimeHour(sf);
  // SignOn < 6 OR SignOn >= 22 OR SignOff < 6 OR SignOff >= 22
  if( (h1!==-1 && (h1<6 || h1>=22)) || (h2!==-1 && (h2<6 || h2>=22)) ) return true;
  return false;
}

(function(){
  const raw = localStorage.getItem("dutyTrackerData");
  const data = raw ? JSON.parse(raw) : {};
  const records = data.records || {};
  const profile = data.profile || {};
  
  document.getElementById("empName").textContent = profile.name || "";
  document.getElementById("empId").textContent = profile.empId || "";
  document.getElementById("confirmDate").textContent = profile.confirmDate || "";

  const selectedMonth = localStorage.getItem("selectedPrintMonth");
  if(selectedMonth){
    const d = new Date(selectedMonth + "-01");
    document.getElementById("monthDisplay").textContent = d.toLocaleDateString("en-IN", { month:"long", year:"numeric" });
  }

  const tbody = document.getElementById("iceBody");
  const dates = Object.keys(records).filter(d => d.startsWith(selectedMonth)).sort();
  let count = 0;

  dates.forEach(date => {
    // Flatten Array
    const entries = Array.isArray(records[date]) ? records[date] : [records[date]];

    entries.forEach(r => {
        const dStr = String(r.duty);
        
        // 1. Check Eligibility (1-26, 26A)
        if(isEligibleForICE(dStr)){
            const info = DUTY_TABLE[dStr] || {};
            
            // Get Times (Prioritize table, fallback to record)
            const sOn = info.signOn || r.signOnTime || "";
            const sOff = info.signOff || r.signOffTime || "";
            const pOn = info.onPlace || r.signOnPlace || "DEPOT";
            const pOff = info.offPlace || r.signOffPlace || "DEPOT";

            // 2. Check Time Condition (Summary Basis)
            if(checkTimeCondition(sOn, sOff)){
                count++; 
                
                const row = document.createElement("tr");
                let placeStr = pOn;
                if(pOn !== pOff) placeStr += " / " + pOff;
                if(placeStr.includes("STATION")) placeStr = "STATION"; // Simplify for print

                row.innerHTML = `
                    <td>${count}</td>
                    <td>${new Date(date).toLocaleDateString("en-IN", {day:"numeric", month:"short", year:"numeric"})}</td>
                    <td>${dStr}</td>
                    <td>${(r.trains || []).join(", ")}</td>
                    <td>${sOn} / ${sOff}</td>
                    <td>${placeStr}</td>
                    <td>150</td>
                `;
                tbody.appendChild(row);
            }
        }
    });
  });

  const totalAmount = count * 150;
  document.getElementById("iceFooter").innerHTML = `<tr class="total-row"><td colspan="5" style="text-align:right;">Total Instances: ${count}</td><td colspan="2" style="text-align:left;">Total: Rs. ${totalAmount}/-</td></tr>`;
  document.getElementById("totalAmountCert").textContent = totalAmount;

  window.onload = () => setTimeout(()=>window.print(), 500);
})();
</script>
</body>
</html>
